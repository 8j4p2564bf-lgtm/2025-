
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>自由行-手冊</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'wood-bg': '#F7F5F0',       // 背景：溫潤米白
              'wood-card': '#FFFFFF',     // 卡片：純白
              'wood-border': '#E6E2DE',   // 邊框：淺灰
              'wood-accent': '#9C824A',   // 點綴：古銅金
              'wood-text': '#332F2C',     // 文字：深灰褐
              'wood-muted': '#85807C',    // 次要：中灰
            },
            fontFamily: {
              sans: ['Noto Sans TC', 'sans-serif'],
              serif: ['Playfair Display', 'serif'],
            },
            animation: {
              'fade-in': 'fadeIn 0.8s ease-out',
              'slide-up': 'slideUp 0.6s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(20px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              }
            }
          }
        }
      }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <style>
      body { font-family: 'Noto Sans TC', sans-serif; background-color: #F7F5F0; color: #332F2C; }
      
      /* Scrollbar Styling */
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #D1CEC7; border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9C824A; }
      
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      /* Loading Animation */
      .loading-spinner {
        border: 2px solid #E6E2DE;
        border-top: 2px solid #9C824A;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Map for Modules -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "@google/genai": "https://esm.sh/@google/genai",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
    <!-- Error Container -->
    <div id="error-container" style="display:none; padding: 20px; color: red; background: #fff; border: 1px solid red; margin: 20px;"></div>

    <div id="root">
        <!-- Initial Loading State -->
        <div class="flex flex-col items-center justify-center min-h-screen text-wood-muted">
            <div class="loading-spinner mb-4"></div>
            <p class="font-serif italic tracking-widest">Loading Premium Guide...</p>
        </div>
    </div>

    <!-- Error Handling Script -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const container = document.getElementById('error-container');
            if(container) {
                container.style.display = 'block';
                container.innerHTML = `<h3>應用程式發生錯誤</h3><p>${msg}</p><pre>${error?.stack || ''}</pre>`;
            }
            return false;
        };
    </script>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            CloudSun, Plane, Hotel, Coins, CheckCircle2, MapPin, X, 
            Utensils, Train, Camera, ShoppingBag, Home, Info, 
            MessageCircle, Send, Sparkles, Map, Loader2, Settings, Plus, Trash2, Save, RotateCcw
        } from 'lucide-react';
        import { GoogleGenAI } from "@google/genai";

        // ==========================================
        // ⚠️ 請在這裡貼上您的 Google Gemini API Key
        // ==========================================
        const API_KEY = "AIzaSyCpomsc_YHhgkmqjgHI4z5Q9yfC_9QoFzw"; 
        // ==========================================

        // --- 預設資料 (純文字版) ---
        const DEFAULT_DATA = {
            tripName: "京都・大阪",
            tripDate: "2024.10.16 — 10.20",
            apiKey: API_KEY, 
            flights: [
                { airline: '中華航空', flightNo: 'CI0152', date: '10/16 (四)', route: 'TPE -> KIX', dep: '09:00', arr: '12:50' },
                { airline: '中華航空', flightNo: 'CI0153', date: '10/20 (一)', route: 'KIX -> TPE', dep: '14:00', arr: '15:55' }
            ],
            preparation: [
                { title: "護照", desc: "檢查有效期限是否超過 6 個月。" },
                { title: "Visit Japan Web", desc: "提前填寫入境審查與海關申報，截圖 QR Code。" },
                { title: "日幣現金", desc: "建議攜帶約 ¥50,000 - ¥80,000 / 人 (視購物需求)。" },
                { title: "網卡 / Roaming", desc: "確認 SIM 卡或漫遊已開通。" },
                { title: "交通卡 (ICOCA/Suica)", desc: "加入 Apple Pay 或準備實體卡。" },
                { title: "充電設備", desc: "行動電源、充電線 (日本電壓 100V，插座與台灣相同)。" },
                { title: "常備藥品", desc: "感冒藥、腸胃藥、止痛藥、OK繃。" }
            ],
            itinerary: [
                {
                    id: 'day1', date: '10/16 (四)', title: '第一天：京都初印象',
                    items: [
                        { time: '05:30', title: '出發前往機場', location: '竹北 -> 桃機2航廈', type: 'transport', cost: '現金 1500', description: '準時出發，檢查護照、日幣、網卡。' },
                        { time: '09:00', title: '搭乘班機 CI0152', location: '桃園國際機場', type: 'flight', description: '飛往關西國際機場 (KIX)。' },
                        { time: '13:00', title: '抵達關西機場', location: 'KIX', type: 'transport', description: '辦理入境手續，領取行李。' },
                        { time: '14:00', title: '搭乘 Haruka 特急', location: '關西機場 -> 京都車站', type: 'transport', description: '使用 JR Pass 或預購票券，約 75 分鐘車程。' },
                        { time: '15:30', title: '飯店 Check-in', location: "Hotel The M’s Kyoto", type: 'hotel', mapQuery: "Hotel The M’s Kyoto", description: '時尚設計風格飯店，位於京都車站附近，交通便利。' },
                        { time: '16:10', title: '嵐山渡月橋、竹林小徑', location: '嵐山', type: 'activity', cost: '免費', mapQuery: 'Arashiyama Bamboo Grove', description: '京都必訪景點，感受竹林幽靜與渡月橋的開闊。' },
                        { time: '18:00', title: '嵐山月燈路', location: '嵐山', type: 'activity', description: '欣賞夜晚的燈光藝術（季節限定活動）。' },
                        { time: '19:30', title: '晚餐 / 休息', location: '京都車站周邊', type: 'food', description: '返回飯店附近享用晚餐。' }
                    ]
                },
                {
                    id: 'day2', date: '10/17 (五)', title: '第二天：古都風情',
                    items: [
                        { time: '08:30', title: '飯店出發', location: '前往五条坂', type: 'transport', description: '搭乘市巴士前往清水寺區域。' },
                        { time: '09:30', title: '清水寺 & 二三年坂', location: '清水寺', type: 'activity', cost: '門票 ¥500', mapQuery: 'Kiyomizu-dera', description: '世界遺產清水舞台，求姻緣的地主神社，漫步古色古香的坂道。' },
                        { time: '11:40', title: '八坂神社 & 花見小路', location: '八坂神社', type: 'activity', cost: '免費', mapQuery: 'Yasaka Shrine', description: '京都祇園的守護神社，接著漫步花見小路尋找藝妓身影。' },
                        { time: '13:25', title: '錦市場午餐', location: '錦市場', type: 'food', mapQuery: 'Nishiki Market', description: '「京都的廚房」，品嚐玉子燒、豆乳甜甜圈等小吃。' },
                        { time: '15:00', title: '四条河原町 / 平安神宮', location: '四条河原町', type: 'shopping', description: '自由逛街購物，或前往平安神宮參觀（本殿免費）。', mapQuery: 'Heian Shrine' },
                        { time: '18:30', title: '壽喜燒晚餐', location: '壽喜燒三條河原町店', type: 'food', description: '享受道地的關西壽喜燒。' },
                    ]
                },
                {
                    id: 'day3', date: '10/18 (六)', title: '第三天：移動至大阪',
                    items: [
                        { time: '08:30', title: '伏見稻荷大社', location: '伏見稻荷大社', type: 'activity', cost: '免費', mapQuery: 'Fushimi Inari Taisha', description: '壯觀的千本鳥居，狐狸使者的守護地。' },
                        { time: '11:00', title: '午餐 & 取行李', location: '京都', type: 'food' },
                        { time: '14:20', title: '搭 JR 新快速往大阪', location: '京都 -> 大阪', type: 'transport' },
                        { time: '15:30', title: '梅田 HEP FIVE 摩天輪', location: 'HEP FIVE', type: 'activity', description: '大阪地標紅色摩天輪（注意：行程表註記維修中，請確認現場狀況）。', mapQuery: 'HEP FIVE Ferris Wheel' },
                        { time: '17:00', title: '飯店 Check-in', location: 'The Bridge Hotel Shinsaibashi', type: 'hotel', mapQuery: 'The Bridge Hotel Shinsaibashi', description: '位於心齋橋中心，每晚提供免費拉麵宵夜與啤酒暢飲。' },
                        { time: '18:30', title: '道頓堀 & 心齋橋', location: '道頓堀', type: 'shopping', mapQuery: 'Dotonbori', description: '跑跑人看板打卡，藥妝店採購，章魚燒、拉麵吃到飽。' },
                    ]
                },
                {
                    id: 'day4', date: '10/19 (日)', title: '第四天：大阪深度遊',
                    items: [
                        { time: '08:30', title: '前往大阪城', location: '地鐵至大阪商務園區', type: 'transport' },
                        { time: '09:00', title: '大阪城 & 御座船', location: '大阪城天守閣', type: 'activity', description: '大阪象徵，豐臣秀吉的居城。', mapQuery: 'Osaka Castle' },
                        { time: '12:00', title: '大阪天滿宮', location: '大阪天滿宮', type: 'activity', cost: '免費', mapQuery: 'Osaka Tenmangu', description: '學問之神菅原道真，祈求學業進步。' },
                        { time: '12:30', title: '天神橋筋商店街', location: '天神橋筋', type: 'food', mapQuery: 'Tenjinbashi-suji Shopping Street', description: '日本最長的商店街，充滿庶民美食。' },
                        { time: '13:30', title: '大阪生活今昔館', location: '大阪生活今昔館', type: 'activity', description: '穿越時空回到江戶時代的大阪街道，可體驗和服。', mapQuery: 'Osaka Museum of Housing and Living' },
                        { time: '15:30', title: '黑門市場', location: '黑門市場', type: 'food', mapQuery: 'Kuromon Ichiba Market', description: '「大阪的廚房」，必吃海鮮、和牛串、水果大福。' },
                        { time: '20:00', title: '燒肉晚餐', location: '燒肉力丸難波道頓堀店', type: 'food', description: '日式燒肉吃到飽。' }
                    ]
                },
                {
                    id: 'day5', date: '10/20 (一)', title: '第五天：參拜與返台',
                    items: [
                        { time: '08:30', title: '前往大鳥大社', location: '天王寺 -> JR 鳳站', type: 'transport' },
                        { time: '09:20', title: '大鳥大社參拜', location: '大鳥大社', type: 'activity', cost: '免費', mapQuery: 'Otori Taisha', description: '和泉國一之宮，歷史悠久的神社。' },
                        { time: '10:00', title: '前往關西機場', location: '鳳站 -> KIX', type: 'transport', description: '搭乘 JR 或南海電鐵前往機場。' },
                        { time: '11:00', title: '機場報到', location: 'KIX 第一航廈', type: 'flight', description: '辦理登機、託運、最後免稅品採購。' },
                        { time: '14:00', title: '搭乘班機 CI0153', location: 'KIX -> TPE', type: 'flight', description: '帶著滿滿的回憶飛往溫暖的家。' },
                    ]
                }
            ]
        };

        // --- 服務與邏輯 ---
        const getAiService = (key) => key ? new GoogleGenAI({ apiKey: key }) : null;
        const descriptionCache = {};

        const getPlaceDescription = async (ai, placeName, location) => {
            if (!ai) return "AI 服務未啟用，請在編輯模式輸入 API Key。";
            const cacheKey = `${placeName}-${location}`;
            if (descriptionCache[cacheKey]) return descriptionCache[cacheKey];
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: `請用繁體中文(台灣)為遊客介紹「${location} ${placeName}」，80字以內，強調獨特氛圍。`,
                });
                const text = response.text || "暫無介紹。";
                descriptionCache[cacheKey] = text;
                return text;
            } catch (error) { return "無法連線至 AI 服務。"; }
        };

        const getTravelAssistantResponse = async (ai, userMessage, context) => {
            if (!ai) return "請先輸入 API Key 以啟用 AI 助理。";
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: userMessage,
                    config: { systemInstruction: `You are a helpful travel guide. Context: ${context}. Respond in Traditional Chinese.` }
                });
                return response.text;
            } catch (e) { return "連線錯誤，請檢查 API Key 或網路。"; }
        };

        // --- UI 元件 ---

        // 1. 通用 Modal
        const Modal = ({ children, onClose, title }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-wood-text/20 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                <div className="bg-wood-card border border-wood-border w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] animate-slide-up relative shadow-2xl rounded-sm" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center p-5 border-b border-wood-border bg-wood-bg/30">
                        <h3 className="text-wood-accent font-serif italic text-xl font-bold">{title}</h3>
                        <button onClick={onClose}><X className="text-wood-muted hover:text-wood-text" size={24}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar bg-wood-card">
                        {children}
                    </div>
                </div>
            </div>
        );

        // 2. 景點詳情 Modal (純文字版)
        const AttractionModal = ({ item, apiKey, onClose }) => {
            const [aiDesc, setAiDesc] = useState(null);
            const [loading, setLoading] = useState(false);
            
            useEffect(() => {
                const fetchDesc = async () => {
                    if ((item.mapQuery || item.title) && apiKey) {
                        setLoading(true);
                        const ai = getAiService(apiKey);
                        const desc = await getPlaceDescription(ai, item.title, item.location);
                        setAiDesc(desc);
                        setLoading(false);
                    }
                };
                fetchDesc();
            }, [item, apiKey]);

            const mapLink = item.mapQuery 
                ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapQuery)}` 
                : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location + ' ' + item.title)}`;
            
            return (
                <Modal onClose={onClose} title="景點詳情">
                    <div className="p-8">
                        <div className="mb-8 text-center border-b border-wood-border pb-6">
                            <span className="text-[10px] tracking-[0.3em] text-wood-accent uppercase font-bold block mb-2">DESTINATION</span>
                            <h3 className="text-3xl font-serif italic text-wood-text tracking-wide mb-3">{item.title}</h3>
                            <p className="text-wood-muted text-xs tracking-[0.2em] uppercase flex items-center justify-center font-medium">
                                <MapPin size={12} className="mr-2 text-wood-accent"/>{item.location}
                            </p>
                        </div>

                        <div className="space-y-8">
                            <div>
                                <h4 className="text-xs font-bold text-wood-text uppercase tracking-widest mb-3">關於這裡</h4>
                                <p className="text-wood-text text-sm leading-loose font-light tracking-wide text-justify">
                                    {item.description || '暫無說明'}
                                </p>
                            </div>
                            
                            {item.cost && (
                               <div className="text-center">
                                   <div className="inline-block text-xs text-wood-accent border border-wood-accent/30 px-6 py-2 tracking-widest uppercase">
                                       費用：{item.cost}
                                   </div>
                               </div>
                            )}

                            <div className="bg-wood-bg border border-wood-border p-6 relative rounded-sm">
                                <div className="flex gap-2 text-wood-accent mb-3 items-center">
                                    <Sparkles size={16}/> <span className="text-xs font-serif italic font-bold tracking-wider">AI 導覽</span>
                                </div>
                                {loading ? (
                                    <div className="flex items-center gap-2 text-xs text-wood-muted py-2">
                                        <Loader2 className="animate-spin" size={14}/> 正在撰寫介紹...
                                    </div>
                                ) : (
                                    <p className="text-xs text-wood-text/80 leading-relaxed font-light">
                                        {aiDesc || (apiKey ? '無法取得資訊' : '請設定 API Key 以解鎖 AI 介紹')}
                                    </p>
                                )}
                            </div>

                            <a href={mapLink} target="_blank" className="block w-full text-center bg-wood-text text-white py-4 text-xs tracking-[0.25em] hover:bg-wood-accent uppercase font-medium transition-colors shadow-md">
                                <div className="flex items-center justify-center gap-2">
                                    <Map size={14}/> 開啟 Google 地圖
                                </div>
                            </a>
                        </div>
                    </div>
                </Modal>
            );
        };

        // 3. 資訊頁籤
        const InfoTab = ({ data, openModal }) => {
            const [yen, setYen] = useState('');
            const twd = yen ? Math.round(parseFloat(yen) * 0.215) : 0;
            return (
                <div className="space-y-8 animate-fade-in pb-12">
                    <div className="text-center pt-6 pb-2">
                        <div className="inline-block border-y border-wood-accent/30 py-1 mb-3 px-6"><span className="text-[10px] tracking-[0.3em] text-wood-accent uppercase font-bold">行程總覽</span></div>
                        <h2 className="text-4xl font-serif italic text-wood-text tracking-tight">{data.tripName}</h2>
                        <p className="text-xs text-wood-muted tracking-[0.2em] mt-3 font-medium">{data.tripDate}</p>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4">
                        {['hotel', 'prep'].map(type => (
                            <button key={type} onClick={() => openModal(type)} className="bg-white border border-wood-border p-5 hover:border-wood-accent hover:shadow-md transition-all group relative overflow-hidden text-left rounded-sm">
                                {type === 'hotel' ? <Hotel size={24} className="text-wood-accent mb-3"/> : <CheckCircle2 size={24} className="text-wood-accent mb-3"/>}
                                <span className="block text-sm font-bold tracking-widest text-wood-text mb-1">{type === 'hotel' ? '住宿資訊' : '行前準備'}</span>
                                <span className="text-[10px] text-wood-muted">點擊查看詳情</span>
                            </button>
                        ))}
                    </div>

                    <div className="bg-white border border-wood-border p-8 shadow-sm rounded-sm relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-1 h-full bg-wood-accent"></div>
                        <div className="flex items-center gap-2 mb-6 text-wood-accent"><Coins size={18}/><h3 className="font-serif italic text-lg text-wood-text">匯率換算</h3></div>
                        <div className="flex items-center gap-6">
                            <div className="flex-1">
                                <label className="block text-[10px] text-wood-muted text-center mb-2 tracking-widest">JPY 日圓</label>
                                <input type="number" value={yen} onChange={e=>setYen(e.target.value)} placeholder="0" className="w-full bg-wood-bg border border-wood-border p-3 text-center text-xl text-wood-text focus:border-wood-accent outline-none font-light rounded-sm transition-colors"/>
                            </div>
                            <span className="text-wood-accent font-serif italic text-xl pt-6">兌</span>
                            <div className="flex-1">
                                <label className="block text-[10px] text-wood-muted text-center mb-2 tracking-widest">TWD 台幣</label>
                                <div className="w-full bg-wood-bg/50 border-b border-wood-accent/30 p-3 text-center text-xl text-wood-text font-medium">${twd.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <div className="flex items-center gap-2 px-1 text-wood-accent"><Plane size={18}/><h3 className="font-serif italic text-wood-text text-lg">航班資訊</h3></div>
                        {data.flights.map((f, i) => (
                            <div key={i} className="bg-white border border-wood-border p-6 flex justify-between items-center shadow-sm hover:shadow-md transition-shadow rounded-sm relative">
                                <div>
                                    <div className="text-xs text-wood-accent font-bold tracking-widest uppercase mb-1">{f.airline}</div>
                                    <div className="text-lg font-serif text-wood-text">{f.flightNo}</div>
                                    <div className="text-[10px] text-wood-muted mt-1 font-mono">{f.route}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-2xl font-serif text-wood-text">{f.dep}</div>
                                    <div className="text-[10px] text-wood-muted mt-1 uppercase tracking-widest">出發</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 4. 每日行程頁籤
        const DayView = ({ day, onSelect }) => {
            const getIcon = (t) => {
                if(t==='food') return <Utensils size={14}/>;
                if(t==='transport') return <Train size={14}/>;
                if(t==='hotel') return <Home size={14}/>;
                if(t==='shopping') return <ShoppingBag size={14}/>;
                return <MapPin size={14}/>;
            }
            return (
                <div className="pb-24 animate-fade-in">
                    <div className="sticky top-0 z-20 py-6 bg-[#F7F5F0]/95 backdrop-blur-md border-b border-wood-border mb-8 -mx-6 px-6 shadow-sm">
                        <span className="text-[10px] font-mono text-wood-accent block mb-2 tracking-[0.2em] uppercase font-bold">{day.date}</span>
                        <h2 className="text-2xl font-serif italic text-wood-text tracking-wide">{day.title}</h2>
                    </div>
                    <div className="relative pl-2 space-y-8">
                        <div className="absolute left-[19px] top-2 bottom-0 w-[1px] bg-wood-border"></div>
                        {day.items.map((item, idx) => (
                            <div key={idx} className="relative flex gap-5 group">
                                <div className="relative z-10 w-10 h-10 bg-white border border-wood-border flex items-center justify-center text-wood-muted group-hover:border-wood-accent group-hover:text-wood-accent group-hover:shadow-md transition-all rotate-45 shrink-0 rounded-sm">
                                    <div className="-rotate-45">{getIcon(item.type)}</div>
                                </div>
                                <div onClick={() => onSelect(item)} className="flex-1 bg-white border border-wood-border p-5 relative transition-all cursor-pointer hover:border-wood-accent hover:shadow-md rounded-sm group-hover:-translate-y-0.5">
                                    <div className="flex justify-between items-baseline mb-2">
                                        <span className="font-mono text-xs text-wood-accent font-bold tracking-widest">{item.time}</span>
                                        {item.cost && <span className="text-[10px] text-wood-muted border border-wood-border px-2 py-0.5 rounded-full">{item.cost}</span>}
                                    </div>
                                    <h3 className="font-medium text-lg text-wood-text mb-2 tracking-wide">{item.title}</h3>
                                    <div className="flex items-center text-wood-muted text-xs mb-3 font-light"><MapPin size={11} className="mr-1"/>{item.location}</div>
                                    {item.description && <p className="text-xs text-wood-text/70 font-light border-t border-wood-border pt-3 leading-relaxed line-clamp-2">{item.description}</p>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 5. 編輯模式表單
        const EditForm = ({ data, onSave, onCancel }) => {
            const [formData, setFormData] = useState(data);
            
            const updateField = (field, val) => setFormData({...formData, [field]: val});
            const handleFlightChange = (idx, field, val) => { const newF = [...formData.flights]; newF[idx][field] = val; setFormData({...formData, flights: newF}); }
            const addFlight = () => setFormData({...formData, flights: [...formData.flights, { airline: '', flightNo: '', date: '', route: '', dep: '', arr: '' }]});
            const removeFlight = (idx) => setFormData({...formData, flights: formData.flights.filter((_, i) => i !== idx)});
            const handlePrepChange = (idx, field, val) => { const newP = [...formData.preparation]; newP[idx][field] = val; setFormData({...formData, preparation: newP}); }
            const addPrep = () => setFormData({...formData, preparation: [...formData.preparation, { title: '', desc: '' }]});
            const removePrep = (idx) => setFormData({...formData, preparation: formData.preparation.filter((_, i) => i !== idx)});
            const handleItineraryChange = (dayIdx, field, val) => { const newI = [...formData.itinerary]; newI[dayIdx][field] = val; setFormData({...formData, itinerary: newI}); }
            const addItem = (dayIdx) => { const newI = [...formData.itinerary]; newI[dayIdx].items.push({ time: '00:00', title: '新行程', location: '', type: 'activity', description: '' }); setFormData({...formData, itinerary: newI}); }
            const updateItem = (dayIdx, itemIdx, field, val) => { const newI = [...formData.itinerary]; newI[dayIdx].items[itemIdx][field] = val; setFormData({...formData, itinerary: newI}); }
            const removeItem = (dayIdx, itemIdx) => { const newI = [...formData.itinerary]; newI[dayIdx].items = newI[dayIdx].items.filter((_, i) => i !== itemIdx); setFormData({...formData, itinerary: newI}); }
            const addDay = () => { const id = `day${formData.itinerary.length + 1}`; setFormData({...formData, itinerary: [...formData.itinerary, { id, date: '日期', title: '新的一天', items: [] }]}); }
            const removeDay = (idx) => { if(!confirm("確定刪除這一天？")) return; setFormData({...formData, itinerary: formData.itinerary.filter((_, i) => i !== idx)}); }
            const handleReset = () => { if(confirm("確定重置回預設範本？")) setFormData(DEFAULT_DATA); }

            return (
                <div className="bg-wood-bg min-h-screen text-wood-text p-4 pb-24 overflow-y-auto font-sans">
                    <div className="sticky top-0 bg-wood-bg/95 backdrop-blur z-20 pb-4 border-b border-wood-border mb-6 flex justify-between items-center pt-2">
                        <h2 className="text-xl font-serif italic text-wood-accent font-bold">行程編輯器</h2>
                        <div className="flex gap-2">
                            <button onClick={handleReset} className="px-3 py-1 text-xs border border-wood-muted text-wood-muted rounded hover:bg-white transition-colors"><RotateCcw size={14}/></button>
                            <button onClick={onCancel} className="px-3 py-1 text-xs border border-wood-muted text-wood-muted rounded hover:bg-white transition-colors">取消</button>
                            <button onClick={() => onSave(formData)} className="px-3 py-1 text-xs bg-wood-accent text-white font-bold rounded flex items-center gap-1 hover:opacity-90 transition-opacity shadow-md"><Save size={14}/> 儲存</button>
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded-sm border border-wood-border mb-6 shadow-sm">
                        <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest border-b border-wood-border pb-2 mb-4">API 設定</h3>
                        <div>
                            <label className="block text-xs text-wood-muted mb-1 font-bold">Google Gemini API Key</label>
                            <input type="text" value={formData.apiKey} onChange={e=>updateField('apiKey', e.target.value)} placeholder="AIzaSy..." className="w-full bg-wood-bg border border-wood-border p-2 text-sm text-wood-text focus:border-wood-accent outline-none rounded-sm"/>
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded-sm border border-wood-border mb-6 shadow-sm">
                        <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest border-b border-wood-border pb-2 mb-4">基本資訊</h3>
                        <div className="grid gap-4">
                            <div><label className="block text-xs text-wood-muted mb-1">標題</label><input type="text" value={formData.tripName} onChange={e=>updateField('tripName', e.target.value)} className="w-full bg-wood-bg border border-wood-border p-2 rounded-sm"/></div>
                            <div><label className="block text-xs text-wood-muted mb-1">日期</label><input type="text" value={formData.tripDate} onChange={e=>updateField('tripDate', e.target.value)} className="w-full bg-wood-bg border border-wood-border p-2 rounded-sm"/></div>
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded-sm border border-wood-border mb-6 shadow-sm">
                        <div className="flex justify-between items-center border-b border-wood-border pb-2 mb-4">
                            <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest">航班</h3>
                            <button onClick={addFlight} className="text-wood-accent"><Plus size={16}/></button>
                        </div>
                        {formData.flights.map((f, i) => (
                            <div key={i} className="bg-wood-bg p-3 border border-wood-border relative mb-3 rounded-sm">
                                <button onClick={()=>removeFlight(i)} className="absolute top-2 right-2 text-wood-muted hover:text-red-400"><Trash2 size={14}/></button>
                                <div className="grid grid-cols-2 gap-2 mb-2">
                                    <input value={f.airline} onChange={e=>handleFlightChange(i,'airline',e.target.value)} placeholder="航空" className="bg-white p-2 text-xs border border-wood-border rounded-sm"/>
                                    <input value={f.flightNo} onChange={e=>handleFlightChange(i,'flightNo',e.target.value)} placeholder="班號" className="bg-white p-2 text-xs border border-wood-border rounded-sm"/>
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                    <input value={f.dep} onChange={e=>handleFlightChange(i,'dep',e.target.value)} placeholder="出發" className="bg-white p-2 text-xs border border-wood-border rounded-sm"/>
                                    <input value={f.arr} onChange={e=>handleFlightChange(i,'arr',e.target.value)} placeholder="抵達" className="bg-white p-2 text-xs border border-wood-border rounded-sm"/>
                                    <input value={f.date} onChange={e=>handleFlightChange(i,'date',e.target.value)} placeholder="日期" className="bg-white p-2 text-xs border border-wood-border rounded-sm"/>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="space-y-6">
                        <div className="flex justify-between items-center px-1">
                            <h3 className="text-wood-accent text-sm font-bold uppercase tracking-widest">每日行程</h3>
                            <button onClick={addDay} className="text-wood-accent hover:text-wood-text flex items-center text-xs gap-1 font-bold bg-white px-3 py-1 border border-wood-accent rounded-full transition-colors"><Plus size={14}/> 新增天數</button>
                        </div>
                        {formData.itinerary.map((day, dIdx) => (
                            <div key={dIdx} className="border border-wood-border bg-white p-5 rounded-sm shadow-sm relative">
                                <div className="absolute top-0 left-0 w-1 h-full bg-wood-border"></div>
                                <div className="flex justify-between items-start mb-4 pl-3">
                                    <div className="flex-1 space-y-2">
                                        <input value={day.date} onChange={e=>handleItineraryChange(dIdx,'date',e.target.value)} className="bg-wood-bg p-2 text-xs text-wood-accent font-bold border border-wood-border w-full rounded-sm"/>
                                        <input value={day.title} onChange={e=>handleItineraryChange(dIdx,'title',e.target.value)} className="bg-wood-bg p-2 text-sm font-bold text-wood-text border border-wood-border w-full rounded-sm font-serif"/>
                                    </div>
                                    <button onClick={()=>removeDay(dIdx)} className="ml-2 text-wood-muted hover:text-red-400 bg-wood-bg p-2 rounded-full"><Trash2 size={16}/></button>
                                </div>
                                <div className="space-y-3 pl-3">
                                    {day.items.map((item, iIdx) => (
                                        <div key={iIdx} className="bg-wood-bg p-4 border border-wood-border text-xs space-y-2 relative group rounded-sm hover:border-wood-accent transition-colors">
                                            <button onClick={()=>removeItem(dIdx, iIdx)} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-wood-muted hover:text-red-400 transition-opacity"><Trash2 size={12}/></button>
                                            <div className="flex gap-2">
                                                <input value={item.time} onChange={e=>updateItem(dIdx, iIdx, 'time', e.target.value)} className="w-16 bg-white p-2 border border-wood-border rounded-sm text-center font-mono" placeholder="時間"/>
                                                <select value={item.type} onChange={e=>updateItem(dIdx, iIdx, 'type', e.target.value)} className="bg-white p-2 border border-wood-border rounded-sm">
                                                    <option value="activity">景點</option><option value="food">餐廳</option><option value="transport">交通</option><option value="hotel">住宿</option><option value="shopping">購物</option>
                                                </select>
                                                <input value={item.title} onChange={e=>updateItem(dIdx, iIdx, 'title', e.target.value)} className="flex-1 bg-white p-2 border border-wood-border rounded-sm font-bold" placeholder="標題"/>
                                            </div>
                                            <input value={item.location} onChange={e=>updateItem(dIdx, iIdx, 'location', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm" placeholder="地點"/>
                                            <textarea value={item.description} onChange={e=>updateItem(dIdx, iIdx, 'description', e.target.value)} className="w-full bg-white p-2 border border-wood-border h-16 rounded-sm" placeholder="描述"/>
                                            <input value={item.mapQuery||''} onChange={e=>updateItem(dIdx, iIdx, 'mapQuery', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm" placeholder="Google Maps 關鍵字 (留空則自動搜尋)"/>
                                        </div>
                                    ))}
                                    <button onClick={()=>addItem(dIdx)} className="w-full py-3 border border-dashed border-wood-muted text-wood-muted hover:text-wood-accent hover:border-wood-accent text-xs rounded-sm transition-colors">+ 新增行程</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 主程式 App ---
        const App = () => {
            const [data, setData] = useState(() => {
                try {
                    const saved = localStorage.getItem('tripData_v2');
                    return saved ? JSON.parse(saved) : DEFAULT_DATA;
                } catch(e) { return DEFAULT_DATA; }
            });
            const [isEdit, setIsEdit] = useState(false);
            const [activeTab, setActiveTab] = useState('info');
            const [selectedItem, setSelectedItem] = useState(null);
            const [modalType, setModalType] = useState(null);
            const [showChat, setShowChat] = useState(false);
            const [chatHist, setChatHist] = useState([]);
            const [msg, setMsg] = useState('');
            const [loading, setLoading] = useState(false);

            const saveData = (newData) => {
                setData(newData);
                localStorage.setItem('tripData_v2', JSON.stringify(newData));
                setIsEdit(false);
            };

            const handleSend = async (e) => {
                e.preventDefault();
                if(!msg.trim()) return;
                const userMsg = msg;
                setMsg('');
                setChatHist(p => [...p, {role: 'user', text: userMsg}]);
                setLoading(true);
                
                const ai = getAiService(data.apiKey);
                const res = await getTravelAssistantResponse(ai, userMsg, JSON.stringify(data.itinerary));
                setChatHist(p => [...p, {role: 'model', text: res}]);
                setLoading(false);
            };

            if(isEdit) return <EditForm data={data} onSave={saveData} onCancel={()=>setIsEdit(false)} />;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-wood-bg shadow-2xl relative border-x border-wood-border font-sans flex flex-col">
                    {/* Header */}
                    <header className="bg-wood-bg/95 backdrop-blur-md sticky top-0 z-30 pt-8 border-b border-wood-border">
                        <div className="flex justify-between items-start px-6 mb-4">
                            <div>
                                <p className="text-[10px] text-wood-accent tracking-[0.25em] uppercase mb-1 font-bold">Premium Guide</p>
                                <h1 className="text-3xl font-serif italic text-wood-text tracking-wide">{data.tripName}</h1>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setIsEdit(true)} className="p-2 rounded-full border border-wood-border text-wood-muted hover:text-wood-accent hover:bg-white hover:shadow-sm transition-all"><Settings size={18}/></button>
                                <button onClick={()=>setShowChat(!showChat)} className="p-2 rounded-full border border-wood-border text-wood-muted hover:text-wood-accent hover:bg-white hover:shadow-sm transition-all"><MessageCircle size={18}/></button>
                            </div>
                        </div>
                        <div className="flex overflow-x-auto no-scrollbar px-6 gap-8">
                            <button onClick={()=>setActiveTab('info')} className={`pb-3 text-xs tracking-widest whitespace-nowrap uppercase font-medium border-b-2 transition-all ${activeTab==='info'?'text-wood-accent border-wood-accent':'text-wood-muted border-transparent hover:text-wood-text'}`}>資訊</button>
                            {data.itinerary.map(day => (
                                <button key={day.id} onClick={()=>setActiveTab(day.id)} className={`pb-3 text-xs tracking-widest whitespace-nowrap uppercase font-medium border-b-2 transition-all font-serif ${activeTab===day.id?'text-wood-accent border-wood-accent':'text-wood-muted border-transparent hover:text-wood-text'}`}>{day.date.split(' ')[0]}</button>
                            ))}
                        </div>
                    </header>

                    <main className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                        {activeTab === 'info' && <InfoTab data={data} openModal={setModalType} />}
                        {data.itinerary.map(day => activeTab === day.id && <DayView key={day.id} day={day} onSelect={setSelectedItem} />)}
                    </main>

                    {/* Chat Overlay */}
                    {showChat && (
                        <div className="absolute inset-0 z-40 bg-wood-bg/95 backdrop-blur-xl flex flex-col animate-slide-up">
                            <div className="flex justify-between p-5 border-b border-wood-border bg-white/50">
                                <h3 className="text-wood-accent font-serif italic font-bold text-lg">AI 專屬管家</h3>
                                <button onClick={()=>setShowChat(false)}><X className="text-wood-muted hover:text-wood-text" size={24}/></button>
                            </div>
                            <div className="flex-1 p-6 overflow-y-auto space-y-4">
                                {chatHist.length===0 && <div className="text-center mt-20 text-wood-muted opacity-50"><MessageCircle size={40} className="mx-auto mb-4 text-wood-border"/>{data.apiKey ? '請問有什麼需要幫忙？' : '請先至設定頁輸入 API Key'}</div>}
                                {chatHist.map((m,i)=>(<div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`max-w-[85%] p-4 text-sm rounded-sm leading-relaxed shadow-sm ${m.role==='user'?'bg-wood-accent text-white':'bg-white border border-wood-border text-wood-text'}`}>{m.text}</div></div>))}
                                {loading && <div className="text-wood-accent text-xs animate-pulse pl-2">思考中...</div>}
                            </div>
                            <form onSubmit={handleSend} className="p-4 border-t border-wood-border flex gap-3 bg-white">
                                <input value={msg} onChange={e=>setMsg(e.target.value)} className="flex-1 bg-wood-bg border border-wood-border p-3 text-sm text-wood-text focus:border-wood-accent outline-none rounded-sm transition-colors" placeholder="輸入訊息..."/>
                                <button type="submit" disabled={!data.apiKey} className="bg-wood-accent text-white px-5 py-2 disabled:opacity-50 hover:opacity-90 transition-opacity rounded-sm shadow-sm"><Send size={18}/></button>
                            </form>
                        </div>
                    )}

                    {/* Modals */}
                    {selectedItem && <AttractionModal item={selectedItem} apiKey={data.apiKey} onClose={()=>setSelectedItem(null)} />}
                    {modalType && (
                        <Modal onClose={()=>setModalType(null)} title={modalType==='hotel'?'住宿列表':'準備清單'}>
                            <div className="p-8 space-y-6">
                                {modalType==='hotel' 
                                    ? data.itinerary.flatMap(d=>d.items).filter(i=>i.type==='hotel').map((h,i)=>(<div key={i} className="border-l-2 border-wood-accent pl-5 py-1"><h4 className="text-wood-text font-bold text-lg">{h.title}</h4><p className="text-xs text-wood-muted mb-3 font-medium tracking-wide uppercase mt-1 flex items-center gap-1"><MapPin size={10}/>{h.location}</p><p className="text-sm text-wood-text/70 font-light leading-relaxed">{h.description}</p></div>))
                                    : data.preparation.map((p,i)=>(<div key={i} className="flex gap-4 p-4 bg-white border border-wood-border rounded-sm shadow-sm"><div className="mt-1 w-2 h-2 bg-wood-accent shrink-0 rotate-45"></div><div><h4 className="text-wood-text text-sm font-bold mb-1">{p.title}</h4><p className="text-xs text-wood-muted font-light leading-relaxed">{p.desc}</p></div></div>))
                                }
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
