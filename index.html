<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>æ—¥æœ¬é—œè¥¿äº”æ—¥éŠè¡Œç¨‹èˆ‡è¨˜å¸³</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <style>
       @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
       body {
           font-family: 'Inter', sans-serif;
           background-color: #1a1a2e; /* Dark theme background */
           color: #ffffff; /* Light text */
           margin: 0;
           padding: 0;
           min-height: 100vh;
       }
       .app-container {
           max-width: 768px;
           margin: 0 auto;
           padding: 0;
           display: flex;
           flex-direction: column;
           min-height: 100vh;
       }
       /* ä¸»å°èˆªæŒ‰éˆ•æ¨£å¼ */
       .main-nav-button {
           transition: all 0.3s ease;
           cursor: pointer;
           border-bottom: 3px solid transparent;
           font-weight: 600;
       }
       .main-nav-button.active {
           border-bottom-color: #ffb703; /* Accent color for active tab */
           color: #ffb703;
       }
       .main-nav-button:hover:not(.active) {
           color: #ffb703;
           opacity: 0.8;
       }
       
       /* æ¬¡ç´šå°èˆª (Day tabs) æ¨£å¼ */
       .day-nav-button {
           transition: all 0.2s ease;
           padding: 8px 10px;
           font-weight: 500;
           border-radius: 8px;
           color: #ccc;
           background-color: transparent;
           flex-shrink: 0; /* Prevent shrinking */
       }
       .day-nav-button.active {
           background-color: #ffb703;
           color: #1a1a2e;
           font-weight: 700;
           box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
       }
       .day-nav-button:hover:not(.active) {
           background-color: #3a3a5a;
       }

       .card {
           background-color: #272744; /* Darker card background */
           border-radius: 12px;
           box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
           padding: 16px;
           margin-bottom: 12px;
           transition: transform 0.2s, box-shadow 0.2s;
           border: 1px solid #3a3a5a;
       }
       .detail-item {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 8px 0;
           border-bottom: 1px dashed #3a3a5a;
       }
       .detail-item:last-child {
           border-bottom: none;
       }
       .weather-card {
           flex-shrink: 0;
           width: 140px;
           background-color: #3a3a5a;
           border: none;
           text-align: center;
           padding: 10px 5px;
           margin-right: 8px;
       }
       .weather-icon {
           font-size: 2.5rem;
           line-height: 1;
       }
       .weather-temp {
           font-size: 1.1rem;
           font-weight: 700;
           color: #8aff8a;
       }
       
       /* è¨˜å¸³é é¢æ¨£å¼ */
       .expense-list-item {
           display: flex;
           justify-content: space-between;
           padding: 10px 0;
           border-bottom: 1px dotted #4a4a70;
           align-items: center;
       }
       .expense-list-item:last-child {
           border-bottom: none;
       }
       .input-field {
           background-color: #1a1a2e;
           border: 1px solid #3a3a5a;
           color: #fff;
           padding: 8px;
           border-radius: 8px;
           width: 100%;
           box-sizing: border-box;
       }
   </style>
</head>
<body>
   <div id="app" class="app-container p-4">
       <!-- App content will be rendered here -->
   </div>

   <script type="module">
       // ====================================================================
       // Firebase æ¨¡çµ„è¼‰å…¥
       // ====================================================================
       import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
       import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // è¨­å®š Firebase å…¨åŸŸè®Šæ•¸
       const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
       const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
       const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
       
       // ====================================================================
       // è¡Œç¨‹è³‡æ–™ (å·²æ›´æ–°ç‚ºç”¨æˆ¶æä¾›çš„è©³ç´°è¡Œç¨‹)
       // ====================================================================

       const itineraryData = [
           {
               day: 1,
               date: '10/16 (å››)',
               city: 'äº¬éƒ½ (Kyoto)',
               theme: 'æŠµé”èˆ‡åµå±±æœˆç‡ˆè·¯',
               activities: [
                   { time: '05:30', description: 'ç«¹åŒ— >> æ¡ƒåœ’æ©Ÿå ´ (äºŒèˆªå»ˆ) (è»Šè³‡Â¥1500)' },
                   { time: '09:00', description: 'æ¡ƒåœ’æ©Ÿå ´å‡ºç™¼ âœˆï¸ (ä¸­è¯èˆªç©º CI0152)' },
                   { time: '13:00', description: 'æŠµé”é—œè¥¿æ©Ÿå ´ (KIX)' },
                   { time: '14:00', description: 'æ­ä¹˜ JR Haruka ç‰¹æ€¥ â†’ äº¬éƒ½è»Šç«™ ğŸš…' },
                   { time: '15:30', description: 'å…¥ä½ Hotel The Mâ€™s Kyoto ğŸ¨' },
                   { time: '16:10', description: 'åµå±±æ¸¡æœˆæ©‹ã€ç«¹æ—å°å¾‘ ğŸƒ' },
                   { time: '18:00', description: 'åƒåŠ åµå±±æœˆç‡ˆè·¯æ´»å‹• ğŸŒ™' },
                   { time: '19:30', description: 'æ™šé¤æˆ–å›é£¯åº—ä¼‘æ¯ ğŸ½ï¸' }
               ]
           },
           {
               day: 2,
               date: '10/17 (äº”)',
               city: 'äº¬éƒ½ (Kyoto)',
               theme: 'å¤éƒ½é¢¨æƒ…ï¼šæ¸…æ°´å¯ºï¼‹å¸‚å ´ç¾é£Ÿ',
               activities: [
                   { time: '08:30', description: 'å¸‚å·´å£«è‡³äº”æ¡å‚ ğŸšŒ' },
                   { time: '09:30', description: 'æ¸…æ°´å¯ºåƒè§€ (é–€ç¥¨Â¥500) + æ•£æ­¥ä¸‰å¹´å‚ï¼äºŒå¹´å‚ ğŸ¯' },
                   { time: '11:40', description: 'å…«å‚ç¥ç¤¾ï¼†èŠ±è¦‹å°è·¯èµ°èµ° â›©ï¸' },
                   { time: '13:25', description: 'éŒ¦å¸‚å ´åˆé¤ï¼‹é€›è¡— ğŸ›ï¸' },
                   { time: '15:00', description: 'å››æ¡æ²³åŸç”ºè‡ªç”±æ´»å‹• / å¹³å®‰ç¥å®®æœ¬æ®¿å€åŸŸ' },
                   { time: '18:30', description: 'æ™šé¤ï¼šå£½å–œç‡’ä¸‰æ¢æ²³åŸç”ºåº— ğŸ½ï¸' },
                   { time: 'å‚æ™š', description: 'å›é£¯åº—ä¼‘æ¯ ğŸŒ™' }
               ]
           },
           {
               day: 3,
               date: '10/18 (å…­)',
               city: 'äº¬éƒ½ â†’ å¤§é˜ª',
               theme: 'ä¼è¦‹ç¨»è·ï¼‹å¤§é˜ªæ‘©å¤©è¼ªï¼‹å…¥ä½',
               activities: [
                   { time: '08:30', description: 'å‡ºç™¼ â†’ ä¼è¦‹ç¨»è·å¤§ç¤¾åƒæ‹œï¼ˆåƒæœ¬é³¥å±…ï¼‰ â›©ï¸' },
                   { time: '11:00', description: 'åˆé¤ â†’ å›é£¯åº—å–è¡Œæ' },
                   { time: '14:20', description: 'æ­ä¹˜ JR æ–°å¿«é€Ÿ â†’ å¤§é˜ªæ¢…ç”° ğŸš…' },
                   { time: '15:30', description: 'æŠµé”æ¢…ç”° â†’ HEP FIVE æ‘©å¤©è¼ª (âš ï¸ æ³¨æ„ï¼šè¡Œç¨‹è¨»æ˜ç‚ºç¶­ä¿®ä¸­)' },
                   { time: '17:00', description: 'å‰å¾€é£¯åº— â†’ å…¥ä½ The Bridge Hotel Shinsaibashi ğŸ¨' },
                   { time: '18:30', description: 'é“é “å €ï¼†å¿ƒé½‹æ©‹è‡ªç”±æ´»å‹• ğŸ' }
               ]
           },
           {
               day: 4,
               date: '10/19 (æ—¥)',
               city: 'å¤§é˜ª (Osaka)',
               theme: 'å¤§é˜ªæ·±åº¦ï¼šæ­·å²ã€æ–‡åŒ–èˆ‡ç¾é£Ÿ',
               activities: [
                   { time: '08:30', description: 'åœ°éµè‡³å¤§é˜ªå•†å‹™åœ’å€ ğŸš‡' },
                   { time: '09:00', description: 'åƒè§€å¤§é˜ªåŸï¼†å¾¡åº§èˆ¹ï¼‹åšç‰©é¤¨ (å‘¨éŠå·ï¼Œç´„2.5å°æ™‚) ğŸ¯' },
                   { time: '12:00', description: 'å¤§é˜ªå¤©æ»¿å®®åƒæ‹œ â›©ï¸' },
                   { time: '12:30', description: 'å¤©ç¥æ©‹ç­‹å•†åº—è¡—åˆé¤ ğŸœ' },
                   { time: '13:30', description: 'å¤§é˜ªç”Ÿæ´»ä»Šæ˜”é¤¨ (å‘¨éŠå·ï¼Œå¯é«”é©—å’Œæœ) ğŸ˜ï¸' },
                   { time: '15:30', description: 'é»‘é–€å¸‚å ´æ•£ç­– (æµ·é®®/å’Œç‰›ä¸²/æ°´æœå¤§ç¦) ğŸŸ' },
                   { time: '17:00', description: 'å›å¿ƒé½‹æ©‹ï¼é“é “å €è‡ªç”±é€›è¡— ğŸ›ï¸' },
                   { time: '20:00', description: 'æ™šé¤ï¼šç‡’è‚‰åŠ›ä¸¸é›£æ³¢é“é “å €åº— ğŸ¥©' }
               ]
           },
           {
               day: 5,
               date: '10/20 (ä¸€)',
               city: 'å¤§é˜ª â†’ é—œè¥¿æ©Ÿå ´ (KIX)',
               theme: 'å¤§é³¥å¤§ç¤¾åƒæ‹œï¼‹è¿”ç¨‹',
               activities: [
                   { time: '08:30', description: 'åœ°éµè‡³å¤©ç‹å¯º â†’ JRè‡³é³³ç«™ ğŸš‡' },
                   { time: '09:20', description: 'åƒæ‹œå¤§é³¥å¤§ç¤¾ â›©ï¸' },
                   { time: '10:00', description: 'JRï¼å—æµ·é›»éµ â†’ é—œè¥¿æ©Ÿå ´ ğŸš…' },
                   { time: '11:00', description: 'å ±åˆ°ï¼é€€ç¨…ï¼åˆé¤æº–å‚™ âœˆï¸' },
                   { time: '14:00', description: 'æ­æ©Ÿè¿”å° ğŸ›¬ (ä¸­è¯èˆªç©º CI0153)' }
               ]
           }
       ];

       // äº”æ—¥å¤©æ°£é å ±æ•¸æ“š (åŸºæ–¼é—œè¥¿åæœˆä¸­æ—¬çš„æ¨¡æ“¬æ•¸æ“š)
       const weatherForecast = [
           { date: '10/16 (å››)', city: 'äº¬éƒ½', icon: 'â˜€ï¸', condition: 'æ™´æœ—', high: 23, low: 15 },
           { date: '10/17 (äº”)', city: 'äº¬éƒ½', icon: 'ğŸŒ¤ï¸', condition: 'å¤šé›²', high: 22, low: 14 },
           { date: '10/18 (å…­)', city: 'å¤§é˜ª', icon: 'ğŸŒ§ï¸', condition: 'æœ‰é›¨', high: 19, low: 16 },
           { date: '10/19 (æ—¥)', city: 'å¤§é˜ª', icon: 'ğŸŒ¥ï¸', condition: 'å±€éƒ¨å¤šé›²', high: 21, low: 13 },
           { date: '10/20 (ä¸€)', city: 'å¤§é˜ª', icon: 'â˜€ï¸', condition: 'æ™´æœ—', high: 24, low: 15 },
       ];
       
       // ====================================================================
       // Utility Functions
       // ====================================================================

       function createElement(tag, classes = [], content = '', attributes = {}) {
           const el = document.createElement(tag);
           if (classes.length) {
               el.className = classes.join(' ');
           }
           if (content) {
               el.innerHTML = content;
           }
           for (const key in attributes) {
               el.setAttribute(key, attributes[key]);
           }
           return el;
       }

       function createDetailItem(label, value) {
           const item = createElement('div', ['detail-item']);
           item.appendChild(createElement('span', ['text-gray-300'], label));
           item.appendChild(createElement('span', ['font-semibold', 'text-right', 'text-white'], value));
           return item;
       }

       // ====================================================================
       // Firebase & Data Logic
       // ====================================================================
       
       /**
        * åˆå§‹åŒ– Firebase æ‡‰ç”¨å’Œèªè­‰ã€‚
        * @param {App} appInstance æ‡‰ç”¨ç¨‹å¼å¯¦ä¾‹
        */
       async function setupFirebase(appInstance) {
           try {
               if (!firebaseConfig) {
                   console.error("Firebase config is missing.");
                   return;
               }
               
               // setLogLevel('debug'); // å•Ÿç”¨ Firebase Debug æ¨¡å¼
               
               const app = initializeApp(firebaseConfig);
               const db = getFirestore(app);
               const auth = getAuth(app);

               // å˜—è©¦ä½¿ç”¨è‡ªè¨‚ token ç™»å…¥æˆ–åŒ¿åç™»å…¥
               let userId = null;
               
               if (initialAuthToken) {
                   await signInWithCustomToken(auth, initialAuthToken);
               } else {
                   await signInAnonymously(auth);
               }

               onAuthStateChanged(auth, (user) => {
                   userId = user ? user.uid : crypto.randomUUID();
                   
                   appInstance.setState({
                       db,
                       auth,
                       userId,
                       isAuthReady: true,
                       loading: false // èªè­‰å®Œæˆï¼ŒçµæŸè¼‰å…¥
                   });

                   // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹ç›£è½æ”¯å‡ºè³‡æ–™
                   if (user) {
                       listenForExpenses(db, userId, appInstance);
                   }
               });

           } catch (error) {
               console.error("Firebase initialization failed:", error);
               appInstance.setState({ loading: false });
           }
       }

       /**
        * ç›£è½ Firestore ä¸­çš„æ”¯å‡ºè³‡æ–™
        * @param {Firestore} db
        * @param {string} userId
        * @param {App} appInstance æ‡‰ç”¨ç¨‹å¼å¯¦ä¾‹
        */
       function listenForExpenses(db, userId, appInstance) {
           const expensesRef = collection(db, `/artifacts/${appId}/users/${userId}/expenses`);
           const q = query(expensesRef);

           onSnapshot(q, (snapshot) => {
               const expenses = snapshot.docs.map(doc => ({
                   id: doc.id,
                   ...doc.data()
               }));

               // æŒ‰ç…§ Day æ’åº (æ•¸å­—)ï¼Œå†æŒ‰æ™‚é–“æˆ³è¨˜æ’åº
               expenses.sort((a, b) => {
                   if (a.day !== b.day) return a.day - b.day;
                   // ç¢ºä¿ timestamp å­˜åœ¨ä¸”å¯æ¯”è¼ƒ
                   const timeA = a.timestamp?.toMillis() || 0;
                   const timeB = b.timestamp?.toMillis() || 0;
                   return timeA - timeB;
               });

               appInstance.setState({ expenses });
           }, (error) => {
               console.error("Error listening to expenses:", error);
           });
       }

       /**
        * æ–°å¢ä¸€ç­†æ”¯å‡ºè¨˜éŒ„åˆ° Firestore
        * @param {App} appInstance æ‡‰ç”¨ç¨‹å¼å¯¦ä¾‹
        * @param {object} data æ”¯å‡ºè³‡æ–™ { day, item, amount }
        */
       async function addExpense(appInstance, data) {
           if (!appInstance.state.db || !appInstance.state.isAuthReady) {
               console.error("Firestore not ready.");
               return;
           }
           
           const expensesRef = collection(appInstance.state.db, `/artifacts/${appId}/users/${appInstance.state.userId}/expenses`);

           try {
               await addDoc(expensesRef, {
                   day: parseInt(data.day), // ç¢ºä¿æ˜¯æ•¸å­—
                   item: data.item,
                   amount: parseFloat(data.amount), // ç¢ºä¿æ˜¯æµ®é»æ•¸
                   currency: 'JPY',
                   timestamp: serverTimestamp() // ä½¿ç”¨ä¼ºæœå™¨æ™‚é–“æˆ³è¨˜
               });
               // alert('è¨˜å¸³æˆåŠŸï¼'); // ä½¿ç”¨è‡ªè¨‚ UI æ›¿ä»£
           } catch (e) {
               console.error("Error adding document: ", e);
               // alert('è¨˜å¸³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚'); // ä½¿ç”¨è‡ªè¨‚ UI æ›¿ä»£
           }
       }

       // ====================================================================
       // View Components
       // ====================================================================

       // [EssentialInfo å’Œ ItineraryDetail å‡½æ•¸èˆ‡åŸç‰ˆç›¸åŒï¼Œç‚ºç¯€çœç¯‡å¹…çœç•¥ï¼Œè«‹è¦‹æœ€ä¸Šæ–¹ä»£ç¢¼]
       
       /**
        * æ¸²æŸ“å¤©æ°£é å ±å€å¡Š (Essential Info é é¢å°ˆç”¨)
        */
       function WeatherForecast() {
           const container = createElement('div', ['p-0', 'mb-6']);
           container.appendChild(createElement('h2', ['text-xl', 'font-bold', 'mb-3', 'text-yellow-400'], 'äº”æ—¥å¤©æ°£é å ± (â„ƒ)'));

           // ä½¿ç”¨ flex å’Œ overflow-x-auto å¯¦ç¾æ©«å‘æ»¾å‹•
           const forecastList = createElement('div', ['flex', 'overflow-x-auto', 'space-x-4', 'pb-2', 'snap-x', 'snap-mandatory']);
           
           weatherForecast.forEach(day => {
               const card = createElement('div', [
                   'weather-card', 'card', 'flex', 'flex-col', 'items-center', 'justify-between', 'snap-start'
               ]);
               
               card.appendChild(createElement('div', ['text-sm', 'font-medium', 'text-gray-300'], day.date.substring(0, 5))); // 10/16
               card.appendChild(createElement('div', ['text-xs', 'text-gray-400', 'mb-1'], day.city));
               card.appendChild(createElement('div', ['weather-icon'], day.icon));
               card.appendChild(createElement('div', ['weather-temp', 'mt-1'], `${day.high}Â° / ${day.low}Â°`));
               card.appendChild(createElement('div', ['text-xs', 'text-gray-400', 'mt-1'], day.condition));

               forecastList.appendChild(card);
           });

           container.appendChild(forecastList);
           return container;
       }


       /**
        * æ¸²æŸ“å¿…å‚™è³‡è¨Šé é¢
        */
       function EssentialInfo() {
           const container = createElement('div', ['p-4', 'flex-grow']);

           // 1. æ’å…¥å¤©æ°£é å ±
           container.appendChild(WeatherForecast());

           // 2. èˆªç­è³‡è¨Šå¡ç‰‡
           const flightCard = createElement('div', ['card', 'mb-6']);
           flightCard.appendChild(createElement('h2', ['text-xl', 'font-bold', 'mb-3', 'text-red-400'], 'âœˆï¸ èˆªç­èˆ‡äººå“¡è³‡è¨Š'));
           
           const flightList = createElement('div');
           flightList.appendChild(createDetailItem('æ—…è¡Œäººæ•¸', '4ä½ (å®¶æ—æ—…è¡Œ)'));
           flightList.appendChild(createDetailItem('å»ç¨‹èˆªç­', 'CI0152 (TPE 09:00 â†’ KIX 12:50)'));
           flightList.appendChild(createDetailItem('å›ç¨‹èˆªç­', 'CI0153 (KIX 14:00 â†’ TPE 15:55)'));
           flightList.appendChild(createDetailItem('èˆªç©ºå…¬å¸', 'ä¸­è¯èˆªç©º'));
           flightCard.appendChild(flightList);
           container.appendChild(flightCard);

           // 3. é£¯åº—è³‡è¨Šå¡ç‰‡
           const hotelCard = createElement('div', ['card', 'mb-6']);
           hotelCard.appendChild(createElement('h2', ['text-xl', 'font-bold', 'mb-3', 'text-blue-400'], 'ğŸ¨ é£¯åº—è³‡è¨Š (åˆ†ä½)'));
           
           const hotelList = createElement('div');
           hotelList.appendChild(createDetailItem('äº¬éƒ½é£¯åº— (10/16-10/18)', 'Hotel The Mâ€™s Kyoto'));
           hotelList.appendChild(createDetailItem('å¤§é˜ªé£¯åº— (10/18-10/20)', 'The Bridge Hotel Shinsaibashi'));
           hotelList.appendChild(createDetailItem('ä¸»è¦äº¤é€šæ–¹å¼', 'JRã€åœ°éµã€å·´å£« (å«å‘¨éŠå·)'));
           hotelCard.appendChild(hotelList);
           container.appendChild(hotelCard);
           
           // 4. å¿…å‚™è³‡è¨Šå¡ç‰‡
           const generalCard = createElement('div', ['card']);
           generalCard.appendChild(createElement('h2', ['text-xl', 'font-bold', 'mb-3', 'text-yellow-400'], 'æ—…è¡Œå¿…å‚™æé†’'));
           
           const generalList = createElement('div');
           generalList.appendChild(createDetailItem('è²¨å¹£', 'æ—¥åœ“ (JPY)'));
           generalList.appendChild(createDetailItem('æ™‚å·®', 'æ—¥æœ¬å¿«å°ç£ 1 å°æ™‚'));
           generalList.appendChild(createDetailItem('é›»å£“', '100V (æ‰å¹³å…©è…³æ’é ­)'));
           generalList.appendChild(createDetailItem('æ³¨æ„', 'âš ï¸ HEP FIVE æ‘©å¤©è¼ªç¶­ä¿®ä¸­'));
           generalCard.appendChild(generalList);
           container.appendChild(generalCard);
           
           return container;
       }

       /**
        * æ¸²æŸ“åˆ†æ—¥è¡Œç¨‹å…§å®¹
        */
       function ItineraryDetail(appInstance) {
           const container = createElement('div', ['p-4', 'flex-grow']);
           const currentDay = appInstance.state.currentDay;
           
           // ------------------------------------------
           // 1. æ¸²æŸ“æ¬¡ç´šå°èˆª (Day Tabs)
           // ------------------------------------------
           const dayNavContainer = createElement('div', ['flex', 'overflow-x-auto', 'space-x-3', 'mb-4', 'pb-1', 'sticky', 'top-[75px]', 'z-5', 'bg-[#1a1a2e]', 'rounded-lg', 'shadow-md']);
           
           for (let i = 1; i <= itineraryData.length; i++) {
               const dayBtn = createElement('button', [
                   'day-nav-button',
                   i === currentDay ? 'active' : ''
               ], `Day ${i}`);
               dayBtn.onclick = () => appInstance.handleDayChange(i);
               dayNavContainer.appendChild(dayBtn);
           }
           container.appendChild(dayNavContainer);

           // ------------------------------------------
           // 2. æ¸²æŸ“ç•¶å‰æ—¥æœŸçš„è©³ç´°è¡Œç¨‹
           // ------------------------------------------
           const dayPlan = itineraryData.find(p => p.day === currentDay);
           
           if (!dayPlan) {
               container.appendChild(createElement('p', ['text-center', 'text-gray-400', 'mt-10'], 'æ‰¾ä¸åˆ°æ­¤æ—¥çš„è¡Œç¨‹è³‡è¨Šã€‚'));
               return container;
           }

           const dayCard = createElement('div', ['card', 'mt-2']);
           
           // Card Header
           const header = createElement('div', ['mb-3', 'pb-2', 'border-b', 'border-yellow-400']);
           header.appendChild(createElement('h2', ['text-2xl', 'font-extrabold', 'text-yellow-400'], `Day ${dayPlan.day}: ${dayPlan.date}`));
           header.appendChild(createElement('p', ['text-lg', 'font-medium', 'text-gray-300', 'mt-1'], `åœ°é»ï¼š${dayPlan.city}`));
           header.appendChild(createElement('p', ['text-sm', 'text-gray-400'], `ä¸»é¡Œï¼š${dayPlan.theme}`));
           dayCard.appendChild(header);

           // Activity List
           const activitiesList = createElement('div', ['space-y-4']);
           dayPlan.activities.forEach(activity => {
               const activityItem = createElement('div', ['flex', 'items-start', 'space-x-3']);
               
               // Time Tag
               const timeTagClasses = activity.time.includes('å…¨å¤©') ? ['bg-green-600'] : ['bg-red-600'];
               const timeTag = createElement('span', [
                   'text-xs', 'font-bold', 'px-2', 'py-1', 'rounded-full', ...timeTagClasses, 'text-white', 'flex-shrink-0', 'mt-1'
               ], activity.time);
               
               // Description
               const descriptionContent = activity.description.replace('âš ï¸', '<span class="text-red-400 font-bold">âš ï¸</span>'); // Highlight warning
               const description = createElement('p', ['text-base', 'text-gray-100'], descriptionContent);

               activityItem.appendChild(timeTag);
               activityItem.appendChild(description);
               activitiesList.appendChild(activityItem);
           });

           dayCard.appendChild(activitiesList);
           container.appendChild(dayCard);
           

           // ------------------------------------------
           // 3. é¡¯ç¤ºä¸‹ä¸€æ—¥çš„é å‘Š (ä½œç‚ºæ»¾å‹•åˆ‡æ›çš„æ›¿ä»£)
           // ------------------------------------------
           if (currentDay < itineraryData.length) {
               const nextDay = itineraryData.find(p => p.day === currentDay + 1);
               if (nextDay) {
                    const nextDayCard = createElement('div', ['card', 'mt-6', 'opacity-80', 'cursor-pointer'], `
                       <p class="text-sm text-gray-400 mb-1">--- ä¸‹ä¸€æ—¥é å‘Š ---</p>
                       <h3 class="text-xl font-bold text-blue-300">Day ${nextDay.day}: ${nextDay.theme}</h3>
                       <p class="text-sm text-gray-300">${nextDay.activities[0].description}...</p>
                   `);
                   nextDayCard.onclick = () => appInstance.handleDayChange(currentDay + 1);
                   container.appendChild(nextDayCard);
               }
           }


           return container;
       }

       /**
        * æ¸²æŸ“è¨˜å¸³é é¢ (æ–°åŠŸèƒ½)
        * @param {App} appInstance
        */
       function AccountingPage(appInstance) {
           const { expenses, loading, userId } = appInstance.state;
           const container = createElement('div', ['p-4', 'flex-grow', 'space-y-6']);

           // 1. ç¸½è¦½å¡ç‰‡
           const totalAmount = expenses.reduce((sum, exp) => sum + exp.amount, 0);
           const summaryCard = createElement('div', ['card', 'p-4', 'bg-[#3a3a5a]', 'text-center']);
           summaryCard.appendChild(createElement('p', ['text-gray-300', 'text-lg'], 'ğŸ‡¯ğŸ‡µ é—œè¥¿ç¸½èŠ±è²» (æ—¥åœ“)'));
           summaryCard.appendChild(createElement('h2', ['text-5xl', 'font-extrabold', 'text-red-400'], `Â¥ ${totalAmount.toFixed(0)}`));
           summaryCard.appendChild(createElement('p', ['text-xs', 'text-gray-400', 'mt-2'], `ä½¿ç”¨è€… ID: ${userId || 'è¼‰å…¥ä¸­...'}`));
           container.appendChild(summaryCard);

           // 2. æ–°å¢è¨˜å¸³è¡¨å–®
           const formCard = createElement('div', ['card', 'p-4', 'space-y-4']);
           formCard.appendChild(createElement('h3', ['text-xl', 'font-bold', 'text-yellow-400', 'mb-3'], 'ğŸ“ æ–°å¢ä¸€ç­†èŠ±è²»'));

           // è¡¨å–®å…ƒç´ 
           const form = createElement('form', ['space-y-3']);
           
           // Day Selection
           const daySelect = createElement('select', ['input-field', 'w-full'], '', { id: 'expense-day', required: true });
           daySelect.appendChild(createElement('option', [], 'é¸æ“‡æ—¥æœŸ', { value: '', disabled: true, selected: true }));
           itineraryData.forEach(dayPlan => {
               daySelect.appendChild(createElement('option', [], `Day ${dayPlan.day} (${dayPlan.date})`, { value: dayPlan.day }));
           });
           form.appendChild(daySelect);

           // Item Input
           const itemInput = createElement('input', ['input-field', 'w-full'], '', { type: 'text', id: 'expense-item', placeholder: 'èŠ±è²»é …ç›® (ex: æ™šé¤ã€è»Šç¥¨)', required: true });
           form.appendChild(itemInput);

           // Amount Input
           const amountInput = createElement('input', ['input-field', 'w-full'], '', { type: 'number', step: '1', min: '1', id: 'expense-amount', placeholder: 'é‡‘é¡ (æ—¥åœ“ Â¥)', required: true });
           form.appendChild(amountInput);

           // Submit Button
           const submitBtn = createElement('button', [
               'w-full', 'bg-green-600', 'hover:bg-green-700', 'text-white', 'font-bold', 'py-2', 'rounded-xl', 'transition', 'duration-200'
           ], 'âœ… å„²å­˜èŠ±è²»');
           form.appendChild(submitBtn);

           form.onsubmit = async (e) => {
               e.preventDefault();
               const day = daySelect.value;
               const item = itemInput.value.trim();
               const amount = amountInput.value.trim();

               if (day && item && amount && !isNaN(parseFloat(amount))) {
                   submitBtn.textContent = 'å„²å­˜ä¸­...';
                   submitBtn.disabled = true;

                   await addExpense(appInstance, { day, item, amount });
                   
                   // é‡è¨­è¡¨å–®
                   itemInput.value = '';
                   amountInput.value = '';
                   daySelect.value = '';

                   submitBtn.textContent = 'âœ… å„²å­˜èŠ±è²»';
                   submitBtn.disabled = false;
               }
           };
           
           formCard.appendChild(form);
           container.appendChild(formCard);

           // 3. æ”¯å‡ºåˆ—è¡¨
           const listCard = createElement('div', ['card', 'p-4']);
           listCard.appendChild(createElement('h3', ['text-xl', 'font-bold', 'text-blue-400', 'mb-3', 'border-b', 'pb-2', 'border-gray-600'], 'ğŸ’¸ æ‰€æœ‰æ”¯å‡ºåˆ—è¡¨'));

           if (loading) {
               listCard.appendChild(createElement('p', ['text-center', 'text-gray-400'], 'è³‡æ–™è¼‰å…¥ä¸­...'));
           } else if (expenses.length === 0) {
               listCard.appendChild(createElement('p', ['text-center', 'text-gray-400'], 'å°šç„¡æ”¯å‡ºè¨˜éŒ„ï¼Œå¿«ä¾†æ–°å¢ç¬¬ä¸€ç­†å§ï¼'));
           } else {
               const expenseList = createElement('div', ['space-y-1']);
               
               expenses.forEach(expense => {
                   const item = createElement('div', ['expense-list-item']);
                   
                   // å·¦å´: Day + Item
                   const left = createElement('div', ['flex', 'items-center']);
                   left.appendChild(createElement('span', ['bg-gray-700', 'text-xs', 'px-2', 'py-1', 'rounded', 'mr-3', 'flex-shrink-0'], `Day ${expense.day}`));
                   left.appendChild(createElement('span', ['text-white', 'font-medium', 'truncate'], expense.item));
                   item.appendChild(left);

                   // å³å´: Amount
                   item.appendChild(createElement('span', ['text-lg', 'font-extrabold', 'text-red-300', 'flex-shrink-0', 'ml-2'], `Â¥ ${expense.amount.toFixed(0)}`));

                   expenseList.appendChild(item);
               });
               listCard.appendChild(expenseList);
           }
           
           container.appendChild(listCard);
           return container;
       }


       /**
        * ä¸»æ‡‰ç”¨ç¨‹å¼é‚è¼¯
        */
       class App {
           constructor(containerId) {
               this.container = document.getElementById(containerId);
               this.state = {
                   currentPage: 'itinerary', // é è¨­é¡¯ç¤ºè¡Œç¨‹
                   currentDay: 1, // é è¨­é¡¯ç¤º Day 1
                   db: null,
                   auth: null,
                   userId: null,
                   isAuthReady: false,
                   expenses: [], // å„²å­˜ Firebase è²»ç”¨è³‡æ–™
                   loading: true // åˆå§‹è¼‰å…¥ç‹€æ…‹
               };
               this.init();
           }

           async init() {
               // åˆå§‹æ¸²æŸ“è¼‰å…¥ç•«é¢
               this.render();
               await setupFirebase(this);
           }

           setState(newState) {
               this.state = { ...this.state, ...newState };
               this.render();
           }

           // è™•ç†ä¸»å°èˆªåˆ‡æ›
           handleNavigation(page) {
               this.setState({ currentPage: page });
           }

           // è™•ç†åˆ†æ—¥åˆ‡æ›
           handleDayChange(day) {
               if (day !== this.state.currentDay) {
                   this.setState({ currentDay: day });
               }
           }

           // æ¸²æŸ“å°èˆªæ¬„
           renderNavBar() {
               const navBar = createElement('nav', ['flex', 'justify-around', 'p-4', 'bg-[#121221]', 'sticky', 'top-0', 'z-10', 'shadow-lg', 'rounded-b-xl']);

               const pages = [
                   { id: 'essential', label: 'å¿…å‚™è³‡è¨Š' },
                   { id: 'itinerary', label: 'æ¯æ—¥è¡Œç¨‹' },
                   { id: 'accounting', label: 'è¨˜å¸³' } // æ–°å¢è¨˜å¸³é é¢
               ];

               pages.forEach(page => {
                   const btn = createElement('button', [
                       'main-nav-button',
                       'p-2',
                       this.state.currentPage === page.id ? 'active' : 'text-gray-400'
                   ], page.label);
                   btn.onclick = () => this.handleNavigation(page.id);
                   navBar.appendChild(btn);
               });

               return navBar;
           }

           renderContent() {
               if (this.state.loading) {
                   // ç°¡å–®çš„è¼‰å…¥å‹•ç•«/è¨Šæ¯
                   const loader = createElement('div', ['text-center', 'py-10']);
                   loader.appendChild(createElement('p', ['text-xl', 'text-yellow-400', 'animate-pulse'], 'è¼‰å…¥ä¸­... (é€£ç·šè‡³è³‡æ–™åº«)'));
                   return loader;
               }

               let content;
               if (this.state.currentPage === 'itinerary') {
                   content = ItineraryDetail(this);
               } else if (this.state.currentPage === 'accounting') {
                   content = AccountingPage(this);
               } else {
                   content = EssentialInfo();
               }
               return content;
           }

           render() {
               // æ¸…ç©ºå®¹å™¨
               this.container.innerHTML = '';

               // æ¨™é¡Œ
               const title = createElement('h1', ['text-3xl', 'font-extrabold', 'text-center', 'pt-6', 'pb-4', 'text-white'], 'ğŸ‡¯ğŸ‡µ é—œè¥¿äº”æ—¥éŠ ğŸ‡¯ğŸ‡µ');
               this.container.appendChild(title);

               // å°èˆª
               this.container.appendChild(this.renderNavBar());

               // å…§å®¹
               this.container.appendChild(this.renderContent());
           }
       }

       // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
       window.onload = () => {
           new App('app');
       };
   </script>
</body>
</html>