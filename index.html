<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>é—œè¥¿äº”æ—¥éŠè¨˜å¸³èˆ‡è¡Œç¨‹</title>
   <!-- è¼‰å…¥ Tailwind CSS -->
   <script src="https://cdn.tailwindcss.com"></script>
   <!-- è¼‰å…¥ Inter å­—é«” -->
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
   <style>
       body {
           font-family: 'Inter', sans-serif;
           background-color: #f7f9fc;
       }
       .scroll-hidden::-webkit-scrollbar {
           display: none;
       }
       .scroll-hidden {
           -ms-overflow-style: none;  /* IE and Edge */
           scrollbar-width: none;  /* Firefox */
       }
   </style>
</head>
<body>

   <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
   <div id="app" class="min-h-screen p-4 sm:p-6 md:p-8">
       
       <!-- æ¨™é¡Œå¡ç‰‡ -->
       <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
           <h1 class="text-3xl font-extrabold text-green-700">ğŸ é—œè¥¿äº”æ—¥éŠãƒ»ç§‹æ—¥æ¼«éŠ</h1>
           <p class="text-gray-500 mt-1">æ—¥æœŸï¼š10/16 ~ 10/20 (5å¤©4å¤œ) | 4äººå®¶åº­æ—…è¡Œ</p>
           <div class="mt-4 flex flex-wrap gap-3 text-sm font-semibold">
               <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full">äº¬éƒ½ (M's Hotel)</span>
               <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full">å¤§é˜ª (Bridge Hotel)</span>
           </div>
       </div>

       <!-- ç¸½æ”¯å‡ºæ¦‚è¦½å¡ç‰‡ -->
       <div class="bg-indigo-600 text-white p-5 rounded-2xl shadow-xl mb-6">
           <div id="loading-status" class="text-center font-medium">
               æ­£åœ¨åˆå§‹åŒ– Firebase...
           </div>
           <div id="summary-content" class="hidden">
               <p class="text-sm opacity-80">æœ¬æ¬¡æ—…è¡Œç¸½æ”¯å‡º (æ—¥åœ“)</p>
               <h2 id="total-trip-expense" class="text-4xl font-bold mt-1">Â¥ 0</h2>
           </div>
       </div>

       <!-- æ—¥æœŸå°èˆªæ¨™ç±¤ -->
       <div class="flex overflow-x-auto scroll-hidden mb-4 p-1 bg-white rounded-xl shadow-lg">
           <template id="day-tabs-template">
               <!-- æ¯æ—¥å°èˆªæŒ‰éˆ•ï¼Œå°‡ç”± JS å¡«å…… -->
           </template>
       </div>

       <!-- è¨˜å¸³èˆ‡è¡Œç¨‹å…§å®¹å€å¡Š -->
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

           <!-- è¨˜å¸³åŠŸèƒ½å€å¡Š -->
           <div class="lg:col-span-1">
               <div class="bg-white p-6 rounded-2xl shadow-xl sticky top-4">
                   <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2 text-indigo-500">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                       </svg>
                       <span id="current-day-title">Day 1</span> æ”¯å‡ºç´€éŒ„
                   </h2>

                   <!-- ç•¶æ—¥æ”¯å‡ºç¸½é¡ -->
                   <div class="mb-5 p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                       <p class="text-sm font-medium text-indigo-600">ç•¶æ—¥ç¸½æ”¯å‡º</p>
                       <p id="daily-total" class="text-3xl font-bold text-indigo-800">Â¥ 0</p>
                   </div>

                   <!-- æ–°å¢æ”¯å‡ºè¡¨å–® -->
                   <form id="expense-form" class="space-y-4">
                       <input type="hidden" id="expense-day-index" value="1">

                       <div>
                           <label for="expense-description" class="block text-sm font-medium text-gray-700">é …ç›®èªªæ˜</label>
                           <input type="text" id="expense-description" required placeholder="åˆé¤ã€é–€ç¥¨ã€äº¤é€šå¡"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                       </div>
                       
                       <div>
                           <label for="expense-amount" class="block text-sm font-medium text-gray-700">é‡‘é¡ (æ—¥åœ“ Â¥)</label>
                           <input type="number" id="expense-amount" required min="1" placeholder="ä¾‹å¦‚ï¼š2500"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                       </div>

                       <div>
                           <label for="expense-category" class="block text-sm font-medium text-gray-700">é¡åˆ¥</label>
                           <select id="expense-category" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                               <option value="é¤é£²">é¤é£² ğŸœ</option>
                               <option value="äº¤é€š">äº¤é€š ğŸš„</option>
                               <option value="ä½å®¿">ä½å®¿ ğŸ¨</option>
                               <option value="é–€ç¥¨">é–€ç¥¨/å¨›æ¨‚ ğŸŸï¸</option>
                               <option value="è³¼ç‰©">è³¼ç‰©/ç´€å¿µå“ ğŸ›ï¸</option>
                               <option value="å…¶ä»–">å…¶ä»– ğŸ·ï¸</option>
                           </select>
                       </div>

                       <button type="submit" id="add-expense-btn"
                           class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50">
                           + æ–°å¢æ”¯å‡º
                       </button>
                   </form>
               </div>
           </div>

           <!-- æ”¯å‡ºæ˜ç´°èˆ‡è¡Œç¨‹å€å¡Š -->
           <div class="lg:col-span-2 space-y-6">
               <!-- æ¯æ—¥è¡Œç¨‹å¤§ç¶±ï¼ˆå¯è‡ªè¨‚ï¼‰ -->
               <div class="bg-white p-6 rounded-2xl shadow-xl">
                   <h2 class="text-xl font-bold text-gray-800 mb-3">ä»Šæ—¥è¡Œç¨‹å¤§ç¶±</h2>
                   <div id="itinerary-content" class="text-gray-600 space-y-2">
                       <!-- è¡Œç¨‹å…§å®¹å°‡æ ¹æ“šé¸æ“‡çš„ Day é€²è¡Œæ›´æ–° -->
                       <p class="text-sm italic">æ‚¨å¯ä»¥åœ¨é€™è£¡è¦åŠƒ Day 1 çš„è¡Œç¨‹ç´°ç¯€ã€‚ç›®å‰å°šæœªæœ‰è©³ç´°è¦åŠƒã€‚</p>
                       <ul class="list-disc list-inside ml-4 text-sm">
                           <li>ä¸Šåˆï¼šé—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX) æŠµé”èˆ‡å…¥å¢ƒ</li>
                           <li>ä¸­åˆï¼šæ­ä¹˜ JR æˆ–å—æµ·é›»éµå‰å¾€äº¬éƒ½</li>
                           <li>ä¸‹åˆï¼šæŠµé”ä¸¦è¾¦ç† M's Hotel å…¥ä½æ‰‹çºŒ</li>
                           <li>å‚æ™šï¼šæ¢ç´¢é£¯åº—é™„è¿‘å€åŸŸï¼Œå°‹æ‰¾æ™šé¤</li>
                       </ul>
                   </div>
               </div>

               <!-- æ”¯å‡ºæ˜ç´°åˆ—è¡¨ -->
               <div class="bg-white p-6 rounded-2xl shadow-xl">
                   <h2 class="text-xl font-bold text-gray-800 mb-4">æ”¯å‡ºæ˜ç´°</h2>
                   <ul id="expense-list" class="space-y-3">
                       <!-- æ”¯å‡ºé …ç›®å°‡ç”± JS è¼‰å…¥ -->
                       <li id="empty-state" class="text-center py-8 text-gray-400">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mx-auto mb-2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.03 60.03 0 0 1 9.75-2.25v-7.5l-3 2.25m3 5.25v5.25c.571 0 1.127-.123 1.648-.351l-.317-.118m-7.648.351A59.98 59.98 0 0 1 2.25 18.75m12.012 4.409-.323-.139A39.292 39.292 0 0 0 12 21.75V19.5m0-9.75v-2.25m0 0a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Z" />
                           </svg>
                           <p>é»æ“Šã€Œ+ æ–°å¢æ”¯å‡ºã€ä¾†è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€ç­†èŠ±è²»ã€‚</p>
                       </li>
                   </ul>
               </div>
           </div>
       </div>
   </div>


   <!-- Firebase è…³æœ¬ -->
   <script type="module">
       // Firebase æ¨¡çµ„è¼‰å…¥
       import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
       import {
           getAuth,
           signInAnonymously,
           signInWithCustomToken,
           onAuthStateChanged
       } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       import {
           getFirestore,
           doc,
           addDoc,
           onSnapshot,
           collection,
           query,
           deleteDoc,
           orderBy,
           serverTimestamp,
           setDoc,
           getDoc,
           setLogLevel
       } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // è¨­å®š Firebase Log Level
       setLogLevel('debug');
       
       // --- å…¨åŸŸè®Šæ•¸åˆå§‹åŒ– (ä¾†è‡ª Canvas ç’°å¢ƒ) ---
       const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
       const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
       const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

       let db;
       let auth;
       let userId = null;
       let isAuthReady = false;
       
       // Firestore Collection è·¯å¾‘
       const EXPENSES_COLLECTION_NAME = "expenses";
       let expensesRef = null;

       const TOTAL_DAYS = 5;
       let currentDayIndex = 1; // é è¨­é¡¯ç¤º Day 1
       let allExpenses = []; // å„²å­˜æ‰€æœ‰æ”¯å‡ºæ•¸æ“š

       // å…ƒç´ åƒç…§
       const loadingStatusEl = document.getElementById('loading-status');
       const summaryContentEl = document.getElementById('summary-content');
       const totalTripExpenseEl = document.getElementById('total-trip-expense');
       const dayTabsContainer = document.querySelector('.flex.overflow-x-auto');
       const currentDayTitleEl = document.getElementById('current-day-title');
       const dailyTotalEl = document.getElementById('daily-total');
       const expenseForm = document.getElementById('expense-form');
       const expenseListEl = document.getElementById('expense-list');
       const emptyStateEl = document.getElementById('empty-state');
       const expenseDayIndexInput = document.getElementById('expense-day-index');
       const addExpenseBtn = document.getElementById('add-expense-btn');

       // --- è¼”åŠ©å‡½æ•¸ ---

       /**
        * å°‡æ•¸å­—æ ¼å¼åŒ–ç‚ºæ—¥åœ“å­—ä¸²
        * @param {number} amount
        * @returns {string}
        */
       const formatCurrency = (amount) => {
           return `Â¥ ${Math.floor(amount).toLocaleString('ja-JP')}`;
       };

       /**
        * æ ¹æ“šé¡åˆ¥å›å‚³è¡¨æƒ…ç¬¦è™Ÿ
        * @param {string} category
        * @returns {string}
        */
       const getCategoryIcon = (category) => {
           switch (category) {
               case 'é¤é£²': return 'ğŸœ';
               case 'äº¤é€š': return 'ğŸš„';
               case 'ä½å®¿': return 'ğŸ¨';
               case 'é–€ç¥¨': return 'ğŸŸï¸';
               case 'è³¼ç‰©': return 'ğŸ›ï¸';
               case 'å…¶ä»–': return 'ğŸ·ï¸';
               default: return 'ğŸ’°';
           }
       };

       // --- æ¸²æŸ“å‡½æ•¸ ---

       /**
        * æ¸²æŸ“å–®ä¸€æ”¯å‡ºé …ç›®
        * @param {object} expense
        * @returns {string} HTML
        */
       const renderExpenseItem = (expense) => {
           const icon = getCategoryIcon(expense.category);
           return `
               <li data-id="${expense.id}" class="flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200 hover:bg-gray-100 transition duration-150">
                   <div class="flex items-center">
                       <span class="text-xl mr-3">${icon}</span>
                       <div>
                           <p class="font-semibold text-gray-800">${expense.description}</p>
                           <p class="text-xs text-gray-500">${expense.category}</p>
                       </div>
                   </div>
                   <div class="flex items-center space-x-2">
                       <span class="text-lg font-bold text-red-600">${formatCurrency(expense.amount)}</span>
                       <button onclick="deleteExpense('${expense.id}')"
                               class="p-1 text-gray-400 hover:text-red-500 rounded-full transition duration-150"
                               aria-label="åˆªé™¤é …ç›®">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                             <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.166 2.008-5.32c.162-.43.206-.867.144-1.272a.75.75 0 0 0-.96-.705L18.15 3.12l.142.378M18.15 3.12l-1.42 3.774M18.15 3.12 15.65 6.894" />
                           </svg>

                       </button>
                   </div>
               </li>
           `;
       };
       
       /**
        * æ¸²æŸ“æ¯æ—¥è¡Œç¨‹å…§å®¹ï¼ˆç°¡å–®ç¯„ä¾‹ï¼‰
        */
       const renderItineraryContent = (dayIndex) => {
           const itineraryContentEl = document.getElementById('itinerary-content');
           let content = '';

           // é€™æ˜¯æ ¹æ“šæ‚¨åœ–ç‰‡æä¾›çš„è¡Œç¨‹è³‡è¨Šæ’°å¯«çš„ç¯„ä¾‹
           switch (dayIndex) {
               case 1:
                   content = `<p class="text-sm italic">æŠµé”é—œè¥¿ä¸¦å‰å¾€äº¬éƒ½ï¼Œé–‹å§‹ç§‹æ—¥æ¼«éŠã€‚</p>
                       <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                           <li>**ä¸Šåˆï¼š** å°ç£æ¡ƒåœ’æ©Ÿå ´ (TPE) 09:00 å‡ºç™¼ (CI0152)</li>
                           <li>**ä¸­åˆï¼š** é—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX) 12:50 æŠµé”</li>
                           <li>**ä¸‹åˆï¼š** æ­ä¹˜ HARUKA ç‰¹å¿«åˆ—è»Šæˆ–åˆ©æœ¨æ´¥å·´å£«å‰å¾€äº¬éƒ½</li>
                           <li>**å‚æ™šï¼š** è¾¦ç† M's Hotel å…¥ä½æ‰‹çºŒï¼Œæ™šé¤æ–¼äº¬éƒ½è»Šç«™å‘¨é‚Š</li>
                       </ul>`;
                   break;
               case 2:
                   content = `<p class="text-sm italic">äº¬éƒ½æ·±åº¦æ–‡åŒ–é«”é©—æ—¥ã€‚</p>
                       <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                           <li>**ä¸Šåˆï¼š** æ¸…æ°´å¯º (Kiyomizu-dera)ï¼Œæ¼«æ­¥äºŒå¹´å‚ã€ä¸‰å¹´å‚</li>
                           <li>**ä¸­åˆï¼š** åœ¨ç¥‡åœ’é™„è¿‘äº«ç”¨æ—¥å¼å‚³çµ±åˆé¤</li>
                           <li>**ä¸‹åˆï¼š** åƒè§€ä¼è¦‹ç¨»è·å¤§ç¤¾ (Fushimi Inari-taisha) çš„åƒæœ¬é³¥å±…</li>
                           <li>**æ™šä¸Šï¼š** æ¢ç´¢å…ˆæ–—ç”ºæˆ–éŒ¦å¸‚å ´å‘¨é‚Š</li>
                       </ul>`;
                   break;
               case 3:
                   content = `<p class="text-sm italic">å¾äº¬éƒ½ç§»å¾€å¤§é˜ªï¼Œä¸¦é–‹å§‹éƒ½æœƒæ¢ç´¢ã€‚</p>
                       <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                           <li>**ä¸Šåˆï¼š** é€€æˆ¿ï¼Œå¾äº¬éƒ½è»Šç«™æ­ä¹˜æ–°å¹¹ç·šæˆ– JR å¿«é€Ÿå‰å¾€å¤§é˜ª</li>
                           <li>**ä¸­åˆï¼š** åœ¨æ–°å¤§é˜ªæˆ–é›£æ³¢è»Šç«™äº«ç”¨åˆé¤</li>
                           <li>**ä¸‹åˆï¼š** è¾¦ç† Bridge Hotel (å¤§é˜ª) å…¥ä½æ‰‹çºŒï¼Œå‰å¾€å¤§é˜ªåŸå…¬åœ’</li>
                           <li>**æ™šä¸Šï¼š** é“é “å € (Dotonbori) äº«ç”¨æ™šé¤åŠé€›è¡—</li>
                       </ul>`;
                   break;
               case 4:
                   content = `<p class="text-sm italic">å¤§é˜ªè³¼ç‰©èˆ‡ç¾é£Ÿä¹‹æ—…ã€‚</p>
                       <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                           <li>**ä¸Šåˆï¼š** å¿ƒé½‹æ©‹ç­‹å•†åº—è¡— (Shinsaibashisuji) è³¼ç‰©</li>
                           <li>**ä¸­åˆï¼š** åœ¨é»‘é–€å¸‚å ´ (Kuromon Market) å“åšæ–°é®®æµ·ç”¢</li>
                           <li>**ä¸‹åˆï¼š** é€šå¤©é–£ (Tsutenkaku) èˆ‡æ–°ä¸–ç•Œå€æ•£æ­¥</li>
                           <li>**æ™šä¸Šï¼š** æ¢…ç”°ç©ºä¸­åº­åœ’å±•æœ›å° (Umeda Sky Building) æ¬£è³å¤œæ™¯</li>
                       </ul>`;
                   break;
               case 5:
                   content = `<p class="text-sm italic">æº–å‚™è³¦æ­¸ï¼Œæœ€å¾Œçš„é—œè¥¿æ™‚å…‰ã€‚</p>
                       <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                           <li>**ä¸Šåˆï¼š** åœ¨é£¯åº—é™„è¿‘äº«ç”¨æ—©é¤ï¼Œä¸¦é€²è¡Œæœ€å¾Œçš„è³¼ç‰©</li>
                           <li>**ä¸­åˆï¼š** å‰å¾€é—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX)</li>
                           <li>**ä¸‹åˆï¼š** KIX 14:00 å‡ºç™¼ (CI0153) é£›å¾€å°åŒ—</li>
                       </ul>`;
                   break;
               default:
                   content = '<p>è«‹é¸æ“‡ä¸€å€‹æ—¥æœŸä¾†è¦åŠƒè¡Œç¨‹ã€‚</p>';
           }

           itineraryContentEl.innerHTML = content;
       };


       /**
        * æ ¹æ“š currentDayIndex æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨èˆ‡ç¸½è¨ˆ
        */
       const renderExpenses = () => {
           const dailyExpenses = allExpenses.filter(exp => exp.dayIndex === currentDayIndex);
           
           // è¨ˆç®—ç•¶æ—¥ç¸½é¡
           const dailyTotal = dailyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
           dailyTotalEl.textContent = formatCurrency(dailyTotal);
           
           // æ¸²æŸ“åˆ—è¡¨
           if (dailyExpenses.length === 0) {
               expenseListEl.innerHTML = `
                   <li class="text-center py-8 text-gray-400">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mx-auto mb-2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.03 60.03 0 0 1 9.75-2.25v-7.5l-3 2.25m3 5.25v5.25c.571 0 1.127-.123 1.648-.351l-.317-.118m-7.648.351A59.98 59.98 0 0 1 2.25 18.75m12.012 4.409-.323-.139A39.292 39.292 0 0 0 12 21.75V19.5m0-9.75v-2.25m0 0a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Z" />
                       </svg>
                       <p>é»æ“Šã€Œ+ æ–°å¢æ”¯å‡ºã€ä¾†è¨˜éŒ„ Day ${currentDayIndex} çš„ç¬¬ä¸€ç­†èŠ±è²»ã€‚</p>
                   </li>
               `;
           } else {
               expenseListEl.innerHTML = dailyExpenses.map(renderExpenseItem).join('');
           }

           // æ›´æ–°ç¸½è¦½
           const totalTrip = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
           totalTripExpenseEl.textContent = formatCurrency(totalTrip);

           // æ›´æ–° Day æ¨™é¡Œ
           currentDayTitleEl.textContent = `Day ${currentDayIndex}`;
           expenseDayIndexInput.value = currentDayIndex;

           // æ›´æ–°å°èˆªæ¨™ç±¤ä¸Šçš„ç¸½é¡é¡¯ç¤º
           updateDayTabTotals();
       };

       /**
        * æ›´æ–°å°èˆªæ¨™ç±¤ä¸Šçš„ç¸½é¡é¡¯ç¤º
        */
       const updateDayTabTotals = () => {
           const dayTotals = {};
           for (let i = 1; i <= TOTAL_DAYS; i++) {
               dayTotals[i] = allExpenses
                   .filter(exp => exp.dayIndex === i)
                   .reduce((sum, exp) => sum + exp.amount, 0);
           }

           for (let i = 1; i <= TOTAL_DAYS; i++) {
               const dayTabEl = document.getElementById(`day-tab-${i}`);
               if (dayTabEl) {
                   const total = dayTotals[i];
                   dayTabEl.innerHTML = `
                       Day ${i}
                       <span class="text-xs ml-1 font-normal ${total > 0 ? 'text-red-300' : 'text-gray-300'}">
                           ${total > 0 ? formatCurrency(total) : formatCurrency(0)}
                       </span>
                   `;
                   
                   // æ›´æ–°æ´»èºç‹€æ…‹
                   if (i === currentDayIndex) {
                       dayTabEl.classList.add('bg-indigo-600', 'text-white');
                       dayTabEl.classList.remove('bg-white', 'text-indigo-600', 'hover:bg-indigo-50');
                   } else {
                       dayTabEl.classList.remove('bg-indigo-600', 'text-white');
                       dayTabEl.classList.add('bg-white', 'text-indigo-600', 'hover:bg-indigo-50');
                   }
               }
           }
       };

       /**
        * æ¸²æŸ“æ¯æ—¥è¡Œç¨‹å°èˆªæ¨™ç±¤
        */
       const renderDayTabs = () => {
           let html = '';
           for (let i = 1; i <= TOTAL_DAYS; i++) {
               html += `
                   <button id="day-tab-${i}" onclick="selectDay(${i})"
                           class="flex-shrink-0 px-4 py-2 font-semibold rounded-xl transition duration-150 ease-in-out whitespace-nowrap text-indigo-600 bg-white hover:bg-indigo-50 shadow-md border border-gray-100">
                       Day ${i}
                       <span class="text-xs ml-1 font-normal text-gray-300">${formatCurrency(0)}</span>
                   </button>
               `;
           }
           dayTabsContainer.innerHTML = html;
           // åˆå§‹é¸ä¸­ Day 1
           selectDay(currentDayIndex);
       };

       // --- äº‹ä»¶è™•ç†èˆ‡é‚è¼¯ ---

       /**
        * é¸æ“‡ç‰¹å®šçš„æ—…è¡Œæ—¥
        * @param {number} dayIndex
        */
       window.selectDay = (dayIndex) => {
           currentDayIndex = dayIndex;
           renderExpenses(); // é‡æ–°æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨å’Œç¸½é¡
           renderItineraryContent(dayIndex); // é‡æ–°æ¸²æŸ“è¡Œç¨‹å…§å®¹
       };
       
       /**
        * å¾ Firestore åˆªé™¤æ”¯å‡ºé …ç›®
        * @param {string} expenseId
        */
       window.deleteExpense = async (expenseId) => {
           if (!isAuthReady) return console.error('Firebase Auth not ready.');
           
           try {
               // ç¢ºèªè·¯å¾‘æ­£ç¢º
               const expenseDocRef = doc(expensesRef, expenseId);
               await deleteDoc(expenseDocRef);
               // onSnapshot æœƒè‡ªå‹•æ›´æ–° UI
               console.log(`Expense ${expenseId} deleted.`);
           } catch (e) {
               console.error("åˆªé™¤æ”¯å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
           }
       };


       /**
        * è™•ç†è¡¨å–®æäº¤ï¼Œæ–°å¢æ”¯å‡º
        * @param {Event} e
        */
       const handleAddExpense = async (e) => {
           e.preventDefault();
           if (!isAuthReady) return console.error('Firebase Auth not ready.');

           const description = document.getElementById('expense-description').value.trim();
           const amount = parseFloat(document.getElementById('expense-amount').value);
           const category = document.getElementById('expense-category').value;
           const dayIndex = parseInt(document.getElementById('expense-day-index').value);

           if (!description || isNaN(amount) || amount <= 0 || !category) {
               return;
           }
           
           addExpenseBtn.disabled = true;
           addExpenseBtn.textContent = 'æ–°å¢ä¸­...';

           try {
               await addDoc(expensesRef, {
                   dayIndex: dayIndex,
                   description: description,
                   amount: amount,
                   category: category,
                   createdAt: serverTimestamp(),
                   userId: userId
               });
               
               // æ¸…ç©ºè¡¨å–®
               expenseForm.reset();
           } catch (e) {
               console.error("æ–°å¢æ”¯å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
           } finally {
               addExpenseBtn.disabled = false;
               addExpenseBtn.textContent = '+ æ–°å¢æ”¯å‡º';
           }
       };

       // --- Firebase æ ¸å¿ƒå‡½æ•¸ ---

       /**
        * ç›£è½ Firestore ä¸­çš„æ”¯å‡ºæ•¸æ“š
        */
       const subscribeToExpenses = () => {
           // æŸ¥è©¢ï¼šæŒ‰å»ºç«‹æ™‚é–“æ’åº
           const q = query(expensesRef, orderBy("createdAt", "desc"));

           // è¨­å®šå³æ™‚ç›£è½å™¨
           onSnapshot(q, (snapshot) => {
               allExpenses = snapshot.docs.map(doc => ({
                   id: doc.id,
                   ...doc.data(),
                   // ç¢ºä¿ amount æ˜¯æ•¸å­—ï¼ŒdayIndex æ˜¯æ•¸å­—
                   amount: parseFloat(doc.data().amount || 0),
                   dayIndex: parseInt(doc.data().dayIndex || 1)
               }));
               
               // æ¸²æŸ“æ‰€æœ‰ç›¸é—œ UI
               renderExpenses();
           }, (error) => {
               console.error("ç›£è½æ”¯å‡ºæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
               loadingStatusEl.textContent = 'æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚';
           });
       };

       /**
        * åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼å’Œèªè­‰
        */
       const initializeFirebase = async () => {
           if (!firebaseConfig) {
               console.error("Firebase Config éºå¤±ã€‚ç„¡æ³•åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ã€‚");
               loadingStatusEl.textContent = 'Firebase è¨­å®šéºå¤±ã€‚';
               return;
           }

           try {
               const app = initializeApp(firebaseConfig);
               db = getFirestore(app);
               auth = getAuth(app);

               loadingStatusEl.textContent = 'æ­£åœ¨é€²è¡Œä½¿ç”¨è€…èªè­‰...';

               // 1. èªè­‰æµç¨‹
               if (initialAuthToken) {
                   await signInWithCustomToken(auth, initialAuthToken);
               } else {
                   await signInAnonymously(auth);
               }

               // 2. è¨­å®šèªè­‰ç‹€æ…‹è§€å¯Ÿè€…
               onAuthStateChanged(auth, (user) => {
                   if (user) {
                       userId = user.uid;
                       isAuthReady = true;
                       
                       // è¨­å®š Firestore åƒè€ƒ
                       // è·¯å¾‘ï¼š /artifacts/{appId}/users/{userId}/expenses
                       expensesRef = collection(db, `artifacts/${appId}/users/${userId}/${EXPENSES_COLLECTION_NAME}`);
                       
                       // éš±è—è¼‰å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºç¸½è¦½
                       loadingStatusEl.classList.add('hidden');
                       summaryContentEl.classList.remove('hidden');

                       // 3. å•Ÿå‹•æ•¸æ“šç›£è½
                       subscribeToExpenses();
                       console.log(`Firebase åˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨è€…ID: ${userId}`);

                   } else {
                       // ä½¿ç”¨è€…ç™»å‡º (ä¸å¤ªæœƒåœ¨ Canvas ç™¼ç”Ÿ)
                       userId = null;
                       isAuthReady = false;
                       loadingStatusEl.textContent = 'ä½¿ç”¨è€…æœªç™»å…¥ã€‚';
                       summaryContentEl.classList.add('hidden');
                   }
               });
           } catch (error) {
               console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
               loadingStatusEl.textContent = `Firebase éŒ¯èª¤: ${error.code}`;
           }
       };


       // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---

       window.onload = function() {
           // æ¸²æŸ“å°èˆªçµæ§‹
           renderDayTabs();
           // åˆå§‹åŒ– Firebase
           initializeFirebase();
           // ç›£è½è¡¨å–®æäº¤äº‹ä»¶
           expenseForm.addEventListener('submit', handleAddExpense);
       };
   </script>
</body>
</html>