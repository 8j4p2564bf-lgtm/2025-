<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>é—œè¥¿äº”æ—¥éŠ - è¡Œç¨‹èˆ‡è¨˜å¸³æ•´åˆç‰ˆ (æ·±è‰²)</title>
   <!-- è¼‰å…¥ Tailwind CSS -->
   <script src="https://cdn.tailwindcss.com"></script>
   <!-- è¼‰å…¥ Inter å­—é«” -->
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
   <style>
       body {
           font-family: 'Inter', sans-serif;
           /* æ·±è‰²èƒŒæ™¯ */
           background-color: #1a202c; /* gray-900 */
       }
       /* éš±è—æ²è»¸ */
       .scroll-hidden::-webkit-scrollbar {
           display: none;
       }
       .scroll-hidden {
           -ms-overflow-style: none;
           scrollbar-width: none;
       }
       /* æå‡å­—é«”æ¸…æ™°åº¦ */
       .text-shadow-sm {
           text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
       }
       .itinerary-item {
           /* æ·±è‰²æ¨¡å¼ä¸‹çš„å·¦å´é‚Šç·šé¡è‰² */
           border-left: 3px solid #6366f1; /* indigo-500 */
           padding-left: 1rem;
       }
       /* èª¿æ•´è¼¸å…¥æ¡†çš„æ¨£å¼ä»¥é©æ‡‰æ·±è‰²æ¨¡å¼ */
       input[type="text"], input[type="number"], select {
           background-color: #2d3748; /* gray-700 */
           color: #e2e8f0; /* gray-200 */
           border-color: #4a5568; /* gray-600 */
       }
   </style>
</head>
<body>

   <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
   <div id="app" class="min-h-screen p-4 sm:p-6 md:p-8 text-gray-100">
       
       <!-- é ‚éƒ¨æ¦‚è¦½å¡ç‰‡ -->
       <div class="bg-gradient-to-r from-green-700 to-emerald-800 p-6 rounded-2xl shadow-2xl mb-6">
           <h1 class="text-3xl font-extrabold text-shadow-sm">ğŸ é—œè¥¿äº”æ—¥ãƒ»ç§‹æ—¥æ¼«éŠ</h1>
           <p class="text-gray-200 mt-1 text-sm font-medium">10/16 ~ 10/20 (5å¤©4å¤œ) | 4äººå®¶åº­æ—…è¡Œ</p>
           
           <!-- ä½å®¿èˆ‡èˆªç­å¿«é€Ÿæ‘˜è¦ -->
           <div class="mt-4 flex flex-wrap gap-4 text-xs font-semibold">
               <div class="flex items-center">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1 text-yellow-300">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125a3.375 3.375 0 003.375 3.375h1.5A1.5 1.5 0 0010.5 21v-3.75m-4.5-5.25v5.25c0 1.391-.84 2.55-1.95 2.55s-1.95-1.159-1.95-2.55v-5.25c0-1.391.84-2.55 1.95-2.55s1.95 1.159 1.95 2.55zM12 21.75V15m0 0a3 3 0 01-3-3V6a3 3 0 016 0v6a3 3 0 01-3 3zM15 15a3 3 0 003 3v3h-6v-3a3 3 0 003-3z" />
                   </svg>
                   <span>äº¬éƒ½: M's Hotel</span>
               </div>
               <div class="flex items-center">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1 text-yellow-300">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125a3.375 3.375 0 003.375 3.375h1.5A1.5 1.5 0 0010.5 21v-3.75m-4.5-5.25v5.25c0 1.391-.84 2.55-1.95 2.55s-1.95-1.159-1.95-2.55v-5.25c0-1.391.84-2.55 1.95-2.55s1.95 1.159 1.95 2.55zM12 21.75V15m0 0a3 3 0 01-3-3V6a3 3 0 016 0v6a3 3 0 01-3 3zM15 15a3 3 0 003 3v3h-6v-3a3 3 0 003-3z" />
                   </svg>
                   <span>å¤§é˜ª: Bridge Hotel</span>
               </div>
               <div class="flex items-center">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1 text-yellow-300">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.874L5.999 12zm0 0h7.5" />
                   </svg>
                   <span>å»ç¨‹: CI0152 (TPE 09:00 â†’ KIX 12:50)</span>
               </div>
           </div>

           <!-- ç¸½æ”¯å‡ºæ¦‚è¦½ -->
           <div id="loading-status" class="text-center mt-5 p-3 bg-white bg-opacity-10 rounded-lg">
               æ­£åœ¨åˆå§‹åŒ– Firebase æœå‹™...
           </div>
           <div id="summary-content" class="hidden mt-5">
               <p class="text-sm opacity-90 font-light">æœ¬æ¬¡æ—…è¡Œç¸½æ”¯å‡ºæ¦‚è¦½ (æ—¥åœ“)</p>
               <h2 id="total-trip-expense" class="text-4xl font-bold mt-1 text-shadow-sm">Â¥ 0</h2>
               <span class="inline-block text-xs mt-1 text-gray-300">ä½¿ç”¨è€… ID: <span id="user-id-display">N/A</span></span>
           </div>
       </div>

       <!-- æ—¥æœŸå°èˆªæ¨™ç±¤ -->
       <div class="flex overflow-x-auto scroll-hidden mb-6 p-2 bg-gray-800 rounded-xl shadow-lg">
           <!-- æ¯æ—¥å°èˆªæŒ‰éˆ•ï¼Œå°‡ç”± JS å¡«å…… -->
       </div>

       <!-- è¡Œç¨‹èˆ‡è¨˜å¸³ä¸»è¦å…§å®¹ (Grid Layout) -->
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

           <!-- å·¦å´ï¼šæ¯æ—¥è¡Œç¨‹å¤§ç¶±èˆ‡æ˜ç´° -->
           <div class="lg:col-span-2 space-y-6">
               <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                   <h2 class="text-2xl font-bold text-gray-100 mb-4 flex items-center">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2 text-green-400">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5" />
                       </svg>
                       <span id="itinerary-day-title">Day 1</span> è¡Œç¨‹è¦åŠƒ
                   </h2>
                   
                   <!-- ç•¶æ—¥è¡Œç¨‹å…§å®¹ -->
                   <div id="itinerary-content" class="text-gray-300 space-y-4">
                       <!-- è¡Œç¨‹å…§å®¹å°‡æ ¹æ“šé¸æ“‡çš„ Day é€²è¡Œæ›´æ–° -->
                   </div>
               </div>
               
               <!-- æ”¯å‡ºæ˜ç´°åˆ—è¡¨ -->
               <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                   <h2 class="text-2xl font-bold text-gray-100 mb-4 flex items-center">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2 text-indigo-400">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.03 60.03 0 0 1 9.75-2.25v-7.5l-3 2.25m3 5.25v5.25c.571 0 1.127-.123 1.648-.351l-.317-.118m-7.648.351A59.98 59.98 0 0 1 2.25 18.75m12.012 4.409-.323-.139A39.292 39.292 0 0 0 12 21.75V19.5m0-9.75v-2.25m0 0a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Z" />
                       </svg>
                       æ”¯å‡ºæ˜ç´°
                   </h2>
                   
                   <div class="mb-5 p-4 bg-indigo-900 rounded-xl border border-indigo-700">
                       <p class="text-sm font-medium text-indigo-300">ç•¶æ—¥ç¸½æ”¯å‡º</p>
                       <p id="daily-total" class="text-3xl font-bold text-indigo-100">Â¥ 0</p>
                   </div>

                   <ul id="expense-list" class="space-y-3">
                       <!-- æ”¯å‡ºé …ç›®å°‡ç”± JS è¼‰å…¥ -->
                       <li id="empty-state" class="text-center py-8 text-gray-500">
                           <p>é»æ“Šå³å´ã€Œ+ è¨˜éŒ„æ”¯å‡ºã€ä¾†è¨˜éŒ„ Day ${currentDayIndex} çš„ç¬¬ä¸€ç­†èŠ±è²»ã€‚</p>
                       </li>
                   </ul>
               </div>
           </div>

           <!-- å³å´ï¼šè¨˜å¸³åŠŸèƒ½å€å¡Š (Sticky for mobile) -->
           <div class="lg:col-span-1">
               <div class="bg-gray-800 p-6 rounded-2xl shadow-xl lg:sticky lg:top-8">
                   <h2 class="text-2xl font-bold text-gray-100 mb-4">
                       è¨˜å¸³æ–°å¢
                   </h2>

                   <!-- æ–°å¢æ”¯å‡ºè¡¨å–® -->
                   <form id="expense-form" class="space-y-4">
                       <input type="hidden" id="expense-day-index" value="1">

                       <!-- æ–°å¢ï¼šä»˜æ¬¾äººæ¬„ä½ -->
                       <div>
                           <label for="expense-payer" class="block text-sm font-medium text-gray-300">ä»˜æ¬¾äºº</label>
                           <select id="expense-payer" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-gray-700 text-white">
                               <option value="çˆ¸">çˆ¸</option>
                               <option value="åª½">åª½</option>
                               <option value="é€¸">é€¸</option>
                               <option value="æ¾">æ¾</option>
                           </select>
                       </div>
                       
                       <div>
                           <label for="expense-description" class="block text-sm font-medium text-gray-300">é …ç›®èªªæ˜</label>
                           <input type="text" id="expense-description" required placeholder="åˆé¤ã€äº¤é€šå¡ã€ç´€å¿µå“"
                               class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">
                       </div>
                       
                       <div>
                           <label for="expense-amount" class="block text-sm font-medium text-gray-300">é‡‘é¡ (æ—¥åœ“ Â¥)</label>
                           <input type="number" id="expense-amount" required min="1" placeholder="ä¾‹å¦‚ï¼š2500"
                               class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">
                       </div>

                       <div>
                           <label for="expense-category" class="block text-sm font-medium text-gray-300">é¡åˆ¥</label>
                           <select id="expense-category" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-gray-700 text-white">
                               <option value="é¤é£²">ğŸœ é¤é£²</option>
                               <option value="äº¤é€š">ğŸš„ äº¤é€š</option>
                               <option value="ä½å®¿">ğŸ¨ ä½å®¿</option>
                               <option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨/å¨›æ¨‚</option>
                               <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©/ç´€å¿µå“</option>
                               <option value="å…¶ä»–">ğŸ·ï¸ å…¶ä»–</option>
                           </select>
                       </div>

                       <button type="submit" id="add-expense-btn"
                           class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50">
                           + è¨˜éŒ„æ”¯å‡º
                       </button>
                   </form>
               </div>
           </div>
       </div>
   </div>


   <!-- Firebase è…³æœ¬ -->
   <script type="module">
       // Firebase æ¨¡çµ„è¼‰å…¥
       import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
       import {
           getAuth,
           signInAnonymously,
           signInWithCustomToken,
           onAuthStateChanged
       } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       import {
           getFirestore,
           doc,
           addDoc,
           onSnapshot,
           collection,
           query,
           deleteDoc,
           orderBy,
           serverTimestamp,
           setLogLevel
       } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // è¨­å®š Firebase Log Level
       setLogLevel('debug');
       
       // --- å…¨åŸŸè®Šæ•¸åˆå§‹åŒ– (ä¾†è‡ª Canvas ç’°å¢ƒ) ---
       const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
       const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
       const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

       let db;
       let auth;
       let userId = null;
       let isAuthReady = false;
       
       // Firestore Collection è·¯å¾‘
       const EXPENSES_COLLECTION_NAME = "expenses";
       let expensesRef = null;

       const TOTAL_DAYS = 5;
       let currentDayIndex = 1; // é è¨­é¡¯ç¤º Day 1
       let allExpenses = []; // å„²å­˜æ‰€æœ‰æ”¯å‡ºæ•¸æ“š

       // å…ƒç´ åƒç…§
       const loadingStatusEl = document.getElementById('loading-status');
       const summaryContentEl = document.getElementById('summary-content');
       const totalTripExpenseEl = document.getElementById('total-trip-expense');
       const dayTabsContainer = document.querySelector('.flex.overflow-x-auto');
       const itineraryDayTitleEl = document.getElementById('itinerary-day-title');
       const dailyTotalEl = document.getElementById('daily-total');
       const expenseForm = document.getElementById('expense-form');
       const expenseListEl = document.getElementById('expense-list');
       const expenseDayIndexInput = document.getElementById('expense-day-index');
       const addExpenseBtn = document.getElementById('add-expense-btn');
       const userIdDisplayEl = document.getElementById('user-id-display');

       // --- è¼”åŠ©å‡½æ•¸ ---

       /**
        * å°‡æ•¸å­—æ ¼å¼åŒ–ç‚ºæ—¥åœ“å­—ä¸²
        * @param {number} amount
        * @returns {string}
        */
       const formatCurrency = (amount) => {
           return `Â¥ ${Math.floor(amount).toLocaleString('ja-JP')}`;
       };

       /**
        * æ ¹æ“šé¡åˆ¥å›å‚³è¡¨æƒ…ç¬¦è™Ÿ
        * @param {string} category
        * @returns {string}
        */
       const getCategoryIcon = (category) => {
           switch (category) {
               case 'é¤é£²': return 'ğŸœ';
               case 'äº¤é€š': return 'ğŸš„';
               case 'ä½å®¿': return 'ğŸ¨';
               case 'é–€ç¥¨': return 'ğŸŸï¸';
               case 'è³¼ç‰©': return 'ğŸ›ï¸';
               case 'å…¶ä»–': return 'ğŸ·ï¸';
               default: return 'ğŸ’°';
           }
       };

       // --- æ¸²æŸ“å‡½æ•¸ ---
       
       /**
        * æ¸²æŸ“å–®ä¸€æ”¯å‡ºé …ç›®
        * @param {object} expense
        * @returns {string} HTML
        */
       const renderExpenseItem = (expense) => {
           const icon = getCategoryIcon(expense.category);
           // æ”¯å‡ºæ˜ç´°é …ç›®æ¡ç”¨æ·±è‰²é…è‰²
           return `
               <li data-id="${expense.id}" class="flex justify-between items-center p-3 bg-gray-700 rounded-lg shadow-sm border border-gray-600 hover:bg-gray-600 transition duration-150">
                   <div class="flex items-center">
                       <span class="text-xl mr-3">${icon}</span>
                       <div>
                           <p class="font-semibold text-gray-100">${expense.description}</p>
                           <!-- é¡¯ç¤ºä»˜æ¬¾äººå’Œé¡åˆ¥ -->
                           <p class="text-xs text-gray-400">${expense.category} | ä»˜æ¬¾äºº: ${expense.payer || 'æœªçŸ¥'}</p>
                       </div>
                   </div>
                   <div class="flex items-center space-x-2">
                       <span class="text-lg font-bold text-red-400">${formatCurrency(expense.amount)}</span>
                       <button onclick="deleteExpense('${expense.id}')"
                               class="p-1 text-gray-400 hover:text-red-300 rounded-full transition duration-150"
                               aria-label="åˆªé™¤é …ç›®">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                             <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.166 2.008-5.32c.162-.43.206-.867.144-1.272a.75.75 0 0 0-.96-.705L18.15 3.12l.142.378M18.15 3.12l-1.42 3.774M18.15 3.12 15.65 6.894" />
                           </svg>
                       </button>
                   </div>
               </li>
           `;
       };
       
       /**
        * æ¸²æŸ“æ¯æ—¥è¡Œç¨‹å…§å®¹
        */
       const renderItineraryContent = (dayIndex) => {
           const itineraryContentEl = document.getElementById('itinerary-content');
           let content = '';

           const itineraryDetails = {
               1: {
                   date: "10/16 (ä¸‰) | æŠµé”æ—¥",
                   title: "äº¬éƒ½åˆé«”é©—ï¼šæ©Ÿå ´è‡³é£¯åº—",
                   items: [
                       { time: "09:00", desc: "å°ç£æ¡ƒåœ’æ©Ÿå ´ (TPE) é›†åˆï¼Œæ­ä¹˜ CI0152 å•Ÿç¨‹ã€‚" },
                       { time: "12:50", desc: "æŠµé”é—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX)ï¼Œè¾¦ç†å…¥å¢ƒæ‰‹çºŒèˆ‡é ˜å–è¡Œæã€‚" },
                       { time: "14:00", desc: "è³¼è²· ICOCA æˆ– JR Haruka ç‰¹å¿«è»Šç¥¨ï¼Œæ­ä¹˜å‰å¾€äº¬éƒ½ã€‚" },
                       { time: "16:00", desc: "æŠµé” **M's Hotel (äº¬éƒ½)**ï¼Œè¾¦ç†å…¥ä½ä¸¦ç¨ä½œä¼‘æ¯ã€‚" },
                       { time: "18:30", desc: "æ™šé¤ï¼šåœ¨äº¬éƒ½è»Šç«™å‘¨é‚Šä¼Šå‹¢ä¸¹ç™¾è²¨æˆ–æ‹‰éºµå°è·¯è¦“é£Ÿã€‚" }
                   ]
               },
               2: {
                   date: "10/17 (å››) | äº¬éƒ½æ–‡åŒ–æ—¥",
                   title: "æ¸…æ°´å¯ºèˆ‡åƒæœ¬é³¥å±…æ·±åº¦éŠ",
                   items: [
                       { time: "09:00", desc: "å‰å¾€**æ¸…æ°´å¯º (Kiyomizu-dera)**ï¼Œæ¬£è³ç§‹æ—¥æ¥“è‘‰æ™¯è‰²ã€‚" },
                       { time: "11:00", desc: "æ¼«æ­¥**äºŒå¹´å‚ã€ä¸‰å¹´å‚**ï¼Œäº«å—å‚³çµ±æ—¥å¼è¡—é“æ°›åœï¼Œè³¼è²·ç´€å¿µå“ã€‚" },
                       { time: "13:00", desc: "åˆé¤ï¼šç¥‡åœ’é™„è¿‘ï¼Œå˜—è©¦æ¹¯è±†è…æˆ–è•éº¥éºµã€‚" },
                       { time: "15:00", desc: "åƒè§€**ä¼è¦‹ç¨»è·å¤§ç¤¾ (Fushimi Inari-taisha)**ï¼ŒæŒ‘æˆ°åƒæœ¬é³¥å±…ã€‚" },
                       { time: "18:30", desc: "æ™šé¤ï¼šæ¢ç´¢å…ˆæ–—ç”ºæˆ–éŒ¦å¸‚å ´å‘¨é‚Šçš„ç‰¹è‰²å±…é…’å±‹ã€‚" }
                   ]
               },
               3: {
                   date: "10/18 (äº”) | è½‰ç§»èˆ‡å¤§é˜ªåŸ",
                   title: "å¾äº¬éƒ½åˆ°å¤§é˜ªï¼šéƒ½æœƒè½‰æ›",
                   items: [
                       { time: "09:00", desc: "è¾¦ç†äº¬éƒ½é£¯åº—é€€æˆ¿æ‰‹çºŒï¼Œæ­ä¹˜ JR å¿«é€Ÿæˆ–æ–°å¹¹ç·šå‰å¾€å¤§é˜ªã€‚" },
                       { time: "11:30", desc: "æŠµé”å¤§é˜ªï¼Œåˆé¤æ–¼é›£æ³¢æˆ–å¿ƒé½‹æ©‹å‘¨é‚Šã€‚" },
                       { time: "14:00", desc: "æŠµé” **Bridge Hotel (å¤§é˜ª)**ï¼Œè¾¦ç†å…¥ä½æ‰‹çºŒã€‚" },
                       { time: "15:30", desc: "å‰å¾€**å¤§é˜ªåŸå…¬åœ’**ï¼Œåƒè§€å¤©å®ˆé–£åŠæ­·å²éºè·¡ã€‚" },
                       { time: "19:00", desc: "æ™šé¤ï¼š**é“é “å € (Dotonbori)**ï¼Œå“åšç« é­šç‡’ã€å¤§é˜ªç‡’å’Œè‘—åçš„ã€Œå›ºåŠ›æœè·‘è·‘äººã€å¤œæ™¯ã€‚" }
                   ]
               },
               4: {
                   date: "10/19 (å…­) | å¤§é˜ªæ·±åº¦æ¢ç´¢",
                   title: "ç¾é£Ÿã€è³¼ç‰©èˆ‡æ–°ä¸–ç•Œæ‡·èˆŠ",
                   items: [
                       { time: "09:30", desc: "**å¿ƒé½‹æ©‹ç­‹å•†åº—è¡— (Shinsaibashisuji)** è‡ªç”±è³¼ç‰©ï¼Œäº«å—å¤§é˜ªçš„è³¼ç‰©æ¨‚è¶£ã€‚" },
                       { time: "12:30", desc: "åˆé¤ï¼š**é»‘é–€å¸‚å ´ (Kuromon Market)**ï¼Œå“åšæ–°é®®æµ·ç”¢å’Œåœ¨åœ°å°åƒã€‚" },
                       { time: "15:00", desc: "å‰å¾€æ‡·èˆŠçš„**æ–°ä¸–ç•Œå€**ï¼Œåƒè§€**é€šå¤©é–£ (Tsutenkaku)**ã€‚" },
                       { time: "18:00", desc: "æ™šé¤ï¼šåœ¨æ¢…ç”°åœ°å€æˆ–é£¯åº—é™„è¿‘ç”¨é¤ã€‚" },
                       { time: "20:00", desc: "å¤œæ™¯ï¼š**æ¢…ç”°ç©ºä¸­åº­åœ’å±•æœ›å° (Umeda Sky Building)**ï¼Œæ¬£è³å¤§é˜ªç’€ç’¨å¤œæ™¯ã€‚" }
                   ]
               },
               5: {
                   date: "10/20 (æ—¥) | è³¦æ­¸æ—¥",
                   title: "æœ€çµ‚å·¡ç¦®èˆ‡è¿”ç¨‹",
                   items: [
                       { time: "09:00", desc: "åœ¨é£¯åº—é™„è¿‘é€²è¡Œæœ€å¾Œçš„è³¼ç‰©æˆ–è³¼è²·ä¼´æ‰‹ç¦®ã€‚" },
                       { time: "11:00", desc: "è¾¦ç†é€€æˆ¿æ‰‹çºŒï¼Œæº–å‚™å‰å¾€é—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX)ã€‚" },
                       { time: "12:00", desc: "åˆé¤ï¼šæ©Ÿå ´æˆ–è·¯é€”ä¸Šå¿«é€Ÿç”¨é¤ã€‚" },
                       { time: "14:00", desc: "æ­ä¹˜ CI0153 èˆªç­ï¼Œå¾ KIX é£›å¾€å°åŒ— (TPE)ã€‚" }
                   ]
               }
           };

           const dayData = itineraryDetails[dayIndex];
           
           if (dayData) {
               itineraryDayTitleEl.textContent = `Day ${dayIndex} - ${dayData.date}`;
               
               const itemsHtml = dayData.items.map(item => `
                   <div class="itinerary-item">
                       <p class="text-lg font-bold text-gray-50">${item.time}</p>
                       <p class="text-base text-gray-300">${item.desc}</p>
                   </div>
               `).join('');

               content = `<p class="font-semibold text-xl text-green-400 mb-3">${dayData.title}</p>
                          <div class="space-y-4">${itemsHtml}</div>`;
           } else {
               itineraryDayTitleEl.textContent = `Day ${dayIndex} - å°šæœªè¦åŠƒ`;
               content = '<p class="text-gray-500 italic">æ­¤æ—¥å°šæœªæœ‰è©³ç´°è¡Œç¨‹è¦åŠƒã€‚è«‹ä½¿ç”¨ä¸Šæ–¹åŠŸèƒ½æ–°å¢ã€‚</p>';
           }


           itineraryContentEl.innerHTML = content;
       };


       /**
        * æ ¹æ“š currentDayIndex æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨èˆ‡ç¸½è¨ˆ
        */
       const renderExpenses = () => {
           const dailyExpenses = allExpenses.filter(exp => exp.dayIndex === currentDayIndex);
           
           // è¨ˆç®—ç•¶æ—¥ç¸½é¡
           const dailyTotal = dailyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
           dailyTotalEl.textContent = formatCurrency(dailyTotal);
           
           // æ¸²æŸ“åˆ—è¡¨
           if (dailyExpenses.length === 0) {
               expenseListEl.innerHTML = `
                   <li class="text-center py-8 text-gray-500">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mx-auto mb-2 text-gray-600">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.03 60.03 0 0 1 9.75-2.25v-7.5l-3 2.25m3 5.25v5.25c.571 0 1.127-.123 1.648-.351l-.317-.118m-7.648.351A59.98 59.98 0 0 1 2.25 18.75m12.012 4.409-.323-.139A39.292 39.292 0 0 0 12 21.75V19.5m0-9.75v-2.25m0 0a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Z" />
                       </svg>
                       <p>é»æ“Šå³å´ã€Œ+ è¨˜éŒ„æ”¯å‡ºã€ä¾†è¨˜éŒ„ Day ${currentDayIndex} çš„ç¬¬ä¸€ç­†èŠ±è²»ã€‚</p>
                   </li>
               `;
           } else {
               expenseListEl.innerHTML = dailyExpenses.map(renderExpenseItem).join('');
           }

           // æ›´æ–°ç¸½è¦½
           const totalTrip = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
           totalTripExpenseEl.textContent = formatCurrency(totalTrip);

           // æ›´æ–° Day æ¨™é¡Œ (è¨˜å¸³è¡¨å–®çš„éš±è—æ¬„ä½)
           expenseDayIndexInput.value = currentDayIndex;

           // æ›´æ–°å°èˆªæ¨™ç±¤ä¸Šçš„ç¸½é¡é¡¯ç¤º
           updateDayTabTotals();
       };

       /**
        * æ›´æ–°å°èˆªæ¨™ç±¤ä¸Šçš„ç¸½é¡é¡¯ç¤º
        */
       const updateDayTabTotals = () => {
           const dayTotals = {};
           for (let i = 1; i <= TOTAL_DAYS; i++) {
               dayTotals[i] = allExpenses
                   .filter(exp => exp.dayIndex === i)
                   .reduce((sum, exp) => sum + exp.amount, 0);
           }

           for (let i = 1; i <= TOTAL_DAYS; i++) {
               const dayTabEl = document.getElementById(`day-tab-${i}`);
               if (dayTabEl) {
                   const total = dayTotals[i];
                   dayTabEl.innerHTML = `
                       Day ${i}
                       <span class="text-xs ml-1 font-normal ${total > 0 ? 'text-red-300' : 'text-gray-400'}">
                           ${total > 0 ? formatCurrency(total) : formatCurrency(0)}
                       </span>
                   `;
                   
                   // æ›´æ–°æ´»èºç‹€æ…‹
                   if (i === currentDayIndex) {
                       dayTabEl.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                       dayTabEl.classList.remove('bg-gray-700', 'text-indigo-300', 'hover:bg-indigo-500/20', 'shadow-sm');
                   } else {
                       dayTabEl.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                       dayTabEl.classList.add('bg-gray-700', 'text-indigo-300', 'hover:bg-indigo-500/20', 'shadow-sm');
                   }
               }
           }
       };

       /**
        * æ¸²æŸ“æ¯æ—¥è¡Œç¨‹å°èˆªæ¨™ç±¤
        */
       const renderDayTabs = () => {
           let html = '';
           for (let i = 1; i <= TOTAL_DAYS; i++) {
               html += `
                   <button id="day-tab-${i}" onclick="selectDay(${i})"
                           class="flex-shrink-0 px-4 py-2 font-semibold rounded-lg transition duration-150 ease-in-out whitespace-nowrap text-indigo-300 bg-gray-700 hover:bg-indigo-500/20 shadow-sm border border-gray-600 mr-2 last:mr-0">
                       Day ${i}
                       <span class="text-xs ml-1 font-normal text-gray-400">${formatCurrency(0)}</span>
                   </button>
               `;
           }
           dayTabsContainer.innerHTML = html;
           // åˆå§‹é¸ä¸­ Day 1
           selectDay(currentDayIndex);
       };

       // --- äº‹ä»¶è™•ç†èˆ‡é‚è¼¯ ---

       /**
        * é¸æ“‡ç‰¹å®šçš„æ—…è¡Œæ—¥
        * @param {number} dayIndex
        */
       window.selectDay = (dayIndex) => {
           currentDayIndex = dayIndex;
           renderExpenses(); // é‡æ–°æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨å’Œç¸½é¡
           renderItineraryContent(dayIndex); // é‡æ–°æ¸²æŸ“è¡Œç¨‹å…§å®¹
       };
       
       /**
        * å¾ Firestore åˆªé™¤æ”¯å‡ºé …ç›®
        * @param {string} expenseId
        */
       window.deleteExpense = async (expenseId) => {
           if (!isAuthReady) {
               console.error('Firebase Auth not ready.');
               return;
           }
           
           try {
               // ç¢ºèªè·¯å¾‘æ­£ç¢º
               const expenseDocRef = doc(expensesRef, expenseId);
               await deleteDoc(expenseDocRef);
               // onSnapshot æœƒè‡ªå‹•æ›´æ–° UI
               console.log(`Expense ${expenseId} deleted.`);
           } catch (e) {
               console.error("åˆªé™¤æ”¯å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
           }
       };


       /**
        * è™•ç†è¡¨å–®æäº¤ï¼Œæ–°å¢æ”¯å‡º
        * @param {Event} e
        */
       const handleAddExpense = async (e) => {
           e.preventDefault();
           if (!isAuthReady) {
               console.error('Firebase Auth not ready.');
               return;
           }

           // æ–°å¢ï¼šè®€å–ä»˜æ¬¾äºº
           const payer = document.getElementById('expense-payer').value;
           const description = document.getElementById('expense-description').value.trim();
           const amount = parseFloat(document.getElementById('expense-amount').value);
           const category = document.getElementById('expense-category').value;
           const dayIndex = parseInt(document.getElementById('expense-day-index').value);

           if (!description || isNaN(amount) || amount <= 0 || !category || !payer) {
               console.warn("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºä¿é‡‘é¡æœ‰æ•ˆã€‚");
               return;
           }
           
           addExpenseBtn.disabled = true;
           addExpenseBtn.textContent = 'è¨˜éŒ„ä¸­...';

           try {
               await addDoc(expensesRef, {
                   dayIndex: dayIndex,
                   description: description,
                   amount: amount,
                   category: category,
                   payer: payer, // æ–°å¢ï¼šå„²å­˜ä»˜æ¬¾äºº
                   createdAt: serverTimestamp(),
                   userId: userId
               });
               
               // æ¸…ç©ºè¡¨å–®
               expenseForm.reset();
               // ç¢ºä¿ä»˜æ¬¾äººä¸‹æ‹‰é¸å–®ç¶­æŒåœ¨é è¨­å€¼
               document.getElementById('expense-payer').value = 'çˆ¸';
           } catch (e) {
               console.error("æ–°å¢æ”¯å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
           } finally {
               addExpenseBtn.disabled = false;
               addExpenseBtn.textContent = '+ è¨˜éŒ„æ”¯å‡º';
           }
       };

       // --- Firebase æ ¸å¿ƒå‡½æ•¸ ---

       /**
        * ç›£è½ Firestore ä¸­çš„æ”¯å‡ºæ•¸æ“š
        */
       const subscribeToExpenses = () => {
           // æŸ¥è©¢ï¼šæŒ‰å»ºç«‹æ™‚é–“æ’åº
           const q = query(expensesRef, orderBy("createdAt", "desc"));

           // è¨­å®šå³æ™‚ç›£è½å™¨
           onSnapshot(q, (snapshot) => {
               allExpenses = snapshot.docs.map(doc => ({
                   id: doc.id,
                   ...doc.data(),
                   // ç¢ºä¿ amount æ˜¯æ•¸å­—ï¼ŒdayIndex æ˜¯æ•¸å­—
                   amount: parseFloat(doc.data().amount || 0),
                   dayIndex: parseInt(doc.data().dayIndex || 1),
                   payer: doc.data().payer || 'æœªçŸ¥' // ç¢ºä¿æœ‰ payer æ¬„ä½
               }));
               
               // æ¸²æŸ“æ‰€æœ‰ç›¸é—œ UI
               renderExpenses();
           }, (error) => {
               console.error("ç›£è½æ”¯å‡ºæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
               loadingStatusEl.textContent = 'æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚';
           });
       };

       /**
        * åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼å’Œèªè­‰
        */
       const initializeFirebase = async () => {
           if (!firebaseConfig) {
               console.error("Firebase Config éºå¤±ã€‚ç„¡æ³•åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ã€‚");
               loadingStatusEl.textContent = 'Firebase è¨­å®šéºå¤±ã€‚';
               return;
           }

           try {
               const app = initializeApp(firebaseConfig);
               db = getFirestore(app);
               auth = getAuth(app);

               loadingStatusEl.textContent = 'æ­£åœ¨é€²è¡Œä½¿ç”¨è€…èªè­‰...';

               // 1. èªè­‰æµç¨‹
               if (initialAuthToken) {
                   await signInWithCustomToken(auth, initialAuthToken);
               } else {
                   await signInAnonymously(auth);
               }

               // 2. è¨­å®šèªè­‰ç‹€æ…‹è§€å¯Ÿè€…
               onAuthStateChanged(auth, (user) => {
                   if (user) {
                       userId = user.uid;
                       isAuthReady = true;
                       
                       // è¨­å®š Firestore åƒè€ƒ
                       // è·¯å¾‘ï¼š /artifacts/{appId}/users/{userId}/expenses
                       expensesRef = collection(db, `artifacts/${appId}/users/${userId}/${EXPENSES_COLLECTION_NAME}`);
                       
                       // éš±è—è¼‰å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºç¸½è¦½
                       loadingStatusEl.classList.add('hidden');
                       summaryContentEl.classList.remove('hidden');
                       userIdDisplayEl.textContent = userId; // é¡¯ç¤ºç”¨æˆ¶ ID

                       // 3. å•Ÿå‹•æ•¸æ“šç›£è½
                       subscribeToExpenses();
                       console.log(`Firebase åˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨è€…ID: ${userId}`);

                   } else {
                       // ä½¿ç”¨è€…ç™»å‡º (ä¸å¤ªæœƒåœ¨ Canvas ç™¼ç”Ÿ)
                       userId = null;
                       isAuthReady = false;
                       loadingStatusEl.textContent = 'ä½¿ç”¨è€…æœªç™»å…¥ã€‚';
                       summaryContentEl.classList.add('hidden');
                   }
               });
           } catch (error) {
               console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
               loadingStatusEl.textContent = `Firebase éŒ¯èª¤: ${error.code}`;
           }
       };


       // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---

       window.onload = function() {
           // æ¸²æŸ“å°èˆªçµæ§‹
           renderDayTabs();
           // åˆå§‹åŒ– Firebase
           initializeFirebase();
           // ç›£è½è¡¨å–®æäº¤äº‹ä»¶
           expenseForm.addEventListener('submit', handleAddExpense);
       };
   </script>
</body>
</html>