<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>äº¬éƒ½ç™½èŒ¶ï¼ç²¾ç·»æ—…éŠæ‰‹å†Š (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'wood-bg': 'var(--bg-color)',
              'wood-card': 'var(--card-color)',
              'wood-border': 'var(--border-color)',
              'wood-accent': 'var(--accent-color)',
              'wood-text': 'var(--text-color)',
              'wood-muted': 'var(--muted-color)',
            },
            fontFamily: {
              sans: ['Noto Sans TC', 'sans-serif'],
              serif: ['Playfair Display', 'serif'],
            },
            animation: {
              'fade-in': 'fadeIn 0.8s ease-out',
              'slide-up': 'slideUp 0.6s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(20px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              }
            }
          }
        }
      }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <style>
      /* Themes Variables */
      :root {
        --bg-color: #F7F5F0;
        --card-color: #FFFFFF;
        --border-color: #E6E2DE;
        --accent-color: #9C824A;
        --text-color: #332F2C;
        --muted-color: #85807C;
      }
      
      [data-theme="sakura"] {
        --bg-color: #FFF0F5;
        --card-color: #FFFFFF;
        --border-color: #FFD1DC;
        --accent-color: #DB7093;
        --text-color: #5C3A45;
        --muted-color: #A87CA0;
      }

      [data-theme="matcha"] {
        --bg-color: #F0FFF4;
        --card-color: #FFFFFF;
        --border-color: #C6F6D5;
        --accent-color: #38A169;
        --text-color: #22543D;
        --muted-color: #68D391;
      }

      [data-theme="ocean"] {
        --bg-color: #F0F9FF;
        --card-color: #FFFFFF;
        --border-color: #BAE6FD;
        --accent-color: #0284C7;
        --text-color: #0C4A6E;
        --muted-color: #7DD3FC;
      }

      body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-color); -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
      
      /* Scrollbar Styling */
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
      
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      /* Loading Animation */
      .loading-spinner {
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--accent-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      /* Mobile Optimization */
      input, select, textarea { font-size: 16px !important; } 
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "@google/genai": "https://esm.sh/@google/genai",
        "firebase/app": "https://esm.sh/firebase@10.8.0/app",
        "firebase/database": "https://esm.sh/firebase@10.8.0/database"
      }
    }
    </script>
</head>
<body>
    <div id="error-container" style="display:none; padding: 20px; color: white; background: #ef4444; margin: 20px; border-radius: 8px; font-size: 14px; line-height: 1.5;"></div>

    <div id="root">
        <div class="flex flex-col items-center justify-center min-h-screen text-wood-muted bg-wood-bg">
            <div class="loading-spinner mb-4"></div>
            <p class="font-serif italic tracking-widest text-sm">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            const container = document.getElementById('error-container');
            if(container) {
                container.style.display = 'block';
                container.innerHTML = `<strong>æ‡‰ç”¨ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤</strong><br/>è«‹å˜—è©¦é‡æ–°æ•´ç†é é¢ã€‚<br/><br/><small>${msg}</small>`;
            }
            return false;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            CloudSun, Plane, Hotel, Coins, CheckCircle2, MapPin, X, 
            Utensils, Train, Camera, ShoppingBag, Home, Info, 
            MessageCircle, Send, Sparkles, Map, Loader2, Settings, Plus, Trash2, Save, RotateCcw,
            ArrowUp, ArrowDown, Calculator, Calendar as CalendarIcon, Languages, Palette, Wand2, RefreshCw
        } from 'lucide-react';
        import { GoogleGenAI } from "@google/genai";
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, onValue, set } from "firebase/database";

        // ==========================================
        // âš ï¸ è«‹å¡«å¯«æ‚¨çš„ Gemini API Key
        // ==========================================
        const API_KEY = "AIzaSyCpomsc_YHhgkmqjgHI4z5Q9yfC_9QoFzw"; 
        
        // ==========================================
        // ğŸ”´ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Firebase Config ğŸ”´
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDoaj7Ucvs44nRHHTDN4QJ3PrClGSlCxG0",
            authDomain: "trip-2bb34.firebaseapp.com",
            databaseURL: "https://trip-2bb34-default-rtdb.firebaseio.com",
            projectId: "trip-2bb34",
            storageBucket: "trip-2bb34.firebasestorage.app",
            messagingSenderId: "474424851920",
            appId: "1:474424851920:web:5a375acca86d3505ae0dd5",
            measurementId: "G-X937LTZ2E2"
        };

        // Firebase Init
        let db = null;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase initialized");
        } catch(e) {
            console.error("Firebase init failed:", e);
        }

        // é è¨­è³‡æ–™ (å®Œæ•´ç‰ˆ)
        const DEFAULT_DATA = {
            theme: 'default',
            tripName: "äº¬éƒ½ãƒ»å¤§é˜ª",
            tripDate: "2024.10.16 â€” 10.20",
            apiKey: API_KEY, 
            flights: [
                { airline: 'ä¸­è¯èˆªç©º', flightNo: 'CI0152', date: '10/16 (å››)', route: 'TPE -> KIX', dep: '09:00', arr: '12:50' },
                { airline: 'ä¸­è¯èˆªç©º', flightNo: 'CI0153', date: '10/20 (ä¸€)', route: 'KIX -> TPE', dep: '14:00', arr: '15:55' }
            ],
            preparation: [
                { title: "è­·ç…§", desc: "æª¢æŸ¥æœ‰æ•ˆæœŸé™æ˜¯å¦è¶…é 6 å€‹æœˆã€‚" },
                { title: "Visit Japan Web", desc: "æå‰å¡«å¯«å…¥å¢ƒå¯©æŸ¥èˆ‡æµ·é—œç”³å ±ï¼Œæˆªåœ– QR Codeã€‚" },
                { title: "æ—¥å¹£ç¾é‡‘", desc: "å»ºè­°æ”œå¸¶ç´„ Â¥50,000 - Â¥80,000 / äºº (è¦–è³¼ç‰©éœ€æ±‚)ã€‚" },
                { title: "ç¶²å¡ / Roaming", desc: "ç¢ºèª SIM å¡æˆ–æ¼«éŠå·²é–‹é€šã€‚" },
                { title: "äº¤é€šå¡ (ICOCA/Suica)", desc: "åŠ å…¥ Apple Pay æˆ–æº–å‚™å¯¦é«”å¡ã€‚" },
                { title: "å……é›»è¨­å‚™", desc: "è¡Œå‹•é›»æºã€å……é›»ç·š (æ—¥æœ¬é›»å£“ 100Vï¼Œæ’åº§èˆ‡å°ç£ç›¸åŒ)ã€‚" },
                { title: "å¸¸å‚™è—¥å“", desc: "æ„Ÿå†’è—¥ã€è…¸èƒƒè—¥ã€æ­¢ç—›è—¥ã€OKç¹ƒã€‚" }
            ],
            itinerary: [
                {
                    id: 'day1', date: '10/16 (å››)', title: 'ç¬¬ä¸€å¤©ï¼šäº¬éƒ½åˆå°è±¡',
                    items: [
                        { time: '05:30', title: 'å‡ºç™¼å‰å¾€æ©Ÿå ´', location: 'ç«¹åŒ— -> æ¡ƒæ©Ÿ2èˆªå»ˆ', type: 'transport', cost: 'ç¾é‡‘ 1500', description: 'æº–æ™‚å‡ºç™¼ï¼Œæª¢æŸ¥è­·ç…§ã€æ—¥å¹£ã€ç¶²å¡ã€‚' },
                        { time: '09:00', title: 'æ­ä¹˜ç­æ©Ÿ CI0152', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´', type: 'flight', description: 'é£›å¾€é—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX)ã€‚' },
                        { time: '13:00', title: 'æŠµé”é—œè¥¿æ©Ÿå ´', location: 'KIX', type: 'transport', description: 'è¾¦ç†å…¥å¢ƒæ‰‹çºŒï¼Œé ˜å–è¡Œæã€‚' },
                        { time: '14:00', title: 'æ­ä¹˜ Haruka ç‰¹æ€¥', location: 'é—œè¥¿æ©Ÿå ´ -> äº¬éƒ½è»Šç«™', type: 'transport', cost: 'Â¥2,200', description: 'ä½¿ç”¨ JR Pass æˆ–é è³¼ç¥¨åˆ¸ï¼Œç´„ 75 åˆ†é˜è»Šç¨‹ã€‚' },
                        { time: '15:30', title: 'é£¯åº— Check-in', location: "Hotel The Mâ€™s Kyoto", type: 'hotel', mapQuery: "Hotel The Mâ€™s Kyoto", description: 'æ™‚å°šè¨­è¨ˆé¢¨æ ¼é£¯åº—ï¼Œä½æ–¼äº¬éƒ½è»Šç«™é™„è¿‘ï¼Œäº¤é€šä¾¿åˆ©ã€‚' },
                        { time: '16:10', title: 'åµå±±æ¸¡æœˆæ©‹ã€ç«¹æ—å°å¾‘', location: 'åµå±±', type: 'activity', cost: 'å…è²»', mapQuery: 'Arashiyama Bamboo Grove', description: 'äº¬éƒ½å¿…è¨ªæ™¯é»ï¼Œæ„Ÿå—ç«¹æ—å¹½éœèˆ‡æ¸¡æœˆæ©‹çš„é–‹é—Šã€‚' },
                        { time: '18:00', title: 'åµå±±æœˆç‡ˆè·¯', location: 'åµå±±', type: 'activity', description: 'æ¬£è³å¤œæ™šçš„ç‡ˆå…‰è—è¡“ï¼ˆå­£ç¯€é™å®šæ´»å‹•ï¼‰ã€‚' },
                        { time: '19:30', title: 'æ™šé¤ / ä¼‘æ¯', location: 'äº¬éƒ½è»Šç«™å‘¨é‚Š', type: 'food', description: 'è¿”å›é£¯åº—é™„è¿‘äº«ç”¨æ™šé¤ã€‚' }
                    ]
                },
                {
                    id: 'day2', date: '10/17 (äº”)', title: 'ç¬¬äºŒå¤©ï¼šå¤éƒ½é¢¨æƒ…',
                    items: [
                        { time: '08:30', title: 'é£¯åº—å‡ºç™¼', location: 'å‰å¾€äº”æ¡å‚', type: 'transport', description: 'æ­ä¹˜å¸‚å·´å£«å‰å¾€æ¸…æ°´å¯ºå€åŸŸã€‚' },
                        { time: '09:30', title: 'æ¸…æ°´å¯º & äºŒä¸‰å¹´å‚', location: 'æ¸…æ°´å¯º', type: 'activity', cost: 'é–€ç¥¨ Â¥500', mapQuery: 'Kiyomizu-dera', description: 'ä¸–ç•Œéºç”¢æ¸…æ°´èˆå°ï¼Œæ±‚å§»ç·£çš„åœ°ä¸»ç¥ç¤¾ï¼Œæ¼«æ­¥å¤è‰²å¤é¦™çš„å‚é“ã€‚' },
                        { time: '11:40', title: 'å…«å‚ç¥ç¤¾ & èŠ±è¦‹å°è·¯', location: 'å…«å‚ç¥ç¤¾', type: 'activity', cost: 'å…è²»', mapQuery: 'Yasaka Shrine', description: 'äº¬éƒ½ç¥‡åœ’çš„å®ˆè­·ç¥ç¤¾ï¼Œæ¥è‘—æ¼«æ­¥èŠ±è¦‹å°è·¯å°‹æ‰¾è—å¦“èº«å½±ã€‚' },
                        { time: '13:25', title: 'éŒ¦å¸‚å ´åˆé¤', location: 'éŒ¦å¸‚å ´', type: 'food', mapQuery: 'Nishiki Market', description: 'ã€Œäº¬éƒ½çš„å»šæˆ¿ã€ï¼Œå“åšç‰å­ç‡’ã€è±†ä¹³ç”œç”œåœˆç­‰å°åƒã€‚' },
                        { time: '15:00', title: 'å››æ¡æ²³åŸç”º / å¹³å®‰ç¥å®®', location: 'å››æ¡æ²³åŸç”º', type: 'shopping', description: 'è‡ªç”±é€›è¡—è³¼ç‰©ï¼Œæˆ–å‰å¾€å¹³å®‰ç¥å®®åƒè§€ï¼ˆæœ¬æ®¿å…è²»ï¼‰ã€‚', mapQuery: 'Heian Shrine' },
                        { time: '18:30', title: 'å£½å–œç‡’æ™šé¤', location: 'å£½å–œç‡’ä¸‰æ¢æ²³åŸç”ºåº—', type: 'food', description: 'äº«å—é“åœ°çš„é—œè¥¿å£½å–œç‡’ã€‚' },
                    ]
                },
                {
                    id: 'day3', date: '10/18 (å…­)', title: 'ç¬¬ä¸‰å¤©ï¼šç§»å‹•è‡³å¤§é˜ª',
                    items: [
                        { time: '08:30', title: 'ä¼è¦‹ç¨»è·å¤§ç¤¾', location: 'ä¼è¦‹ç¨»è·å¤§ç¤¾', type: 'activity', cost: 'å…è²»', mapQuery: 'Fushimi Inari Taisha', description: 'å£¯è§€çš„åƒæœ¬é³¥å±…ï¼Œç‹ç‹¸ä½¿è€…çš„å®ˆè­·åœ°ã€‚' },
                        { time: '11:00', title: 'åˆé¤ & å–è¡Œæ', location: 'äº¬éƒ½', type: 'food' },
                        { time: '14:20', title: 'æ­ JR æ–°å¿«é€Ÿå¾€å¤§é˜ª', location: 'äº¬éƒ½ -> å¤§é˜ª', type: 'transport', cost: 'Â¥570' },
                        { time: '15:30', title: 'æ¢…ç”° HEP FIVE æ‘©å¤©è¼ª', location: 'HEP FIVE', type: 'activity', description: 'å¤§é˜ªåœ°æ¨™ç´…è‰²æ‘©å¤©è¼ªï¼ˆæ³¨æ„ï¼šè¡Œç¨‹è¡¨è¨»è¨˜ç¶­ä¿®ä¸­ï¼Œè«‹ç¢ºèªç¾å ´ç‹€æ³ï¼‰ã€‚', mapQuery: 'HEP FIVE Ferris Wheel', cost: 'Â¥600' },
                        { time: '17:00', title: 'é£¯åº— Check-in', location: 'The Bridge Hotel Shinsaibashi', type: 'hotel', mapQuery: 'The Bridge Hotel Shinsaibashi', description: 'ä½æ–¼å¿ƒé½‹æ©‹ä¸­å¿ƒï¼Œæ¯æ™šæä¾›å…è²»æ‹‰éºµå®µå¤œèˆ‡å•¤é…’æš¢é£²ã€‚' },
                        { time: '18:30', title: 'é“é “å € & å¿ƒé½‹æ©‹', location: 'é“é “å €', type: 'shopping', mapQuery: 'Dotonbori', description: 'è·‘è·‘äººçœ‹æ¿æ‰“å¡ï¼Œè—¥å¦åº—æ¡è³¼ï¼Œç« é­šç‡’ã€æ‹‰éºµåƒåˆ°é£½ã€‚' },
                    ]
                },
                {
                    id: 'day4', date: '10/19 (æ—¥)', title: 'ç¬¬å››å¤©ï¼šå¤§é˜ªæ·±åº¦éŠ',
                    items: [
                        { time: '08:30', title: 'å‰å¾€å¤§é˜ªåŸ', location: 'åœ°éµè‡³å¤§é˜ªå•†å‹™åœ’å€', type: 'transport' },
                        { time: '09:00', title: 'å¤§é˜ªåŸ & å¾¡åº§èˆ¹', location: 'å¤§é˜ªåŸå¤©å®ˆé–£', type: 'activity', description: 'å¤§é˜ªè±¡å¾µï¼Œè±è‡£ç§€å‰çš„å±…åŸã€‚', mapQuery: 'Osaka Castle', cost: 'Â¥600' },
                        { time: '12:00', title: 'å¤§é˜ªå¤©æ»¿å®®', location: 'å¤§é˜ªå¤©æ»¿å®®', type: 'activity', cost: 'å…è²»', mapQuery: 'Osaka Tenmangu', description: 'å­¸å•ä¹‹ç¥è…åŸé“çœŸï¼Œç¥ˆæ±‚å­¸æ¥­é€²æ­¥ã€‚' },
                        { time: '12:30', title: 'å¤©ç¥æ©‹ç­‹å•†åº—è¡—', location: 'å¤©ç¥æ©‹ç­‹', type: 'food', mapQuery: 'Tenjinbashi-suji Shopping Street', description: 'æ—¥æœ¬æœ€é•·çš„å•†åº—è¡—ï¼Œå……æ»¿åº¶æ°‘ç¾é£Ÿã€‚' },
                        { time: '13:30', title: 'å¤§é˜ªç”Ÿæ´»ä»Šæ˜”é¤¨', location: 'å¤§é˜ªç”Ÿæ´»ä»Šæ˜”é¤¨', type: 'activity', description: 'ç©¿è¶Šæ™‚ç©ºå›åˆ°æ±Ÿæˆ¶æ™‚ä»£çš„å¤§é˜ªè¡—é“ï¼Œå¯é«”é©—å’Œæœã€‚', mapQuery: 'Osaka Museum of Housing and Living' },
                        { time: '15:30', title: 'é»‘é–€å¸‚å ´', location: 'é»‘é–€å¸‚å ´', type: 'food', mapQuery: 'Kuromon Ichiba Market', description: 'ã€Œå¤§é˜ªçš„å»šæˆ¿ã€ï¼Œå¿…åƒæµ·é®®ã€å’Œç‰›ä¸²ã€æ°´æœå¤§ç¦ã€‚' },
                        { time: '20:00', title: 'ç‡’è‚‰æ™šé¤', location: 'ç‡’è‚‰åŠ›ä¸¸é›£æ³¢é“é “å €åº—', type: 'food', description: 'æ—¥å¼ç‡’è‚‰åƒåˆ°é£½ã€‚' }
                    ]
                },
                {
                    id: 'day5', date: '10/20 (ä¸€)', title: 'ç¬¬äº”å¤©ï¼šåƒæ‹œèˆ‡è¿”å°',
                    items: [
                        { time: '08:30', title: 'å‰å¾€å¤§é³¥å¤§ç¤¾', location: 'å¤©ç‹å¯º -> JR é³³ç«™', type: 'transport' },
                        { time: '09:20', title: 'å¤§é³¥å¤§ç¤¾åƒæ‹œ', location: 'å¤§é³¥å¤§ç¤¾', type: 'activity', cost: 'å…è²»', mapQuery: 'Otori Taisha', description: 'å’Œæ³‰åœ‹ä¸€ä¹‹å®®ï¼Œæ­·å²æ‚ ä¹…çš„ç¥ç¤¾ã€‚' },
                        { time: '10:00', title: 'å‰å¾€é—œè¥¿æ©Ÿå ´', location: 'é³³ç«™ -> KIX', type: 'transport', description: 'æ­ä¹˜ JR æˆ–å—æµ·é›»éµå‰å¾€æ©Ÿå ´ã€‚' },
                        { time: '11:00', title: 'æ©Ÿå ´å ±åˆ°', location: 'KIX ç¬¬ä¸€èˆªå»ˆ', type: 'flight', description: 'è¾¦ç†ç™»æ©Ÿã€è¨—é‹ã€æœ€å¾Œå…ç¨…å“æ¡è³¼ã€‚' },
                        { time: '14:00', title: 'æ­ä¹˜ç­æ©Ÿ CI0153', location: 'KIX -> TPE', type: 'flight', description: 'å¸¶è‘—æ»¿æ»¿çš„å›æ†¶é£›å¾€æº«æš–çš„å®¶ã€‚' },
                    ]
                }
            ],
            expenses: [] // { id, item, amount, payer, date }
        };

        const getAiService = (key) => key ? new GoogleGenAI({ apiKey: key }) : null;

        // --- Helper: Auto-generate description or sort ---
        const generateDescription = async (apiKey, title, location) => {
            if (!apiKey) return "è«‹å…ˆè¼¸å…¥ API Key";
            try {
                const ai = getAiService(apiKey);
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: `è«‹ç”¨ç¹é«”ä¸­æ–‡ç‚ºéŠå®¢ä»‹ç´¹ã€Œ${location} ${title}ã€ï¼Œ50å­—ä»¥å…§ã€‚ä¸¦è«‹åœ¨æœ€å¾Œä¸€è¡Œå–®ç¨å‘Šè¨´æˆ‘å¤§ç´„çš„é–€ç¥¨åƒ¹æ ¼æˆ–äººå‡æ¶ˆè²»(åªè¦æ•¸å­—è·Ÿå¹£å€¼)ï¼Œä¾‹å¦‚ï¼šé–€ç¥¨ Â¥500ã€‚`,
                });
                return response.text;
            } catch (e) { return "AI é€£ç·šå¤±æ•—"; }
        };

        const autoSortItinerary = async (apiKey, items) => {
             // Filter out empty items
             const validItems = items.filter(i => i.title && i.title.trim() !== '');
             if (validItems.length < 2) {
                 alert("æœ‰æ•ˆæ™¯é»éå°‘ï¼Œç„¡æ³•æ’åºã€‚è«‹å…ˆè¼¸å…¥æ™¯é»åç¨±ã€‚");
                 return items;
             }

             try {
                const ai = getAiService(apiKey);
                const prompt = `è«‹å°‡ä»¥ä¸‹æ—…éŠæ™¯é»é‡æ–°æ’åºï¼Œä»¥åœ°ç†ä½ç½®æœ€é †è·¯ç‚ºåŸå‰‡ã€‚ä¸¦è«‹é‡æ–°ä¼°ç®—åˆç†çš„æŠµé”æ™‚é–“(å¾09:00é–‹å§‹)ã€‚
                å›å‚³æ ¼å¼å¿…é ˆæ˜¯ç´” JSON Array (ä¸è¦Markdown)ï¼ŒåŒ…å« title èˆ‡ timeã€‚
                æ™¯é»åˆ—è¡¨: ${JSON.stringify(validItems.map(i => ({title: i.title, location: i.location})))}`;
                
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: { responseMimeType: "application/json" }
                });
                
                // Clean markdown if present
                let cleanText = response.text.replace(/```json|```/g, '').trim();
                const sorted = JSON.parse(cleanText);

                // Map back to items
                const newItems = sorted.map(s => {
                    const original = items.find(i => i.title === s.title);
                    return original ? { ...original, time: s.time } : null;
                }).filter(i => i !== null);

                // Append any items that weren't in the sorted list (e.g. empty ones or skipped)
                const remaining = items.filter(i => !newItems.includes(i));
                
                return [...newItems, ...remaining];
             } catch(e) {
                 console.error(e);
                 alert(`AI æ’åºå¤±æ•—: ${e.message}ã€‚è«‹æª¢æŸ¥ API Key æˆ–ç¨å¾Œå†è©¦ã€‚`);
                 return items;
             }
        };

        // --- Components ---

        const Modal = ({ children, onClose, title }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-wood-text/20 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                <div className="bg-wood-card border border-wood-border w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] animate-slide-up relative shadow-2xl rounded-sm" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center p-5 border-b border-wood-border bg-wood-bg/30">
                        <h3 className="text-wood-accent font-serif italic text-xl font-bold">{title}</h3>
                        <button onClick={onClose}><X className="text-wood-muted hover:text-wood-text" size={24}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar bg-wood-card">
                        {children}
                    </div>
                </div>
            </div>
        );

        const AttractionModal = ({ item, onClose }) => {
            const mapLink = item.mapQuery 
                ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapQuery)}` 
                : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location + ' ' + item.title)}`;
            
            return (
                <Modal onClose={onClose} title="æ™¯é»è©³æƒ…">
                    <div className="p-8">
                        <div className="mb-8 text-center border-b border-wood-border pb-6">
                            <span className="text-[10px] tracking-[0.3em] text-wood-accent uppercase font-bold block mb-2">DESTINATION</span>
                            <h3 className="text-3xl font-serif italic text-wood-text tracking-wide mb-3">{item.title}</h3>
                            <p className="text-wood-muted text-xs tracking-[0.2em] uppercase flex items-center justify-center font-medium">
                                <MapPin size={12} className="mr-2 text-wood-accent"/>{item.location}
                            </p>
                        </div>
                        <div className="space-y-8">
                            <div>
                                <h4 className="text-xs font-bold text-wood-text uppercase tracking-widest mb-3">é—œæ–¼é€™è£¡</h4>
                                <p className="text-wood-text text-sm leading-loose font-light tracking-wide text-justify">
                                    {item.description || 'æš«ç„¡èªªæ˜'}
                                </p>
                            </div>
                            {item.cost && (
                               <div className="text-center">
                                   <div className="inline-block text-xs text-wood-accent border border-wood-accent/30 px-6 py-2 tracking-widest uppercase">
                                       è²»ç”¨ï¼š{item.cost}
                                   </div>
                               </div>
                            )}
                            <a href={mapLink} target="_blank" className="block w-full text-center bg-wood-text text-white py-4 text-xs tracking-[0.25em] hover:bg-wood-accent uppercase font-medium transition-colors shadow-md">
                                <div className="flex items-center justify-center gap-2">
                                    <Map size={14}/> é–‹å•Ÿ Google åœ°åœ–
                                </div>
                            </a>
                        </div>
                    </div>
                </Modal>
            );
        };

        const ExpenseTab = ({ expenses, onUpdate }) => {
            const [newItem, setNewItem] = useState({ item: '', amount: '', payer: 'æˆ‘' });
            const [splitNum, setSplitNum] = useState(2);
            
            const addExpense = () => {
                if(!newItem.item || !newItem.amount) return;
                const dateStr = new Date().toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const newExp = { ...newItem, id: Date.now(), amount: parseFloat(newItem.amount), date: dateStr };
                onUpdate([...expenses, newExp]);
                setNewItem({ item: '', amount: '', payer: 'æˆ‘' });
            };

            const removeExpense = (id) => {
                onUpdate(expenses.filter(e => e.id !== id));
            };

            const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);

            return (
                <div className="space-y-6 animate-fade-in pb-12">
                    <div className="bg-white border border-wood-border p-6 rounded-sm shadow-sm">
                        <div className="flex items-center gap-2 text-wood-accent mb-4"><Calculator size={18}/><h3 className="font-serif italic text-lg text-wood-text">åˆ†å¸³è¨ˆç®—æ©Ÿ</h3></div>
                        <div className="flex items-center gap-4 mb-4">
                            <span className="text-sm text-wood-muted">ç¸½æ”¯å‡º: <strong className="text-wood-text text-lg">Â¥{total.toLocaleString()}</strong></span>
                        </div>
                        <div className="flex items-center gap-4 bg-wood-bg p-4 rounded-sm">
                            <label className="text-xs text-wood-muted shrink-0">å¹³åˆ†äººæ•¸: {splitNum} äºº</label>
                            <input type="range" min="1" max="10" value={splitNum} onChange={e=>setSplitNum(parseInt(e.target.value))} className="flex-1 accent-wood-accent"/>
                        </div>
                        <div className="mt-4 text-center">
                            <p className="text-xs text-wood-muted tracking-widest uppercase">æ¯äººæ‡‰ä»˜</p>
                            <p className="text-2xl font-serif text-wood-accent font-bold">Â¥{Math.ceil(total / splitNum).toLocaleString()}</p>
                        </div>
                    </div>

                    <div className="bg-white border border-wood-border p-6 rounded-sm shadow-sm">
                        <h3 className="text-sm font-bold text-wood-text mb-4">æ–°å¢è¨˜å¸³</h3>
                        <div className="flex flex-col gap-3">
                            <input value={newItem.item} onChange={e=>setNewItem({...newItem, item: e.target.value})} placeholder="é …ç›® (å¦‚: æ™šé¤)" className="w-full bg-wood-bg p-3 text-sm border border-wood-border rounded-sm"/>
                            <input type="number" value={newItem.amount} onChange={e=>setNewItem({...newItem, amount: e.target.value})} placeholder="é‡‘é¡" className="w-full bg-wood-bg p-3 text-sm border border-wood-border rounded-sm"/>
                            <input value={newItem.payer} onChange={e=>setNewItem({...newItem, payer: e.target.value})} placeholder="ä»˜æ¬¾äºº (é è¨­: æˆ‘)" className="w-full bg-wood-bg p-3 text-sm border border-wood-border rounded-sm"/>
                            <button onClick={addExpense} className="w-full bg-wood-accent text-white py-3 text-sm font-bold rounded-sm shadow-sm hover:opacity-90 transition-opacity">æ–°å¢æ”¯å‡º</button>
                        </div>
                    </div>

                    <div className="space-y-2">
                        {expenses.map(e => (
                            <div key={e.id} className="bg-white border border-wood-border p-3 flex justify-between items-center rounded-sm">
                                <div>
                                    <div className="font-bold text-wood-text text-sm">{e.item}</div>
                                    <div className="text-[10px] text-wood-muted">{e.date} â€¢ {e.payer} ä»˜æ¬¾</div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-mono text-wood-accent">Â¥{e.amount.toLocaleString()}</span>
                                    <button onClick={()=>removeExpense(e.id)} className="text-wood-muted hover:text-red-400"><Trash2 size={14}/></button>
                                </div>
                            </div>
                        ))}
                        {expenses.length === 0 && <p className="text-center text-xs text-wood-muted py-4">ç›®å‰æ²’æœ‰è¨˜å¸³è³‡æ–™</p>}
                    </div>
                </div>
            )
        };

        const InfoTab = ({ data, openModal }) => {
            const [amount, setAmount] = useState('');
            const [currency, setCurrency] = useState('JPY');
            const [rates, setRates] = useState({ JPY: 0.215, KRW: 0.024, CNY: 4.5 });
            const [isUpdating, setIsUpdating] = useState(false);
            const [updateMsg, setUpdateMsg] = useState('');
            
            const handleUpdateRates = async () => {
                setIsUpdating(true);
                setUpdateMsg('æ›´æ–°ä¸­...');
                try {
                    // Fetch base TWD rates via free API
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                    const data = await res.json();
                    if(data && data.rates) {
                        // The API returns TWD base (e.g., 1 TWD = 4.6 JPY)
                        // We need the inverse (e.g., 1 JPY = 0.215 TWD)
                        setRates({
                            JPY: 1 / data.rates.JPY,
                            KRW: 1 / data.rates.KRW,
                            CNY: 1 / data.rates.CNY
                        });
                        setUpdateMsg('åŒ¯ç‡æ›´æ–°æˆåŠŸï¼');
                    }
                } catch(e) {
                    setUpdateMsg('æ›´æ–°å¤±æ•—');
                }
                setIsUpdating(false);
                setTimeout(() => setUpdateMsg(''), 3000);
            };

            const twd = amount ? Math.round(parseFloat(amount) * rates[currency]) : 0;

            return (
                <div className="space-y-8 animate-fade-in pb-12">
                    <div className="text-center pt-6 pb-2">
                        <div className="inline-block border-y border-wood-accent/30 py-1 mb-3 px-6"><span className="text-[10px] tracking-[0.3em] text-wood-accent uppercase font-bold">è¡Œç¨‹ç¸½è¦½</span></div>
                        <h2 className="text-4xl font-serif italic text-wood-text tracking-tight">{data.tripName}</h2>
                        <p className="text-xs text-wood-muted tracking-[0.2em] mt-3 font-medium">{data.tripDate}</p>
                    </div>
                    
                    <div className="grid grid-cols-3 gap-2">
                        {['hotel', 'prep', 'translate'].map(type => (
                            <button key={type} onClick={() => type === 'translate' ? window.open('https://translate.google.com/?sl=auto&tl=zh-TW&op=translate', '_blank') : openModal(type)} className="bg-white border border-wood-border p-3 hover:border-wood-accent hover:shadow-md transition-all group relative overflow-hidden text-center rounded-sm flex flex-col items-center justify-center h-24">
                                {type === 'hotel' ? <Hotel size={20} className="text-wood-accent mb-2"/> : type === 'prep' ? <CheckCircle2 size={20} className="text-wood-accent mb-2"/> : <Languages size={20} className="text-wood-accent mb-2"/>}
                                <span className="block text-xs font-bold text-wood-text">{type === 'hotel' ? 'ä½å®¿' : type === 'prep' ? 'æº–å‚™' : 'ç¿»è­¯'}</span>
                            </button>
                        ))}
                    </div>

                    <div className="bg-white border border-wood-border p-6 shadow-sm rounded-sm relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-1 h-full bg-wood-accent"></div>
                        <div className="flex justify-between items-start mb-4">
                            <div className="flex items-center gap-2 text-wood-accent">
                                <Coins size={18}/>
                                <h3 className="font-serif italic text-lg text-wood-text">åŒ¯ç‡æ›ç®—</h3>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] text-wood-accent animate-fade-in">{updateMsg}</span>
                                <button onClick={handleUpdateRates} disabled={isUpdating} className={`p-1 text-wood-muted hover:text-wood-accent transition-colors ${isUpdating ? 'animate-spin' : ''}`}>
                                    <RefreshCw size={16}/>
                                </button>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex-1">
                                <div className="flex mb-2">
                                    <select value={currency} onChange={e=>setCurrency(e.target.value)} className="text-[10px] bg-transparent text-wood-muted tracking-widest outline-none font-bold uppercase">
                                        <option value="JPY">JPY æ—¥åœ“</option>
                                        <option value="KRW">KRWéŸ“å…ƒ</option>
                                        <option value="CNY">CNYäººæ°‘å¹£</option>
                                    </select>
                                </div>
                                <input type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="0" className="w-full bg-wood-bg border border-wood-border p-3 text-center text-xl text-wood-text focus:border-wood-accent outline-none font-light rounded-sm transition-colors"/>
                            </div>
                            <span className="text-wood-accent font-serif italic text-xl pt-6">to</span>
                            <div className="flex-1">
                                <label className="block text-[10px] text-wood-muted text-center mb-2 tracking-widest">TWD å°å¹£</label>
                                <div className="w-full bg-wood-bg/50 border-b border-wood-accent/30 p-3 text-center text-xl text-wood-text font-medium">${twd.toLocaleString()}</div>
                            </div>
                        </div>
                        <div className="text-[10px] text-center text-wood-muted mt-2 tracking-wider opacity-60">ç›®å‰åŒ¯ç‡: 1 {currency} â‰ˆ {rates[currency].toFixed(4)} TWD</div>
                    </div>

                    <div className="space-y-4">
                        <div className="flex items-center gap-2 px-1 text-wood-accent"><Plane size={18}/><h3 className="font-serif italic text-wood-text text-lg">èˆªç­è³‡è¨Š</h3></div>
                        {data.flights.map((f, i) => (
                            <div key={i} className="bg-white border border-wood-border p-6 flex justify-between items-center shadow-sm hover:shadow-md transition-shadow rounded-sm relative">
                                <div>
                                    <div className="text-xs text-wood-accent font-bold tracking-widest uppercase mb-1">{f.airline}</div>
                                    <div className="text-lg font-serif text-wood-text">{f.flightNo}</div>
                                    <div className="text-[10px] text-wood-muted mt-1 font-mono">{f.route}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-2xl font-serif text-wood-text">{f.dep}</div>
                                    <div className="text-[10px] text-wood-muted mt-1 uppercase tracking-widest">å‡ºç™¼</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DayView = ({ day, onSelect }) => {
            const getIcon = (t) => {
                if(t==='food') return <Utensils size={14}/>;
                if(t==='transport') return <Train size={14}/>;
                if(t==='hotel') return <Home size={14}/>;
                if(t==='shopping') return <ShoppingBag size={14}/>;
                return <MapPin size={14}/>;
            }
            return (
                <div className="pb-24 animate-fade-in">
                    <div className="sticky top-0 z-20 py-6 bg-wood-bg/95 backdrop-blur-md border-b border-wood-border mb-8 -mx-6 px-6 shadow-sm">
                        <span className="text-[10px] font-mono text-wood-accent block mb-2 tracking-[0.2em] uppercase font-bold">{day.date}</span>
                        <h2 className="text-2xl font-serif italic text-wood-text tracking-wide">{day.title}</h2>
                    </div>
                    <div className="relative pl-2 space-y-8">
                        <div className="absolute left-[19px] top-2 bottom-0 w-[1px] bg-wood-border"></div>
                        {day.items.map((item, idx) => (
                            <div key={idx} className="relative flex gap-5 group">
                                <div className="relative z-10 w-10 h-10 bg-white border border-wood-border flex items-center justify-center text-wood-muted group-hover:border-wood-accent group-hover:text-wood-accent group-hover:shadow-md transition-all rotate-45 shrink-0 rounded-sm">
                                    <div className="-rotate-45">{getIcon(item.type)}</div>
                                </div>
                                <div onClick={() => onSelect(item)} className="flex-1 bg-white border border-wood-border p-5 relative transition-all cursor-pointer hover:border-wood-accent hover:shadow-md rounded-sm group-hover:-translate-y-0.5">
                                    <div className="flex justify-between items-baseline mb-2">
                                        <span className="font-mono text-xs text-wood-accent font-bold tracking-widest">{item.time}</span>
                                        {item.cost && <span className="text-[10px] text-wood-muted border border-wood-border px-2 py-0.5 rounded-full">{item.cost}</span>}
                                    </div>
                                    <h3 className="font-medium text-lg text-wood-text mb-2 tracking-wide">{item.title}</h3>
                                    <div className="flex items-center text-wood-muted text-xs mb-3 font-light"><MapPin size={11} className="mr-1"/>{item.location}</div>
                                    {item.description && <p className="text-xs text-wood-text/70 font-light border-t border-wood-border pt-3 leading-relaxed line-clamp-2">{item.description}</p>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const EditForm = ({ data, onSave, onCancel }) => {
            const safeData = {
                ...DEFAULT_DATA,
                ...data,
                flights: data.flights || [],
                preparation: data.preparation || [],
                itinerary: (data.itinerary || []).map(day => ({
                    ...day,
                    items: day.items || []
                }))
            };

            const [formData, setFormData] = useState(safeData);
            const [generating, setGenerating] = useState(null); // 'dayId-itemId'

            // Theme toggle
            const toggleTheme = (themeName) => {
                setFormData({...formData, theme: themeName});
                document.body.setAttribute('data-theme', themeName);
            };

            // Itinerary logic
            const moveItem = (dayIdx, itemIdx, direction) => {
                const newItems = [...formData.itinerary[dayIdx].items];
                if (direction === -1 && itemIdx > 0) {
                    [newItems[itemIdx], newItems[itemIdx - 1]] = [newItems[itemIdx - 1], newItems[itemIdx]];
                } else if (direction === 1 && itemIdx < newItems.length - 1) {
                    [newItems[itemIdx], newItems[itemIdx + 1]] = [newItems[itemIdx + 1], newItems[itemIdx]];
                }
                const newItin = [...formData.itinerary];
                newItin[dayIdx].items = newItems;
                setFormData({ ...formData, itinerary: newItin });
            };

            const handleAiDesc = async (dIdx, iIdx, item) => {
                if(!item.title) return;
                setGenerating(`${dIdx}-${iIdx}`);
                const desc = await generateDescription(formData.apiKey, item.title, item.location);
                // Parse cost if possible (simple heuristic)
                let cost = item.cost;
                const costMatch = desc.match(/é–€ç¥¨.*?(\d+)|æ¶ˆè²».*?(\d+)/);
                if(costMatch) cost = `ç´„ Â¥${costMatch[1]||costMatch[2]}`;

                const newItin = [...formData.itinerary];
                newItin[dIdx].items[iIdx] = { ...item, description: desc, cost: cost || item.cost };
                setFormData({ ...formData, itinerary: newItin });
                setGenerating(null);
            };

            const handleAiSort = async (dIdx) => {
                if(!formData.apiKey) { alert("è«‹å…ˆè¨­å®š API Key æ‰èƒ½ä½¿ç”¨ AI æ’åº"); return; }
                if(formData.itinerary[dIdx].items.length < 2) { alert("è‡³å°‘éœ€è¦å…©å€‹æ™¯é»æ‰èƒ½é€²è¡Œæ’åº"); return; }

                setGenerating(`${dIdx}-sort`);
                const newItems = await autoSortItinerary(formData.apiKey, formData.itinerary[dIdx].items);
                const newItin = [...formData.itinerary];
                newItin[dIdx].items = newItems;
                setFormData({ ...formData, itinerary: newItin });
                setGenerating(null);
            };

            const handleReset = () => {
                if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„è¡Œç¨‹è¨­å®šã€‚")) {
                    setFormData(DEFAULT_DATA);
                }
            };
            
            const handleFlightChange = (idx, field, val) => { const newF = [...formData.flights]; newF[idx][field] = val; setFormData({...formData, flights: newF}); }
            const addFlight = () => setFormData({...formData, flights: [...formData.flights, { airline: '', flightNo: '', date: '', route: '', dep: '', arr: '' }]});
            const removeFlight = (idx) => setFormData({...formData, flights: formData.flights.filter((_, i) => i !== idx)});
            const handleItineraryChange = (dayIdx, field, val) => { const newI = [...formData.itinerary]; newI[dayIdx][field] = val; setFormData({...formData, itinerary: newI}); }
            const addItem = (dayIdx) => { const newI = [...formData.itinerary]; newI[dayIdx].items.push({ time: '09:00', title: '', location: '', type: 'activity', description: '', cost: '' }); setFormData({...formData, itinerary: newI}); }
            const updateItem = (dayIdx, itemIdx, field, val) => { const newI = [...formData.itinerary]; newI[dayIdx].items[itemIdx][field] = val; setFormData({...formData, itinerary: newI}); }
            const removeItem = (dayIdx, itemIdx) => { const newI = [...formData.itinerary]; newI[dayIdx].items = newI[dayIdx].items.filter((_, i) => i !== itemIdx); setFormData({...formData, itinerary: newI}); }
            const addDay = () => { const id = `day${Date.now()}`; setFormData({...formData, itinerary: [...formData.itinerary, { id, date: '', title: 'æ–°è¡Œç¨‹', items: [] }]}); }
            const removeDay = (idx) => { if(!confirm("ç¢ºå®šåˆªé™¤é€™ä¸€å¤©ï¼Ÿ")) return; setFormData({...formData, itinerary: formData.itinerary.filter((_, i) => i !== idx)}); }

            return (
                <div className="bg-wood-bg min-h-screen text-wood-text pb-24 font-sans absolute inset-0 z-50 overflow-y-auto">
                    <div className="sticky top-0 bg-wood-bg/95 backdrop-blur z-20 pb-4 border-b border-wood-border mb-6 flex justify-between items-center pt-4 px-4 shadow-sm">
                        <h2 className="text-lg font-serif italic text-wood-accent font-bold">ç·¨è¼¯æ¨¡å¼</h2>
                        <div className="flex gap-2">
                            <button onClick={onCancel} className="px-3 py-1.5 text-xs border border-wood-muted text-wood-muted rounded hover:bg-white">å–æ¶ˆ</button>
                            <button onClick={() => onSave(formData)} className="px-3 py-1.5 text-xs bg-wood-accent text-white font-bold rounded flex items-center gap-1 shadow-md"><Save size={14}/> å„²å­˜</button>
                        </div>
                    </div>

                    <div className="px-4 pb-12 space-y-6">
                        {/* API Config & Reset */}
                        <div className="bg-white p-4 rounded-sm border border-wood-border shadow-sm space-y-4">
                            <div>
                                <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest border-b border-wood-border pb-2 mb-3">API è¨­å®š</h3>
                                <input type="text" value={formData.apiKey || ''} onChange={e=>setFormData({...formData, apiKey: e.target.value})} placeholder="Google Gemini API Key" className="w-full bg-wood-bg border border-wood-border p-2 text-sm text-wood-text rounded-sm"/>
                            </div>
                            <div className="border-t border-wood-border pt-3 text-center">
                                <button onClick={handleReset} className="text-xs text-wood-muted hover:text-red-500 flex items-center justify-center gap-1 w-full py-2 border border-dashed border-wood-muted rounded-sm"><RotateCcw size={14}/> é‡ç½®å›é è¨­ç¯„æœ¬ (ä¿®å¾©è¡Œç¨‹éºå¤±)</button>
                            </div>
                        </div>

                         {/* Theme Selection */}
                         <div className="bg-white p-4 rounded-sm border border-wood-border shadow-sm">
                            <div className="flex items-center gap-2 mb-3 border-b border-wood-border pb-2">
                                <Palette size={16} className="text-wood-accent"/>
                                <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest">ä¸»é¡Œè‰²å½©</h3>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                {[
                                    {id:'default', name:'äº¬éƒ½å¤æœ¨', bg:'#F7F5F0'},
                                    {id:'sakura', name:'æ«»èŠ±ç²‰éŸ»', bg:'#FFF0F5'},
                                    {id:'matcha', name:'æŠ¹èŒ¶åº­åœ’', bg:'#F0FFF4'},
                                    {id:'ocean', name:'æ·±æµ·éœè¬', bg:'#F0F9FF'}
                                ].map(t => (
                                    <button key={t.id} onClick={()=>toggleTheme(t.id)} className={`text-xs p-2 rounded border transition-all ${formData.theme===t.id ? 'border-wood-accent ring-1 ring-wood-accent' : 'border-wood-border opacity-70'}`} style={{backgroundColor: t.bg}}>
                                        {t.name}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Basic Info */}
                        <div className="bg-white p-4 rounded-sm border border-wood-border shadow-sm">
                            <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest border-b border-wood-border pb-2 mb-3">åŸºæœ¬è³‡è¨Š</h3>
                            <div className="grid gap-3">
                                <div><label className="block text-xs text-wood-muted mb-1">æ¨™é¡Œ</label><input type="text" value={formData.tripName || ''} onChange={e=>setFormData({...formData, tripName: e.target.value})} className="w-full bg-wood-bg border border-wood-border p-2 text-sm rounded-sm"/></div>
                                <div><label className="block text-xs text-wood-muted mb-1">æ—¥æœŸ</label><input type="text" value={formData.tripDate || ''} onChange={e=>setFormData({...formData, tripDate: e.target.value})} className="w-full bg-wood-bg border border-wood-border p-2 text-sm rounded-sm"/></div>
                            </div>
                        </div>

                        {/* Itinerary */}
                        <div className="space-y-6">
                            <div className="flex justify-between items-center px-1">
                                <h3 className="text-wood-accent text-sm font-bold uppercase tracking-widest">æ¯æ—¥è¡Œç¨‹</h3>
                                <button onClick={addDay} className="text-wood-accent hover:text-wood-text flex items-center text-xs gap-1 font-bold bg-white px-3 py-1.5 border border-wood-accent rounded-full"><Plus size={14}/> æ–°å¢å¤©æ•¸</button>
                            </div>
                            {formData.itinerary.map((day, dIdx) => (
                                <div key={day.id} className="border border-wood-border bg-white p-3 rounded-sm shadow-sm relative">
                                    <div className="absolute top-0 left-0 w-1 h-full bg-wood-border"></div>
                                    <div className="flex justify-between items-start mb-4 pl-3 gap-2 border-b border-wood-border pb-3">
                                        <div className="flex-1 space-y-2 relative">
                                            <div className="flex items-center gap-2">
                                                <input value={day.date} onChange={e=>handleItineraryChange(dIdx,'date',e.target.value)} className="bg-wood-bg p-2 text-sm text-wood-accent font-bold border border-wood-border w-full rounded-sm" placeholder="æ—¥æœŸ (å¦‚ 10/16)"/>
                                                {/* Hidden Date Picker for ease of use */}
                                                <div className="relative shrink-0">
                                                    <CalendarIcon size={20} className="text-wood-muted pointer-events-none"/>
                                                    <input type="date" className="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10" onChange={(e)=>{
                                                        const d = new Date(e.target.value);
                                                        const dateStr = `${d.getMonth()+1}/${d.getDate()} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`;
                                                        handleItineraryChange(dIdx,'date',dateStr);
                                                    }}/>
                                                </div>
                                            </div>
                                            <input value={day.title} onChange={e=>handleItineraryChange(dIdx,'title',e.target.value)} className="bg-wood-bg p-2 text-base font-bold text-wood-text border border-wood-border w-full rounded-sm font-serif" placeholder="è¡Œç¨‹æ¨™é¡Œ"/>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <button onClick={()=>removeDay(dIdx)} className="text-wood-muted hover:text-red-500 bg-wood-bg p-2 rounded-full border border-wood-border z-20 relative"><Trash2 size={16}/></button>
                                            <button onClick={()=>handleAiSort(dIdx)} disabled={generating} className="text-wood-accent hover:bg-wood-accent hover:text-white bg-wood-bg p-2 rounded-full border border-wood-border transition-colors">
                                                {generating === `${dIdx}-sort` ? <Loader2 className="animate-spin" size={16}/> : <Wand2 size={16}/>}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4 pl-3">
                                        {day.items.map((item, iIdx) => (
                                            <div key={iIdx} className="bg-wood-bg p-3 border border-wood-border text-sm relative group rounded-sm mb-3">
                                                {/* Mobile Friendly: Vertical Stack for Controls & Inputs */}
                                                <div className="flex justify-between items-center mb-2 border-b border-wood-border/50 pb-2">
                                                    <div className="flex gap-2">
                                                        <button onClick={()=>moveItem(dIdx, iIdx, -1)} className="p-1.5 bg-white border border-wood-border rounded text-wood-muted hover:text-wood-accent"><ArrowUp size={14}/></button>
                                                        <button onClick={()=>moveItem(dIdx, iIdx, 1)} className="p-1.5 bg-white border border-wood-border rounded text-wood-muted hover:text-wood-accent"><ArrowDown size={14}/></button>
                                                    </div>
                                                    <button onClick={()=>removeItem(dIdx, iIdx)} className="text-wood-muted hover:text-red-500"><Trash2 size={16}/></button>
                                                </div>

                                                <div className="space-y-3">
                                                    {/* Row 1: Time & Type */}
                                                    <div className="grid grid-cols-3 gap-2">
                                                        <input type="time" value={item.time} onChange={e=>updateItem(dIdx, iIdx, 'time', e.target.value)} className="col-span-1 bg-white p-2 border border-wood-border rounded-sm text-center font-mono"/>
                                                        <select value={item.type} onChange={e=>updateItem(dIdx, iIdx, 'type', e.target.value)} className="col-span-2 bg-white p-2 border border-wood-border rounded-sm">
                                                            <option value="activity">æ™¯é»</option><option value="food">é¤å»³</option><option value="transport">äº¤é€š</option><option value="hotel">ä½å®¿</option><option value="shopping">è³¼ç‰©</option>
                                                        </select>
                                                    </div>

                                                    {/* Row 2: Title */}
                                                    <input value={item.title} onChange={e=>updateItem(dIdx, iIdx, 'title', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm font-bold" placeholder="æ¨™é¡Œ"/>
                                                    
                                                    {/* Row 3: Location (Full Width on Mobile) */}
                                                    <input value={item.location} onChange={e=>updateItem(dIdx, iIdx, 'location', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm" placeholder="åœ°é»"/>

                                                    {/* Row 4: Cost (Full Width on Mobile) */}
                                                    <input value={item.cost||''} onChange={e=>updateItem(dIdx, iIdx, 'cost', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm" placeholder="è²»ç”¨ (å¦‚: Â¥500)"/>

                                                    {/* Row 5: Desc */}
                                                    <div className="relative">
                                                        <textarea value={item.description} onChange={e=>updateItem(dIdx, iIdx, 'description', e.target.value)} className="w-full bg-white p-2 border border-wood-border h-20 rounded-sm" placeholder="æè¿°"/>
                                                        <button onClick={()=>handleAiDesc(dIdx, iIdx, item)} disabled={generating} className="absolute bottom-2 right-2 text-wood-accent bg-wood-bg p-1.5 rounded border border-wood-accent/30 hover:bg-wood-accent hover:text-white transition-colors text-xs flex items-center gap-1 shadow-sm">
                                                            {generating === `${dIdx}-${iIdx}` ? <Loader2 className="animate-spin" size={12}/> : <Sparkles size={12}/>} AI ä»‹ç´¹
                                                        </button>
                                                    </div>

                                                    {/* Row 6: Map Query */}
                                                    <input value={item.mapQuery||''} onChange={e=>updateItem(dIdx, iIdx, 'mapQuery', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm text-xs" placeholder="Google Maps æœå°‹é—œéµå­— (é¸å¡«)"/>
                                                </div>
                                            </div>
                                        ))}
                                        <button onClick={()=>addItem(dIdx)} className="w-full py-3 border border-dashed border-wood-muted text-wood-muted hover:text-wood-accent hover:border-wood-accent text-sm rounded-sm transition-colors">+ æ–°å¢è¡Œç¨‹</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState(DEFAULT_DATA);
            const [isEdit, setIsEdit] = useState(false);
            const [activeTab, setActiveTab] = useState('info');
            const [selectedItem, setSelectedItem] = useState(null);
            const [modalType, setModalType] = useState(null);
            const [connected, setConnected] = useState(false);

            // Sync with Firebase
            useEffect(() => {
                if(db) {
                    const dataRef = ref(db, 'tripData');
                    onValue(dataRef, (snapshot) => {
                        const val = snapshot.val();
                        if(val) {
                            setData({
                                ...DEFAULT_DATA,
                                ...val,
                                flights: val.flights || [],
                                itinerary: (val.itinerary || []).map(d => ({...d, items: d.items || []})),
                                expenses: val.expenses || []
                            });
                            // Sync theme
                            if(val.theme) document.body.setAttribute('data-theme', val.theme);
                        }
                        setConnected(true);
                    });
                }
            }, []);

            const saveData = (newData) => {
                if(db) {
                    set(ref(db, 'tripData'), newData);
                } else {
                    setData(newData);
                }
                setIsEdit(false);
            };

            if(isEdit) return <EditForm data={data} onSave={saveData} onCancel={()=>setIsEdit(false)} />;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-wood-bg shadow-2xl relative border-x border-wood-border font-sans flex flex-col transition-colors duration-500">
                    <header className="bg-wood-bg/95 backdrop-blur-md sticky top-0 z-30 pt-8 border-b border-wood-border transition-colors duration-500">
                        <div className="flex justify-between items-start px-6 mb-4">
                            <div>
                                <p className="text-[10px] text-wood-accent tracking-[0.25em] uppercase mb-1 font-bold">Premium Guide</p>
                                <h1 className="text-3xl font-serif italic text-wood-text tracking-wide">{data.tripName}</h1>
                                {connected && <span className="text-[10px] text-wood-accent flex items-center gap-1 mt-1">â˜ï¸ å·²åŒæ­¥</span>}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setIsEdit(true)} className="p-2 rounded-full border border-wood-border text-wood-muted hover:text-wood-accent hover:bg-white hover:shadow-sm transition-all"><Settings size={18}/></button>
                            </div>
                        </div>
                        <div className="flex overflow-x-auto no-scrollbar px-6 gap-8">
                            <button onClick={()=>setActiveTab('info')} className={`pb-3 text-xs tracking-widest whitespace-nowrap uppercase font-medium border-b-2 transition-all ${activeTab==='info'?'text-wood-accent border-wood-accent':'text-wood-muted border-transparent hover:text-wood-text'}`}>è³‡è¨Š</button>
                            <button onClick={()=>setActiveTab('expense')} className={`pb-3 text-xs tracking-widest whitespace-nowrap uppercase font-medium border-b-2 transition-all ${activeTab==='expense'?'text-wood-accent border-wood-accent':'text-wood-muted border-transparent hover:text-wood-text'}`}>è¨˜å¸³</button>
                            {data.itinerary.map(day => (
                                <button key={day.id} onClick={()=>setActiveTab(day.id)} className={`pb-3 text-xs tracking-widest whitespace-nowrap uppercase font-medium border-b-2 transition-all font-serif ${activeTab===day.id?'text-wood-accent border-wood-accent':'text-wood-muted border-transparent hover:text-wood-text'}`}>{day.date.split(' ')[0]}</button>
                            ))}
                        </div>
                    </header>

                    <main className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                        {activeTab === 'info' && <InfoTab data={data} openModal={setModalType} />}
                        {activeTab === 'expense' && <ExpenseTab expenses={data.expenses} onUpdate={(exps)=>saveData({...data, expenses: exps})} />}
                        {data.itinerary.map(day => activeTab === day.id && <DayView key={day.id} day={day} onSelect={setSelectedItem} />)}
                    </main>

                    {selectedItem && <AttractionModal item={selectedItem} onClose={()=>setSelectedItem(null)} />}
                    {modalType && (
                        <Modal onClose={()=>setModalType(null)} title={modalType==='hotel'?'ä½å®¿åˆ—è¡¨':'æº–å‚™æ¸…å–®'}>
                            <div className="p-8 space-y-6">
                                {modalType==='hotel' 
                                    ? data.itinerary.flatMap(d=>d.items).filter(i=>i.type==='hotel').map((h,i)=>(<div key={i} className="border-l-2 border-wood-accent pl-5 py-1"><h4 className="text-wood-text font-bold text-lg">{h.title}</h4><p className="text-xs text-wood-muted mb-3 font-medium tracking-wide uppercase mt-1 flex items-center gap-1"><MapPin size={10}/>{h.location}</p><p className="text-sm text-wood-text/70 font-light leading-relaxed">{h.description}</p></div>))
                                    : data.preparation.map((p,i)=>(<div key={i} className="flex gap-4 p-4 bg-white border border-wood-border rounded-sm shadow-sm"><div className="mt-1 w-2 h-2 bg-wood-accent shrink-0 rotate-45"></div><div><h4 className="text-wood-text text-sm font-bold mb-1">{p.title}</h4><p className="text-xs text-wood-muted font-light leading-relaxed">{p.desc}</p></div></div>))
                                }
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
