<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>‰∫¨ÈÉΩÁôΩËå∂ÔºéÁ≤æÁ∑ªÊóÖÈÅäÊâãÂÜä (Èõ≤Á´ØÂêåÊ≠•Áâà)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'wood-bg': 'var(--bg-color)',
              'wood-card': 'var(--card-color)',
              'wood-border': 'var(--border-color)',
              'wood-accent': 'var(--accent-color)',
              'wood-text': 'var(--text-color)',
              'wood-muted': 'var(--muted-color)',
            },
            fontFamily: {
              sans: ['Noto Sans TC', 'sans-serif'],
              serif: ['Playfair Display', 'serif'],
            },
            animation: {
              'fade-in': 'fadeIn 0.8s ease-out',
              'slide-up': 'slideUp 0.6s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(20px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              }
            }
          }
        }
      }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <style>
      /* Themes Variables */
      :root {
        --bg-color: #F7F5F0;
        --card-color: #FFFFFF;
        --border-color: #E6E2DE;
        --accent-color: #9C824A;
        --text-color: #332F2C;
        --muted-color: #85807C;
      }
      
      [data-theme="sakura"] {
        --bg-color: #FFF0F5;
        --card-color: #FFFFFF;
        --border-color: #FFD1DC;
        --accent-color: #DB7093;
        --text-color: #5C3A45;
        --muted-color: #A87CA0;
      }

      [data-theme="matcha"] {
        --bg-color: #F0FFF4;
        --card-color: #FFFFFF;
        --border-color: #C6F6D5;
        --accent-color: #38A169;
        --text-color: #22543D;
        --muted-color: #68D391;
      }

      [data-theme="ocean"] {
        --bg-color: #F0F9FF;
        --card-color: #FFFFFF;
        --border-color: #BAE6FD;
        --accent-color: #0284C7;
        --text-color: #0C4A6E;
        --muted-color: #7DD3FC;
      }

      body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-color); -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
      
      /* Scrollbar Styling */
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
      
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      /* Loading Animation */
      .loading-spinner {
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--accent-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      /* Mobile Optimization */
      input, select, textarea { font-size: 16px !important; } 
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "@google/genai": "https://esm.sh/@google/genai",
        "firebase/app": "https://esm.sh/firebase@10.8.0/app",
        "firebase/database": "https://esm.sh/firebase@10.8.0/database"
      }
    }
    </script>
</head>
<body>
    <div id="error-container" style="display:none; padding: 20px; color: white; background: #ef4444; margin: 20px; border-radius: 8px; font-size: 14px; line-height: 1.5;"></div>

    <div id="root">
        <div class="flex flex-col items-center justify-center min-h-screen text-wood-muted bg-wood-bg">
            <div class="loading-spinner mb-4"></div>
            <p class="font-serif italic tracking-widest text-sm">ËºâÂÖ•‰∏≠...</p>
        </div>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            const container = document.getElementById('error-container');
            if(container) {
                container.style.display = 'block';
                container.innerHTML = `<strong>ÊáâÁî®Á®ãÂºèÁôºÁîüÈåØË™§</strong><br/>Ë´ãÂòóË©¶ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢„ÄÇ<br/><br/><small>${msg}</small>`;
            }
            return false;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            CloudSun, Plane, Hotel, Coins, CheckCircle2, MapPin, X, 
            Utensils, Train, Camera, ShoppingBag, Home, Info, 
            MessageCircle, Send, Sparkles, Map, Loader2, Settings, Plus, Trash2, Save, RotateCcw,
            ArrowUp, ArrowDown, Calculator, Calendar as CalendarIcon, Languages, Palette, Wand2
        } from 'lucide-react';
        import { GoogleGenAI } from "@google/genai";
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, onValue, set } from "firebase/database";

        // ==========================================
        // ‚ö†Ô∏è Ë´ãÂ°´ÂØ´ÊÇ®ÁöÑ Gemini API Key
        // ==========================================
        const API_KEY = "AIzaSyCpomsc_YHhgkmqjgHI4z5Q9yfC_9QoFzw"; 
        
        // ==========================================
        // üî¥ Ë´ãÂú®Ê≠§ËôïË≤º‰∏äÊÇ®ÁöÑ Firebase Config üî¥
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDoaj7Ucvs44nRHHTDN4QJ3PrClGSlCxG0",
            authDomain: "trip-2bb34.firebaseapp.com",
            databaseURL: "https://trip-2bb34-default-rtdb.firebaseio.com",
            projectId: "trip-2bb34",
            storageBucket: "trip-2bb34.firebasestorage.app",
            messagingSenderId: "474424851920",
            appId: "1:474424851920:web:5a375acca86d3505ae0dd5",
            measurementId: "G-X937LTZ2E2"
        };

        // Firebase Init
        let db = null;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase initialized");
        } catch(e) {
            console.error("Firebase init failed:", e);
        }

        // È†êË®≠Ë≥áÊñô
        const DEFAULT_DATA = {
            theme: 'default',
            tripName: "‰∫¨ÈÉΩ„ÉªÂ§ßÈò™",
            tripDate: "2024.10.16 ‚Äî 10.20",
            apiKey: API_KEY, 
            flights: [
                { airline: '‰∏≠ËèØËà™Á©∫', flightNo: 'CI0152', date: '10/16 (Âõõ)', route: 'TPE -> KIX', dep: '09:00', arr: '12:50' },
                { airline: '‰∏≠ËèØËà™Á©∫', flightNo: 'CI0153', date: '10/20 (‰∏Ä)', route: 'KIX -> TPE', dep: '14:00', arr: '15:55' }
            ],
            preparation: [
                { title: "Ë≠∑ÁÖß", desc: "Ê™¢Êü•ÊúâÊïàÊúüÈôêÊòØÂê¶Ë∂ÖÈÅé 6 ÂÄãÊúà„ÄÇ" },
                { title: "Visit Japan Web", desc: "ÊèêÂâçÂ°´ÂØ´ÂÖ•Â¢ÉÂØ©Êü•ËàáÊµ∑ÈóúÁî≥Â†±ÔºåÊà™Âúñ QR Code„ÄÇ" },
                { title: "Êó•Âπ£ÁèæÈáë", desc: "Âª∫Ë≠∞ÊîúÂ∏∂Á¥Ñ ¬•50,000 - ¬•80,000 / ‰∫∫ (Ë¶ñË≥ºÁâ©ÈúÄÊ±Ç)„ÄÇ" },
                { title: "Á∂≤Âç° / Roaming", desc: "Á¢∫Ë™ç SIM Âç°ÊàñÊº´ÈÅäÂ∑≤ÈñãÈÄö„ÄÇ" },
                { title: "‰∫§ÈÄöÂç° (ICOCA/Suica)", desc: "Âä†ÂÖ• Apple Pay ÊàñÊ∫ñÂÇôÂØ¶È´îÂç°„ÄÇ" },
            ],
            itinerary: [
                {
                    id: 'day1', date: '10/16 (Âõõ)', title: 'Á¨¨‰∏ÄÂ§©Ôºö‰∫¨ÈÉΩÂàùÂç∞Ë±°',
                    items: [
                        { time: '14:00', title: 'Êê≠‰πò Haruka ÁâπÊÄ•', location: 'ÈóúË•øÊ©üÂ†¥ -> ‰∫¨ÈÉΩËªäÁ´ô', type: 'transport', description: '‰ΩøÁî® JR Pass ÊàñÈ†êË≥ºÁ•®Âà∏ÔºåÁ¥Ñ 75 ÂàÜÈêòËªäÁ®ã„ÄÇ', cost: '¬•2,200' },
                        { time: '15:30', title: 'È£ØÂ∫ó Check-in', location: "Hotel The M‚Äôs Kyoto", type: 'hotel', mapQuery: "Hotel The M‚Äôs Kyoto", description: 'ÊôÇÂ∞öË®≠Ë®àÈ¢®Ê†ºÈ£ØÂ∫óÔºå‰ΩçÊñº‰∫¨ÈÉΩËªäÁ´ôÈôÑËøëÔºå‰∫§ÈÄö‰æøÂà©„ÄÇ' },
                        { time: '16:10', title: 'ÂµêÂ±±Ê∏°ÊúàÊ©ã', location: 'ÂµêÂ±±', type: 'activity', mapQuery: 'Arashiyama Bamboo Grove', description: '‰∫¨ÈÉΩÂøÖË®™ÊôØÈªûÔºåÊÑüÂèóÁ´πÊûóÂπΩÈùúËàáÊ∏°ÊúàÊ©ãÁöÑÈñãÈóä„ÄÇ', cost: 'ÂÖçË≤ª' },
                    ]
                },
                {
                    id: 'day2', date: '10/17 (‰∫î)', title: 'Á¨¨‰∫åÂ§©ÔºöÂè§ÈÉΩÈ¢®ÊÉÖ',
                    items: [
                        { time: '09:30', title: 'Ê∏ÖÊ∞¥ÂØ∫', location: 'Ê∏ÖÊ∞¥ÂØ∫', type: 'activity', cost: 'ÈñÄÁ•® ¬•500', mapQuery: 'Kiyomizu-dera', description: '‰∏ñÁïåÈÅ∫Áî¢Ê∏ÖÊ∞¥ËàûÂè∞ÔºåÊ±ÇÂßªÁ∑£ÁöÑÂú∞‰∏ªÁ•ûÁ§æÔºåÊº´Ê≠•Âè§Ëâ≤Âè§È¶ôÁöÑÂùÇÈÅì„ÄÇ' },
                        { time: '13:25', title: 'Èå¶Â∏ÇÂ†¥ÂçàÈ§ê', location: 'Èå¶Â∏ÇÂ†¥', type: 'food', mapQuery: 'Nishiki Market', description: '„Äå‰∫¨ÈÉΩÁöÑÂªöÊàø„ÄçÔºåÂìÅÂöêÁéâÂ≠êÁáí„ÄÅË±Ü‰π≥ÁîúÁîúÂúàÁ≠âÂ∞èÂêÉ„ÄÇ' },
                    ]
                },
                {
                    id: 'day3', date: '10/18 (ÂÖ≠)', title: 'Á¨¨‰∏âÂ§©ÔºöÁßªÂãïËá≥Â§ßÈò™',
                    items: [
                        { time: '08:30', title: '‰ºèË¶ãÁ®ªËç∑Â§ßÁ§æ', location: '‰ºèË¶ãÁ®ªËç∑Â§ßÁ§æ', type: 'activity', cost: 'ÂÖçË≤ª', mapQuery: 'Fushimi Inari Taisha', description: 'Â£ØËßÄÁöÑÂçÉÊú¨È≥•Â±ÖÔºåÁãêÁã∏‰ΩøËÄÖÁöÑÂÆàË≠∑Âú∞„ÄÇ' },
                        { time: '14:20', title: 'ÁßªÂãïÂæÄÂ§ßÈò™', location: '‰∫¨ÈÉΩ -> Â§ßÈò™', type: 'transport', cost: '¬•570' },
                        { time: '15:30', title: 'Ê¢ÖÁî∞ HEP FIVE Êë©Â§©Ëº™', location: 'HEP FIVE', type: 'activity', description: 'Â§ßÈò™Âú∞Ê®ôÁ¥ÖËâ≤Êë©Â§©Ëº™„ÄÇ', cost: '¬•600' },
                        { time: '18:30', title: 'ÈÅìÈ†ìÂ†Ä & ÂøÉÈΩãÊ©ã', location: 'ÈÅìÈ†ìÂ†Ä', type: 'shopping', description: 'Ë∑ëË∑ë‰∫∫ÁúãÊùøÊâìÂç°ÔºåËó•Â¶ùÂ∫óÊé°Ë≥º„ÄÇ' },
                    ]
                },
                {
                    id: 'day4', date: '10/19 (Êó•)', title: 'Á¨¨ÂõõÂ§©ÔºöÂ§ßÈò™Ê∑±Â∫¶ÈÅä',
                    items: [
                        { time: '09:00', title: 'Â§ßÈò™Âüé', location: 'Â§ßÈò™ÂüéÂ§©ÂÆàÈñ£', type: 'activity', description: 'Â§ßÈò™Ë±°ÂæµÔºåË±êËá£ÁßÄÂêâÁöÑÂ±ÖÂüé„ÄÇ', cost: '¬•600' },
                        { time: '12:00', title: 'Â§ßÈò™Â§©ÊªøÂÆÆ', location: 'Â§ßÈò™Â§©ÊªøÂÆÆ', type: 'activity', cost: 'ÂÖçË≤ª', description: 'Â≠∏Âïè‰πãÁ•ûËèÖÂéüÈÅìÁúü„ÄÇ' },
                        { time: '15:30', title: 'ÈªëÈñÄÂ∏ÇÂ†¥', location: 'ÈªëÈñÄÂ∏ÇÂ†¥', type: 'food', description: '„ÄåÂ§ßÈò™ÁöÑÂªöÊàø„ÄçÔºåÂøÖÂêÉÊµ∑ÈÆÆ„ÄÇ' },
                    ]
                },
                {
                    id: 'day5', date: '10/20 (‰∏Ä)', title: 'Á¨¨‰∫îÂ§©ÔºöÂèÉÊãúËàáËøîÂè∞',
                    items: [
                        { time: '09:20', title: 'Â§ßÈ≥•Â§ßÁ§æÂèÉÊãú', location: 'Â§ßÈ≥•Â§ßÁ§æ', type: 'activity', cost: 'ÂÖçË≤ª', description: 'ÂíåÊ≥âÂúã‰∏Ä‰πãÂÆÆÔºåÊ≠∑Âè≤ÊÇ†‰πÖÁöÑÁ•ûÁ§æ„ÄÇ' },
                        { time: '11:00', title: 'Ê©üÂ†¥Â†±Âà∞', location: 'KIX Á¨¨‰∏ÄËà™Âªà', type: 'flight', description: 'Ëæ¶ÁêÜÁôªÊ©ü„ÄÅË®óÈÅã„ÄÇ' },
                    ]
                }
            ],
            expenses: [] // { id, item, amount, payer, date }
        };

        const getAiService = (key) => key ? new GoogleGenAI({ apiKey: key }) : null;

        // --- Helper: Auto-generate description or sort ---
        const generateDescription = async (apiKey, title, location) => {
            if (!apiKey) return "Ë´ãÂÖàËº∏ÂÖ• API Key";
            try {
                const ai = getAiService(apiKey);
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: `Ë´ãÁî®ÁπÅÈ´î‰∏≠ÊñáÁÇ∫ÈÅäÂÆ¢‰ªãÁ¥π„Äå${location} ${title}„ÄçÔºå50Â≠ó‰ª•ÂÖß„ÄÇ‰∏¶Ë´ãÂú®ÊúÄÂæå‰∏ÄË°åÂñÆÁç®ÂëäË®¥ÊàëÂ§ßÁ¥ÑÁöÑÈñÄÁ•®ÂÉπÊ†ºÊàñ‰∫∫ÂùáÊ∂àË≤ª(Âè™Ë¶ÅÊï∏Â≠óË∑üÂπ£ÂÄº)Ôºå‰æãÂ¶ÇÔºöÈñÄÁ•® ¬•500„ÄÇ`,
                });
                return response.text;
            } catch (e) { return "AI ÈÄ£Á∑öÂ§±Êïó"; }
        };

        const autoSortItinerary = async (apiKey, items) => {
             if (!apiKey) return items;
             try {
                const ai = getAiService(apiKey);
                // Simple heuristic sort via LLM
                const prompt = `Ë´ãÂ∞á‰ª•‰∏ã‰∫¨ÈÉΩÂ§ßÈò™ÊóÖÈÅäÊôØÈªûÈáçÊñ∞ÊéíÂ∫èÔºå‰ª•Âú∞ÁêÜ‰ΩçÁΩÆÊúÄÈ†ÜË∑ØÁÇ∫ÂéüÂâá„ÄÇ‰∏¶Ë´ãÈáçÊñ∞‰º∞ÁÆóÂêàÁêÜÁöÑÊäµÈÅîÊôÇÈñì(Âæû09:00ÈñãÂßã)„ÄÇ
                ÂõûÂÇ≥Ê†ºÂºèÂøÖÈ†àÊòØ JSON ArrayÔºåÂåÖÂê´ÂéüÊú¨ÁöÑ title ËàáÊñ∞ÁöÑ time„ÄÇ
                ÊôØÈªûÂàóË°®: ${JSON.stringify(items.map(i => ({title: i.title, location: i.location})))}`;
                
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: { responseMimeType: "application/json" }
                });
                const sorted = JSON.parse(response.text);
                // Map back to items
                const newItems = sorted.map(s => {
                    const original = items.find(i => i.title === s.title) || items[0];
                    return { ...original, time: s.time };
                });
                return newItems.length === items.length ? newItems : items;
             } catch(e) {
                 alert("AI ÊéíÂ∫èÂ§±ÊïóÔºåË´ãÊ™¢Êü• Key ÊàñÁ®çÂæåÂÜçË©¶");
                 return items;
             }
        };

        // --- Components ---

        const Modal = ({ children, onClose, title }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-wood-text/20 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                <div className="bg-wood-card border border-wood-border w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] animate-slide-up relative shadow-2xl rounded-sm" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center p-5 border-b border-wood-border bg-wood-bg/30">
                        <h3 className="text-wood-accent font-serif italic text-xl font-bold">{title}</h3>
                        <button onClick={onClose}><X className="text-wood-muted hover:text-wood-text" size={24}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar bg-wood-card">
                        {children}
                    </div>
                </div>
            </div>
        );

        const AttractionModal = ({ item, onClose }) => {
            const mapLink = item.mapQuery 
                ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapQuery)}` 
                : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location + ' ' + item.title)}`;
            
            return (
                <Modal onClose={onClose} title="ÊôØÈªûË©≥ÊÉÖ">
                    <div className="p-8">
                        <div className="mb-8 text-center border-b border-wood-border pb-6">
                            <span className="text-[10px] tracking-[0.3em] text-wood-accent uppercase font-bold block mb-2">DESTINATION</span>
                            <h3 className="text-3xl font-serif italic text-wood-text tracking-wide mb-3">{item.title}</h3>
                            <p className="text-wood-muted text-xs tracking-[0.2em] uppercase flex items-center justify-center font-medium">
                                <MapPin size={12} className="mr-2 text-wood-accent"/>{item.location}
                            </p>
                        </div>
                        <div className="space-y-8">
                            <div>
                                <h4 className="text-xs font-bold text-wood-text uppercase tracking-widest mb-3">ÈóúÊñºÈÄôË£°</h4>
                                <p className="text-wood-text text-sm leading-loose font-light tracking-wide text-justify">
                                    {item.description || 'Êö´ÁÑ°Ë™™Êòé'}
                                </p>
                            </div>
                            {item.cost && (
                               <div className="text-center">
                                   <div className="inline-block text-xs text-wood-accent border border-wood-accent/30 px-6 py-2 tracking-widest uppercase">
                                       Ë≤ªÁî®Ôºö{item.cost}
                                   </div>
                               </div>
                            )}
                            <a href={mapLink} target="_blank" className="block w-full text-center bg-wood-text text-white py-4 text-xs tracking-[0.25em] hover:bg-wood-accent uppercase font-medium transition-colors shadow-md">
                                <div className="flex items-center justify-center gap-2">
                                    <Map size={14}/> ÈñãÂïü Google Âú∞Âúñ
                                </div>
                            </a>
                        </div>
                    </div>
                </Modal>
            );
        };

        const ExpenseTab = ({ expenses, onUpdate }) => {
            const [newItem, setNewItem] = useState({ item: '', amount: '', payer: 'Êàë' });
            const [splitNum, setSplitNum] = useState(2);
            
            const addExpense = () => {
                if(!newItem.item || !newItem.amount) return;
                const dateStr = new Date().toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const newExp = { ...newItem, id: Date.now(), amount: parseFloat(newItem.amount), date: dateStr };
                onUpdate([...expenses, newExp]);
                setNewItem({ item: '', amount: '', payer: 'Êàë' });
            };

            const removeExpense = (id) => {
                onUpdate(expenses.filter(e => e.id !== id));
            };

            const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);

            return (
                <div className="space-y-6 animate-fade-in pb-12">
                    <div className="bg-white border border-wood-border p-6 rounded-sm shadow-sm">
                        <div className="flex items-center gap-2 text-wood-accent mb-4"><Calculator size={18}/><h3 className="font-serif italic text-lg text-wood-text">ÂàÜÂ∏≥Ë®àÁÆóÊ©ü</h3></div>
                        <div className="flex items-center gap-4 mb-4">
                            <span className="text-sm text-wood-muted">Á∏ΩÊîØÂá∫: <strong className="text-wood-text text-lg">¬•{total.toLocaleString()}</strong></span>
                        </div>
                        <div className="flex items-center gap-4 bg-wood-bg p-4 rounded-sm">
                            <label className="text-xs text-wood-muted shrink-0">Âπ≥ÂàÜ‰∫∫Êï∏: {splitNum} ‰∫∫</label>
                            <input type="range" min="1" max="10" value={splitNum} onChange={e=>setSplitNum(parseInt(e.target.value))} className="flex-1 accent-wood-accent"/>
                        </div>
                        <div className="mt-4 text-center">
                            <p className="text-xs text-wood-muted tracking-widest uppercase">ÊØè‰∫∫Êáâ‰ªò</p>
                            <p className="text-2xl font-serif text-wood-accent font-bold">¬•{Math.ceil(total / splitNum).toLocaleString()}</p>
                        </div>
                    </div>

                    <div className="bg-white border border-wood-border p-6 rounded-sm shadow-sm">
                        <h3 className="text-sm font-bold text-wood-text mb-4">Êñ∞Â¢ûË®òÂ∏≥</h3>
                        <div className="flex flex-col gap-3">
                            <input value={newItem.item} onChange={e=>setNewItem({...newItem, item: e.target.value})} placeholder="È†ÖÁõÆ (Â¶Ç: ÊôöÈ§ê)" className="w-full bg-wood-bg p-3 text-sm border border-wood-border rounded-sm"/>
                            <input type="number" value={newItem.amount} onChange={e=>setNewItem({...newItem, amount: e.target.value})} placeholder="ÈáëÈ°ç" className="w-full bg-wood-bg p-3 text-sm border border-wood-border rounded-sm"/>
                            <input value={newItem.payer} onChange={e=>setNewItem({...newItem, payer: e.target.value})} placeholder="‰ªòÊ¨æ‰∫∫ (È†êË®≠: Êàë)" className="w-full bg-wood-bg p-3 text-sm border border-wood-border rounded-sm"/>
                            <button onClick={addExpense} className="w-full bg-wood-accent text-white py-3 text-sm font-bold rounded-sm shadow-sm hover:opacity-90 transition-opacity">Êñ∞Â¢ûÊîØÂá∫</button>
                        </div>
                    </div>

                    <div className="space-y-2">
                        {expenses.map(e => (
                            <div key={e.id} className="bg-white border border-wood-border p-3 flex justify-between items-center rounded-sm">
                                <div>
                                    <div className="font-bold text-wood-text text-sm">{e.item}</div>
                                    <div className="text-[10px] text-wood-muted">{e.date} ‚Ä¢ {e.payer} ‰ªòÊ¨æ</div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-mono text-wood-accent">¬•{e.amount.toLocaleString()}</span>
                                    <button onClick={()=>removeExpense(e.id)} className="text-wood-muted hover:text-red-400"><Trash2 size={14}/></button>
                                </div>
                            </div>
                        ))}
                        {expenses.length === 0 && <p className="text-center text-xs text-wood-muted py-4">ÁõÆÂâçÊ≤íÊúâË®òÂ∏≥Ë≥áÊñô</p>}
                    </div>
                </div>
            )
        };

        const InfoTab = ({ data, openModal }) => {
            const [amount, setAmount] = useState('');
            const [currency, setCurrency] = useState('JPY');
            
            const rates = { JPY: 0.215, KRW: 0.024, CNY: 4.5 };
            const twd = amount ? Math.round(parseFloat(amount) * rates[currency]) : 0;

            return (
                <div className="space-y-8 animate-fade-in pb-12">
                    <div className="text-center pt-6 pb-2">
                        <div className="inline-block border-y border-wood-accent/30 py-1 mb-3 px-6"><span className="text-[10px] tracking-[0.3em] text-wood-accent uppercase font-bold">Ë°åÁ®ãÁ∏ΩË¶Ω</span></div>
                        <h2 className="text-4xl font-serif italic text-wood-text tracking-tight">{data.tripName}</h2>
                        <p className="text-xs text-wood-muted tracking-[0.2em] mt-3 font-medium">{data.tripDate}</p>
                    </div>
                    
                    <div className="grid grid-cols-3 gap-2">
                        {['hotel', 'prep', 'translate'].map(type => (
                            <button key={type} onClick={() => type === 'translate' ? window.open('https://translate.google.com/?sl=auto&tl=zh-TW&op=images', '_blank') : openModal(type)} className="bg-white border border-wood-border p-3 hover:border-wood-accent hover:shadow-md transition-all group relative overflow-hidden text-center rounded-sm flex flex-col items-center justify-center h-24">
                                {type === 'hotel' ? <Hotel size={20} className="text-wood-accent mb-2"/> : type === 'prep' ? <CheckCircle2 size={20} className="text-wood-accent mb-2"/> : <Languages size={20} className="text-wood-accent mb-2"/>}
                                <span className="block text-xs font-bold text-wood-text">{type === 'hotel' ? '‰ΩèÂÆø' : type === 'prep' ? 'Ê∫ñÂÇô' : 'ÁøªË≠Ø'}</span>
                            </button>
                        ))}
                    </div>

                    <div className="bg-white border border-wood-border p-6 shadow-sm rounded-sm relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-1 h-full bg-wood-accent"></div>
                        <div className="flex items-center gap-2 mb-4 text-wood-accent"><Coins size={18}/><h3 className="font-serif italic text-lg text-wood-text">ÂåØÁéáÊèõÁÆó</h3></div>
                        <div className="flex items-center gap-4">
                            <div className="flex-1">
                                <div className="flex mb-2">
                                    <select value={currency} onChange={e=>setCurrency(e.target.value)} className="text-[10px] bg-transparent text-wood-muted tracking-widest outline-none font-bold uppercase">
                                        <option value="JPY">JPY Êó•Âúì</option>
                                        <option value="KRW">KRWÈüìÂÖÉ</option>
                                        <option value="CNY">CNY‰∫∫Ê∞ëÂπ£</option>
                                    </select>
                                </div>
                                <input type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="0" className="w-full bg-wood-bg border border-wood-border p-3 text-center text-xl text-wood-text focus:border-wood-accent outline-none font-light rounded-sm transition-colors"/>
                            </div>
                            <span className="text-wood-accent font-serif italic text-xl pt-6">to</span>
                            <div className="flex-1">
                                <label className="block text-[10px] text-wood-muted text-center mb-2 tracking-widest">TWD Âè∞Âπ£</label>
                                <div className="w-full bg-wood-bg/50 border-b border-wood-accent/30 p-3 text-center text-xl text-wood-text font-medium">${twd.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <div className="flex items-center gap-2 px-1 text-wood-accent"><Plane size={18}/><h3 className="font-serif italic text-wood-text text-lg">Ëà™Áè≠Ë≥áË®ä</h3></div>
                        {data.flights.map((f, i) => (
                            <div key={i} className="bg-white border border-wood-border p-6 flex justify-between items-center shadow-sm hover:shadow-md transition-shadow rounded-sm relative">
                                <div>
                                    <div className="text-xs text-wood-accent font-bold tracking-widest uppercase mb-1">{f.airline}</div>
                                    <div className="text-lg font-serif text-wood-text">{f.flightNo}</div>
                                    <div className="text-[10px] text-wood-muted mt-1 font-mono">{f.route}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-2xl font-serif text-wood-text">{f.dep}</div>
                                    <div className="text-[10px] text-wood-muted mt-1 uppercase tracking-widest">Âá∫Áôº</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DayView = ({ day, onSelect }) => {
            const getIcon = (t) => {
                if(t==='food') return <Utensils size={14}/>;
                if(t==='transport') return <Train size={14}/>;
                if(t==='hotel') return <Home size={14}/>;
                if(t==='shopping') return <ShoppingBag size={14}/>;
                return <MapPin size={14}/>;
            }
            return (
                <div className="pb-24 animate-fade-in">
                    <div className="sticky top-0 z-20 py-6 bg-wood-bg/95 backdrop-blur-md border-b border-wood-border mb-8 -mx-6 px-6 shadow-sm">
                        <span className="text-[10px] font-mono text-wood-accent block mb-2 tracking-[0.2em] uppercase font-bold">{day.date}</span>
                        <h2 className="text-2xl font-serif italic text-wood-text tracking-wide">{day.title}</h2>
                    </div>
                    <div className="relative pl-2 space-y-8">
                        <div className="absolute left-[19px] top-2 bottom-0 w-[1px] bg-wood-border"></div>
                        {day.items.map((item, idx) => (
                            <div key={idx} className="relative flex gap-5 group">
                                <div className="relative z-10 w-10 h-10 bg-white border border-wood-border flex items-center justify-center text-wood-muted group-hover:border-wood-accent group-hover:text-wood-accent group-hover:shadow-md transition-all rotate-45 shrink-0 rounded-sm">
                                    <div className="-rotate-45">{getIcon(item.type)}</div>
                                </div>
                                <div onClick={() => onSelect(item)} className="flex-1 bg-white border border-wood-border p-5 relative transition-all cursor-pointer hover:border-wood-accent hover:shadow-md rounded-sm group-hover:-translate-y-0.5">
                                    <div className="flex justify-between items-baseline mb-2">
                                        <span className="font-mono text-xs text-wood-accent font-bold tracking-widest">{item.time}</span>
                                        {item.cost && <span className="text-[10px] text-wood-muted border border-wood-border px-2 py-0.5 rounded-full">{item.cost}</span>}
                                    </div>
                                    <h3 className="font-medium text-lg text-wood-text mb-2 tracking-wide">{item.title}</h3>
                                    <div className="flex items-center text-wood-muted text-xs mb-3 font-light"><MapPin size={11} className="mr-1"/>{item.location}</div>
                                    {item.description && <p className="text-xs text-wood-text/70 font-light border-t border-wood-border pt-3 leading-relaxed line-clamp-2">{item.description}</p>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const EditForm = ({ data, onSave, onCancel }) => {
            const safeData = {
                ...DEFAULT_DATA,
                ...data,
                flights: data.flights || [],
                preparation: data.preparation || [],
                itinerary: (data.itinerary || []).map(day => ({
                    ...day,
                    items: day.items || []
                }))
            };

            const [formData, setFormData] = useState(safeData);
            const [generating, setGenerating] = useState(null); // 'dayId-itemId'

            // Theme toggle
            const toggleTheme = (themeName) => {
                setFormData({...formData, theme: themeName});
                document.body.setAttribute('data-theme', themeName);
            };

            // Itinerary logic
            const moveItem = (dayIdx, itemIdx, direction) => {
                const newItems = [...formData.itinerary[dayIdx].items];
                if (direction === -1 && itemIdx > 0) {
                    [newItems[itemIdx], newItems[itemIdx - 1]] = [newItems[itemIdx - 1], newItems[itemIdx]];
                } else if (direction === 1 && itemIdx < newItems.length - 1) {
                    [newItems[itemIdx], newItems[itemIdx + 1]] = [newItems[itemIdx + 1], newItems[itemIdx]];
                }
                const newItin = [...formData.itinerary];
                newItin[dayIdx].items = newItems;
                setFormData({ ...formData, itinerary: newItin });
            };

            const handleAiDesc = async (dIdx, iIdx, item) => {
                if(!item.title) return;
                setGenerating(`${dIdx}-${iIdx}`);
                const desc = await generateDescription(formData.apiKey, item.title, item.location);
                // Parse cost if possible (simple heuristic)
                let cost = item.cost;
                const costMatch = desc.match(/ÈñÄÁ•®.*?(\d+)|Ê∂àË≤ª.*?(\d+)/);
                if(costMatch) cost = `Á¥Ñ ¬•${costMatch[1]||costMatch[2]}`;

                const newItin = [...formData.itinerary];
                newItin[dIdx].items[iIdx] = { ...item, description: desc, cost: cost || item.cost };
                setFormData({ ...formData, itinerary: newItin });
                setGenerating(null);
            };

            const handleAiSort = async (dIdx) => {
                setGenerating(`${dIdx}-sort`);
                const newItems = await autoSortItinerary(formData.apiKey, formData.itinerary[dIdx].items);
                const newItin = [...formData.itinerary];
                newItin[dIdx].items = newItems;
                setFormData({ ...formData, itinerary: newItin });
                setGenerating(null);
            };

            const handleReset = () => {
                if(confirm("Á¢∫ÂÆöÈáçÁΩÆÔºüÈÄôÂ∞áË¶ÜËìãÁõÆÂâçÁöÑË°åÁ®ãË®≠ÂÆö„ÄÇ")) {
                    setFormData(DEFAULT_DATA);
                }
            };
            
            const handleFlightChange = (idx, field, val) => { const newF = [...formData.flights]; newF[idx][field] = val; setFormData({...formData, flights: newF}); }
            const addFlight = () => setFormData({...formData, flights: [...formData.flights, { airline: '', flightNo: '', date: '', route: '', dep: '', arr: '' }]});
            const removeFlight = (idx) => setFormData({...formData, flights: formData.flights.filter((_, i) => i !== idx)});
            const handleItineraryChange = (dayIdx, field, val) => { const newI = [...formData.itinerary]; newI[dayIdx][field] = val; setFormData({...formData, itinerary: newI}); }
            const addItem = (dayIdx) => { const newI = [...formData.itinerary]; newI[dayIdx].items.push({ time: '09:00', title: '', location: '', type: 'activity', description: '', cost: '' }); setFormData({...formData, itinerary: newI}); }
            const updateItem = (dayIdx, itemIdx, field, val) => { const newI = [...formData.itinerary]; newI[dayIdx].items[itemIdx][field] = val; setFormData({...formData, itinerary: newI}); }
            const removeItem = (dayIdx, itemIdx) => { const newI = [...formData.itinerary]; newI[dayIdx].items = newI[dayIdx].items.filter((_, i) => i !== itemIdx); setFormData({...formData, itinerary: newI}); }
            const addDay = () => { const id = `day${Date.now()}`; setFormData({...formData, itinerary: [...formData.itinerary, { id, date: '', title: 'Êñ∞Ë°åÁ®ã', items: [] }]}); }
            const removeDay = (idx) => { if(!confirm("Á¢∫ÂÆöÂà™Èô§ÈÄô‰∏ÄÂ§©Ôºü")) return; setFormData({...formData, itinerary: formData.itinerary.filter((_, i) => i !== idx)}); }

            return (
                <div className="bg-wood-bg min-h-screen text-wood-text pb-24 font-sans absolute inset-0 z-50 overflow-y-auto">
                    <div className="sticky top-0 bg-wood-bg/95 backdrop-blur z-20 pb-4 border-b border-wood-border mb-6 flex justify-between items-center pt-4 px-4 shadow-sm">
                        <h2 className="text-lg font-serif italic text-wood-accent font-bold">Á∑®ËºØÊ®°Âºè</h2>
                        <div className="flex gap-2">
                            <button onClick={onCancel} className="px-3 py-1.5 text-xs border border-wood-muted text-wood-muted rounded hover:bg-white">ÂèñÊ∂à</button>
                            <button onClick={() => onSave(formData)} className="px-3 py-1.5 text-xs bg-wood-accent text-white font-bold rounded flex items-center gap-1 shadow-md"><Save size={14}/> ÂÑ≤Â≠ò</button>
                        </div>
                    </div>

                    <div className="px-4 pb-12 space-y-6">
                        {/* API Config & Reset */}
                        <div className="bg-white p-4 rounded-sm border border-wood-border shadow-sm space-y-4">
                            <div>
                                <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest border-b border-wood-border pb-2 mb-3">API Ë®≠ÂÆö</h3>
                                <input type="text" value={formData.apiKey || ''} onChange={e=>setFormData({...formData, apiKey: e.target.value})} placeholder="Google Gemini API Key" className="w-full bg-wood-bg border border-wood-border p-2 text-sm text-wood-text rounded-sm"/>
                            </div>
                            <div className="border-t border-wood-border pt-3 text-center">
                                <button onClick={handleReset} className="text-xs text-wood-muted hover:text-red-500 flex items-center justify-center gap-1 w-full py-2 border border-dashed border-wood-muted rounded-sm"><RotateCcw size={14}/> ÈáçÁΩÆÂõûÈ†êË®≠ÁØÑÊú¨ (‰øÆÂæ©Ë°åÁ®ãÈÅ∫Â§±)</button>
                            </div>
                        </div>

                         {/* Theme Selection */}
                         <div className="bg-white p-4 rounded-sm border border-wood-border shadow-sm">
                            <div className="flex items-center gap-2 mb-3 border-b border-wood-border pb-2">
                                <Palette size={16} className="text-wood-accent"/>
                                <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest">‰∏ªÈ°åËâ≤ÂΩ©</h3>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                {[
                                    {id:'default', name:'‰∫¨ÈÉΩÂè§Êú®', bg:'#F7F5F0'},
                                    {id:'sakura', name:'Ê´ªËä±Á≤âÈüª', bg:'#FFF0F5'},
                                    {id:'matcha', name:'ÊäπËå∂Â∫≠Âúí', bg:'#F0FFF4'},
                                    {id:'ocean', name:'Ê∑±Êµ∑ÈùúË¨ê', bg:'#F0F9FF'}
                                ].map(t => (
                                    <button key={t.id} onClick={()=>toggleTheme(t.id)} className={`text-xs p-2 rounded border transition-all ${formData.theme===t.id ? 'border-wood-accent ring-1 ring-wood-accent' : 'border-wood-border opacity-70'}`} style={{backgroundColor: t.bg}}>
                                        {t.name}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Basic Info */}
                        <div className="bg-white p-4 rounded-sm border border-wood-border shadow-sm">
                            <h3 className="text-wood-accent text-xs font-bold uppercase tracking-widest border-b border-wood-border pb-2 mb-3">Âü∫Êú¨Ë≥áË®ä</h3>
                            <div className="grid gap-3">
                                <div><label className="block text-xs text-wood-muted mb-1">Ê®ôÈ°å</label><input type="text" value={formData.tripName || ''} onChange={e=>setFormData({...formData, tripName: e.target.value})} className="w-full bg-wood-bg border border-wood-border p-2 text-sm rounded-sm"/></div>
                                <div><label className="block text-xs text-wood-muted mb-1">Êó•Êúü</label><input type="text" value={formData.tripDate || ''} onChange={e=>setFormData({...formData, tripDate: e.target.value})} className="w-full bg-wood-bg border border-wood-border p-2 text-sm rounded-sm"/></div>
                            </div>
                        </div>

                        {/* Itinerary */}
                        <div className="space-y-6">
                            <div className="flex justify-between items-center px-1">
                                <h3 className="text-wood-accent text-sm font-bold uppercase tracking-widest">ÊØèÊó•Ë°åÁ®ã</h3>
                                <button onClick={addDay} className="text-wood-accent hover:text-wood-text flex items-center text-xs gap-1 font-bold bg-white px-3 py-1.5 border border-wood-accent rounded-full"><Plus size={14}/> Êñ∞Â¢ûÂ§©Êï∏</button>
                            </div>
                            {formData.itinerary.map((day, dIdx) => (
                                <div key={day.id} className="border border-wood-border bg-white p-3 rounded-sm shadow-sm relative">
                                    <div className="absolute top-0 left-0 w-1 h-full bg-wood-border"></div>
                                    <div className="flex justify-between items-start mb-4 pl-3 gap-2 border-b border-wood-border pb-3">
                                        <div className="flex-1 space-y-2 relative">
                                            <div className="flex items-center gap-2">
                                                <input value={day.date} onChange={e=>handleItineraryChange(dIdx,'date',e.target.value)} className="bg-wood-bg p-2 text-sm text-wood-accent font-bold border border-wood-border w-full rounded-sm" placeholder="Êó•Êúü (Â¶Ç 10/16)"/>
                                                {/* Hidden Date Picker for ease of use */}
                                                <div className="relative shrink-0">
                                                    <CalendarIcon size={20} className="text-wood-muted pointer-events-none"/>
                                                    <input type="date" className="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10" onChange={(e)=>{
                                                        const d = new Date(e.target.value);
                                                        const dateStr = `${d.getMonth()+1}/${d.getDate()} (${['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][d.getDay()]})`;
                                                        handleItineraryChange(dIdx,'date',dateStr);
                                                    }}/>
                                                </div>
                                            </div>
                                            <input value={day.title} onChange={e=>handleItineraryChange(dIdx,'title',e.target.value)} className="bg-wood-bg p-2 text-base font-bold text-wood-text border border-wood-border w-full rounded-sm font-serif" placeholder="Ë°åÁ®ãÊ®ôÈ°å"/>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <button onClick={()=>removeDay(dIdx)} className="text-wood-muted hover:text-red-500 bg-wood-bg p-2 rounded-full border border-wood-border z-20 relative"><Trash2 size={16}/></button>
                                            <button onClick={()=>handleAiSort(dIdx)} disabled={generating} className="text-wood-accent hover:bg-wood-accent hover:text-white bg-wood-bg p-2 rounded-full border border-wood-border transition-colors"><Wand2 size={16}/></button>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4 pl-3">
                                        {day.items.map((item, iIdx) => (
                                            <div key={iIdx} className="bg-wood-bg p-3 border border-wood-border text-sm relative group rounded-sm mb-3">
                                                {/* Mobile Friendly: Vertical Stack for Controls & Inputs */}
                                                <div className="flex justify-between items-center mb-2 border-b border-wood-border/50 pb-2">
                                                    <div className="flex gap-2">
                                                        <button onClick={()=>moveItem(dIdx, iIdx, -1)} className="p-1.5 bg-white border border-wood-border rounded text-wood-muted hover:text-wood-accent"><ArrowUp size={14}/></button>
                                                        <button onClick={()=>moveItem(dIdx, iIdx, 1)} className="p-1.5 bg-white border border-wood-border rounded text-wood-muted hover:text-wood-accent"><ArrowDown size={14}/></button>
                                                    </div>
                                                    <button onClick={()=>removeItem(dIdx, iIdx)} className="text-wood-muted hover:text-red-500"><Trash2 size={16}/></button>
                                                </div>

                                                <div className="space-y-3">
                                                    {/* Row 1: Time & Type */}
                                                    <div className="grid grid-cols-3 gap-2">
                                                        <input type="time" value={item.time} onChange={e=>updateItem(dIdx, iIdx, 'time', e.target.value)} className="col-span-1 bg-white p-2 border border-wood-border rounded-sm text-center font-mono"/>
                                                        <select value={item.type} onChange={e=>updateItem(dIdx, iIdx, 'type', e.target.value)} className="col-span-2 bg-white p-2 border border-wood-border rounded-sm">
                                                            <option value="activity">ÊôØÈªû</option><option value="food">È§êÂª≥</option><option value="transport">‰∫§ÈÄö</option><option value="hotel">‰ΩèÂÆø</option><option value="shopping">Ë≥ºÁâ©</option>
                                                        </select>
                                                    </div>

                                                    {/* Row 2: Title */}
                                                    <input value={item.title} onChange={e=>updateItem(dIdx, iIdx, 'title', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm font-bold" placeholder="Ê®ôÈ°å"/>
                                                    
                                                    {/* Row 3: Location (Full Width on Mobile) */}
                                                    <input value={item.location} onChange={e=>updateItem(dIdx, iIdx, 'location', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm" placeholder="Âú∞Èªû"/>

                                                    {/* Row 4: Cost (Full Width on Mobile) */}
                                                    <input value={item.cost||''} onChange={e=>updateItem(dIdx, iIdx, 'cost', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm" placeholder="Ë≤ªÁî® (Â¶Ç: ¬•500)"/>

                                                    {/* Row 5: Desc */}
                                                    <div className="relative">
                                                        <textarea value={item.description} onChange={e=>updateItem(dIdx, iIdx, 'description', e.target.value)} className="w-full bg-white p-2 border border-wood-border h-20 rounded-sm" placeholder="ÊèèËø∞"/>
                                                        <button onClick={()=>handleAiDesc(dIdx, iIdx, item)} disabled={generating} className="absolute bottom-2 right-2 text-wood-accent bg-wood-bg p-1.5 rounded border border-wood-accent/30 hover:bg-wood-accent hover:text-white transition-colors text-xs flex items-center gap-1 shadow-sm">
                                                            {generating === `${dIdx}-${iIdx}` ? <Loader2 className="animate-spin" size={12}/> : <Sparkles size={12}/>} AI ‰ªãÁ¥π
                                                        </button>
                                                    </div>

                                                    {/* Row 6: Map Query */}
                                                    <input value={item.mapQuery||''} onChange={e=>updateItem(dIdx, iIdx, 'mapQuery', e.target.value)} className="w-full bg-white p-2 border border-wood-border rounded-sm text-xs" placeholder="Google Maps ÊêúÂ∞ãÈóúÈçµÂ≠ó (ÈÅ∏Â°´)"/>
                                                </div>
                                            </div>
                                        ))}
                                        <button onClick={()=>addItem(dIdx)} className="w-full py-3 border border-dashed border-wood-muted text-wood-muted hover:text-wood-accent hover:border-wood-accent text-sm rounded-sm transition-colors">+ Êñ∞Â¢ûË°åÁ®ã</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState(DEFAULT_DATA);
            const [isEdit, setIsEdit] = useState(false);
            const [activeTab, setActiveTab] = useState('info');
            const [selectedItem, setSelectedItem] = useState(null);
            const [modalType, setModalType] = useState(null);
            const [connected, setConnected] = useState(false);

            // Sync with Firebase
            useEffect(() => {
                if(db) {
                    const dataRef = ref(db, 'tripData');
                    onValue(dataRef, (snapshot) => {
                        const val = snapshot.val();
                        if(val) {
                            setData({
                                ...DEFAULT_DATA,
                                ...val,
                                flights: val.flights || [],
                                itinerary: (val.itinerary || []).map(d => ({...d, items: d.items || []})),
                                expenses: val.expenses || []
                            });
                            // Sync theme
                            if(val.theme) document.body.setAttribute('data-theme', val.theme);
                        }
                        setConnected(true);
                    });
                }
            }, []);

            const saveData = (newData) => {
                if(db) {
                    set(ref(db, 'tripData'), newData);
                } else {
                    setData(newData);
                }
                setIsEdit(false);
            };

            if(isEdit) return <EditForm data={data} onSave={saveData} onCancel={()=>setIsEdit(false)} />;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-wood-bg shadow-2xl relative border-x border-wood-border font-sans flex flex-col transition-colors duration-500">
                    <header className="bg-wood-bg/95 backdrop-blur-md sticky top-0 z-30 pt-8 border-b border-wood-border transition-colors duration-500">
                        <div className="flex justify-between items-start px-6 mb-4">
                            <div>
                                <p className="text-[10px] text-wood-accent tracking-[0.25em] uppercase mb-1 font-bold">Premium Guide</p>
                                <h1 className="text-3xl font-serif italic text-wood-text tracking-wide">{data.tripName}</h1>
                                {connected && <span className="text-[10px] text-wood-accent flex items-center gap-1 mt-1">‚òÅÔ∏è Â∑≤ÂêåÊ≠•</span>}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setIsEdit(true)} className="p-2 rounded-full border border-wood-border text-wood-muted hover:text-wood-accent hover:bg-white hover:shadow-sm transition-all"><Settings size={18}/></button>
                            </div>
                        </div>
                        <div className="flex overflow-x-auto no-scrollbar px-6 gap-8">
                            <button onClick={()=>setActiveTab('info')} className={`pb-3 text-xs tracking-widest whitespace-nowrap uppercase font-medium border-b-2 transition-all ${activeTab==='info'?'text-wood-accent border-wood-accent':'text-wood-muted border-transparent hover:text-wood-text'}`}>Ë≥áË®ä</button>
                            <button onClick={()=>setActiveTab('expense')} className={`pb-3 text-xs tracking-widest whitespace-nowrap uppercase font-medium border-b-2 transition-all ${activeTab==='expense'?'text-wood-accent border-wood-accent':'text-wood-muted border-transparent hover:text-wood-text'}`}>Ë®òÂ∏≥</button>
                            {data.itinerary.map(day => (
                                <button key={day.id} onClick={()=>setActiveTab(day.id)} className={`pb-3 text-xs tracking-widest whitespace-nowrap uppercase font-medium border-b-2 transition-all font-serif ${activeTab===day.id?'text-wood-accent border-wood-accent':'text-wood-muted border-transparent hover:text-wood-text'}`}>{day.date.split(' ')[0]}</button>
                            ))}
                        </div>
                    </header>

                    <main className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                        {activeTab === 'info' && <InfoTab data={data} openModal={setModalType} />}
                        {activeTab === 'expense' && <ExpenseTab expenses={data.expenses} onUpdate={(exps)=>saveData({...data, expenses: exps})} />}
                        {data.itinerary.map(day => activeTab === day.id && <DayView key={day.id} day={day} onSelect={setSelectedItem} />)}
                    </main>

                    {selectedItem && <AttractionModal item={selectedItem} onClose={()=>setSelectedItem(null)} />}
                    {modalType && (
                        <Modal onClose={()=>setModalType(null)} title={modalType==='hotel'?'‰ΩèÂÆøÂàóË°®':'Ê∫ñÂÇôÊ∏ÖÂñÆ'}>
                            <div className="p-8 space-y-6">
                                {modalType==='hotel' 
                                    ? data.itinerary.flatMap(d=>d.items).filter(i=>i.type==='hotel').map((h,i)=>(<div key={i} className="border-l-2 border-wood-accent pl-5 py-1"><h4 className="text-wood-text font-bold text-lg">{h.title}</h4><p className="text-xs text-wood-muted mb-3 font-medium tracking-wide uppercase mt-1 flex items-center gap-1"><MapPin size={10}/>{h.location}</p><p className="text-sm text-wood-text/70 font-light leading-relaxed">{h.description}</p></div>))
                                    : data.preparation.map((p,i)=>(<div key={i} className="flex gap-4 p-4 bg-white border border-wood-border rounded-sm shadow-sm"><div className="mt-1 w-2 h-2 bg-wood-accent shrink-0 rotate-45"></div><div><h4 className="text-wood-text text-sm font-bold mb-1">{p.title}</h4><p className="text-xs text-wood-muted font-light leading-relaxed">{p.desc}</p></div></div>))
                                }
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
